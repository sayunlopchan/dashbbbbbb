<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Locker Assignment</title>
</head>
<body>
    <h1>Test Locker Assignment</h1>
    
    <div>
        <h2>Test Member Search</h2>
        <input type="text" id="searchInput" placeholder="Search members...">
        <button onclick="searchMembers()">Search</button>
        <div id="searchResults"></div>
    </div>

    <div>
        <h2>Test Locker Assignment</h2>
        <input type="text" id="memberId" placeholder="Member ID">
        <input type="text" id="lockerNumber" placeholder="Locker Number">
        <input type="number" id="paymentAmount" placeholder="Payment Amount">
        <select id="paymentMethod">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="bank">Bank Transfer</option>
            <option value="online_payment">Online Payment</option>
        </select>
        <button onclick="assignLocker()">Assign Locker</button>
    </div>

    <div>
        <h2>Test Get Lockers</h2>
        <button onclick="getLockers()">Get Lockers</button>
        <div id="lockersResults"></div>
    </div>

    <script>
        async function searchMembers() {
            const query = document.getElementById('searchInput').value;
            try {
                const response = await fetch(`/api/members/search?q=${encodeURIComponent(query)}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                console.log('Search result:', result);
                
                if (result.success && result.data.length > 0) {
                    const member = result.data[0];
                    document.getElementById('memberId').value = member.memberId;
                    document.getElementById('searchResults').innerHTML = 
                        `<p>Found: ${member.fullName} (${member.memberId})</p>`;
                } else {
                    document.getElementById('searchResults').innerHTML = '<p>No members found</p>';
                }
            } catch (error) {
                console.error('Error searching members:', error);
                document.getElementById('searchResults').innerHTML = '<p>Error searching members</p>';
            }
        }

        async function assignLocker() {
            const memberId = document.getElementById('memberId').value;
            const lockerNumber = document.getElementById('lockerNumber').value;
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!memberId || !lockerNumber || !paymentAmount || !paymentMethod) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const response = await fetch(`/api/members/${memberId}/assign-locker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        lockerNumber: lockerNumber,
                        paymentAmount: paymentAmount,
                        paymentMethod: paymentMethod
                    })
                });

                const result = await response.json();
                console.log('Assign locker result:', result);
                
                if (response.ok) {
                    alert('Locker assigned successfully!');
                    getLockers(); // Refresh the lockers list
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                console.error('Error assigning locker:', error);
                alert('Error assigning locker: ' + error.message);
            }
        }

        async function getLockers() {
            try {
                const response = await fetch('/api/members/lockers', {
                    credentials: 'include'
                });
                const result = await response.json();
                console.log('Get lockers result:', result);
                
                if (result.success) {
                    const lockersHtml = result.data.map(member => 
                        `<p>${member.fullName} (${member.memberId}) - Locker: ${member.locker?.lockerNumber || 'N/A'}</p>`
                    ).join('');
                    document.getElementById('lockersResults').innerHTML = lockersHtml;
                } else {
                    document.getElementById('lockersResults').innerHTML = '<p>Error: ' + result.message + '</p>';
                }
            } catch (error) {
                console.error('Error getting lockers:', error);
                document.getElementById('lockersResults').innerHTML = '<p>Error getting lockers</p>';
            }
        }
    </script>
</body>
</html>