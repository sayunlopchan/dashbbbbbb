<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knox Barbell - Attendance</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/finance.css">
    <link rel="stylesheet" href="/css/barChart.css">
    <link rel="stylesheet" href="/css/pieChart.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Knox Barbell</h3>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                    <div class="tooltip">Dashboard</div>
                </a>
            </li>
            <li>
                <a href="/members">
                    <i class="fas fa-user"></i>
                    <span>Member</span>
                    <div class="tooltip">Member</div>
                </a>
            </li>
            <li>
                <a href="/application">
                    <i class="fa-solid fa-file-lines"></i>
                    <span>Application</span>
                    <div class="tooltip">Application</div>
                </a>
            </li>
            <li>
                <a href="/membership">
                    <i class="fas fa-id-card"></i>
                    <span>Membership</span>
                    <div class="tooltip">Membership</div>
                </a>
            </li>
            <li>
                <a href="/trainers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Trainers</span>
                    <div class="tooltip">Trainers</div>
                </a>
            </li>
            <li>
                <a href="/employee">
                    <i class="fas fa-users"></i>
                    <span>Employee</span>
                    <div class="tooltip">Employee</div>
                </a>
            </li>
            <li>
                <a href="/notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <div class="tooltip">Notifications</div>
                </a>
            </li>
            <li>
                <a href="/attendance">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                    <div class="tooltip">Attendance</div>
                </a>
            </li>
            <li>
                <a href="/events">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                    <div class="tooltip">Events</div>
                </a>
            </li>
            <li>
                <a href="/finance" class="active">
                    <i class="fas fa-wallet"></i>
                    <span>Finance</span>
                    <div class="tooltip">Finance</div>
                </a>
            </li>
            <li>
                <a href="/locker">
                    <i class="fas fa-box"></i>
                    <span>Locker</span>
                    <div class="tooltip">Locker</div>
                </a>
            </li>
            <li>
                <a href="/product">
                    <i class="fas fa-box"></i>
                    <span>Product</span>
                    <div class="tooltip">Product</div>
                </a>
            </li>
            <li class="logout-item">
                <a href="#" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                    <div class="tooltip">Logout</div>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Finance</h3>
            </div>
            <div class="topbar-right">
                <!-- notification  -->
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">0</span>
                    
                    <!-- Notification Modal -->
                    <div class="notification-modal">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <a href="/notifications" class="view-all-link">View All</a>
                                <button class="close-notifications">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be populated here -->
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-greeting">
                    <img src="/img/Knox Logo-01.png" alt="User">
                    <span>Hello, Knox Barbell</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="content-header">
                <h1>Finance Overview</h1>
                <div class="toggle-container" id="revenueToggle">
                    <div class="toggle-slider slide-daily" id="slider"></div>
                    <div class="toggle-label toggle-active" id="dailyLabel">Daily</div>
                    <div class="toggle-label" id="monthlyLabel">Monthly</div>
                </div>
            </div>

            <!-- Info boxes -->
            <div class="info-boxes">
                <div class="info-box">
                    <div class="info-box-header">
                        <span class="info-box-title">Total Revenue</span>
                        <div class="info-box-icon revenue">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <span class="info-box-number">NPR 0</span>
                        <p class="info-box-text">from successful payments</p>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-header">
                        <span class="info-box-title">Monthly Revenue</span>
                        <div class="info-box-icon revenue">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <div class="revenue-comparison">
                            <span class="info-box-number">NPR 0</span>
                            <span class="revenue-change">
                                <i class="fas fa-caret-up"></i>
                                <span class="change-percentage">0%</span>
                            </span>
                        </div>
                        <p class="info-box-text">vs last month</p>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-header">
                        <span class="info-box-title">Membership Revenue</span>
                        <div class="info-box-icon membership">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <div class="revenue-comparison">
                            <span class="info-box-number">NPR 0</span>
                            <span class="revenue-change">
                                <i class="fas fa-caret-up"></i>
                                <span class="change-percentage">0%</span>
                            </span>
                        </div>
                        <p class="info-box-text">vs last month</p>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-box-header">
                        <span class="info-box-title">Product Revenue</span>
                        <div class="info-box-icon product">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <div class="revenue-comparison">
                            <span class="info-box-number">NPR 0</span>
                            <span class="revenue-change">
                                <i class="fas fa-caret-up"></i>
                                <span class="change-percentage">0%</span>
                            </span>
                        </div>
                        <p class="info-box-text">vs last month</p>
                    </div>
                </div>
            </div>

            <!-- Char Section -->
            <div class="charts-section">
                <!-- Bar chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title" id="barChartYear">Revenue Finance - 2025</span>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <span class="legend-color membership-legend"></span>
                                <span class="legend-text">Membership Revenue</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color product-legend"></span>
                                <span class="legend-text">Product Revenue</span>
                            </div>
                        </div>
                    </div>
                    <div id="financeBarChart" class="bar-chart">
                        <!-- Bar chart will be dynamically generated here -->
                    </div>
                </div>
                <!-- Pie chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">Revenue</span>
                    </div>
                    <div id="revenuePieChart" class="pie-chart">
                        <!-- Pie chart will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Record Section -->
            <div class="payment-records">
                <h2>Payment Records</h2>
                <button class="add-record" id="recordPaymentBtn">
                    <span>+</span>
                    <p>Record Payment</p>
                </button>
            </div>

            <!-- Filter Section -->
            <div class="filters">
                <div class="filter-group search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search by member ID or name...">
                </div>
                <div class="filter-group download-filter">
                    <!-- filter day month -->
                    <select name="download-filter" id="filterDay">
                        <option value="today" selected>Today</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="90">Last 3 months</option>
                        <option value="180">Last 6 months</option>
                        <option value="365">Last 12 months</option>
                        <option value="all">All time</option>
                    </select>
                    <!-- payment method filter -->
                    <select name="download-filter" id="filterMethod">
                        <option value="" selected>All Payment Methods</option>
                        <option value="cash">Cash</option>
                        <option value="card">Card</option>
                        <option value="bank">Bank</option>
                        <option value="online_payment">Online Payment</option>
                    </select>
                    <!-- filter for Payment type -->
                    <select name="download-filter" id="filterType">
                        <option value="" selected>All Payment Types</option>
                        <option value="membership">Membership</option>
                        <option value="product">Product</option>
                    </select>
                    <!-- download CSv -->
                    <button class="download" id="download" title="Download as CSV">
                        <i class="fa-solid fa-download"></i>
                    </button>
                    <!-- Print -->
                    <button class="print" id="print" title="Print Records">
                        <i class="fa-solid fa-print"></i>
                    </button>
                    <!-- Reset -->
                    <button class="reset" id="resetFilters" title="Reset Filters">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>
            
            <!-- Finance Table -->
            <div class="table-container">
                <table class="members-table">
                    <thead>
                        <tr>
                            <th>S.N</th>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Method </th>
                            <th>Remark</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td><i class="fa-solid fa-money-bill"></i>loading...</td>
                            <td>loading...</td>
                            <td>
                                <button class="action-btn delete"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <button id="prevPage" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="pageInfo">Page 1</span>
                <button id="nextPage" class="pagination-btn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Record Payment Modal -->
    <div class="modal-overlay" id="recordModal">
        <div class="modal-content">
            <!-- header -->
            <div class="modal-header">
                <div>
                    <h2>Add New Record</h2>
                    <p>Fill in the details to mark a new payment record.</p>
                </div>
            </div>
            <!-- form -->
            <form id="recordForm" class="record-payment-container">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="memberSearch">Member</label>
                 
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="memberSearch" name="memberSearch" placeholder="Search by name or ID"
                            autocomplete="off" required>
                            <div class="search-result-container"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="date">Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="paymentType">Payment Type</label>
                        <select name="paymentType" id="paymentType" required>
                            <option disabled selected>Select a Type</option>
                            <option value="membership">Membership</option>
                            <option value="product">Product</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="method">Method</label>
                        <select name="method" id="method" required>
                            <option disabled selected>Select a method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="bank">Bank</option>
                            <option value="online_payment">Online Payment</option>
                        </select>
                    </div>
                    <!-- Product-specific fields -->
                    <div class="form-group full-width product-search-field" style="display: none;">
                        <label for="productSearch">Product</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="productSearch" name="productSearch" placeholder="Search by product name or ID" autocomplete="off">
                            <div class="product-search-result-container"></div>
                        </div>
                    </div>
                    <div class="form-group full-width product-quantity-field" style="display: none;">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" name="quantity" min="1" value="1">
                    </div>
                    <div class="form-group full-width">
                        <label for="remark">Remark</label>
                        <textarea id="remark" name="remark" placeholder="Enter any additional notes or remarks (optional)" rows="3" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Record</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Function to format currency in Nepalese Rupees
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'NPR',
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Global variable for toggle state
        let isDaily = true;

        // Function to update info boxes
        async function updateInfoBoxes() {
            try {
                console.log(`Updating info boxes for: ${isDaily ? 'Daily' : 'Monthly'} view`);
                
                // Fetch revenue data
                const response = await fetch(`${baseUrl}/api/payments/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    console.log('Revenue data received:', stats);
                    
                    // Update Total Revenue (always shows total)
                    const totalRevenueElement = document.querySelector('.info-box:nth-child(1) .info-box-number');
                    if (totalRevenueElement) {
                        totalRevenueElement.textContent = formatCurrency(stats.totalRevenue || 0);
                    }

                    if (isDaily) {
                        // Show daily revenue data
                        console.log(`Daily Revenue: ${stats.dailyRevenue}, Yesterday Revenue: ${stats.yesterdayRevenue}`);
                        
                        // Update Monthly Revenue box to show Daily Revenue
                        const monthlyRevenueElement = document.querySelector('.info-box:nth-child(2)');
                        if (monthlyRevenueElement) {
                            const titleElement = monthlyRevenueElement.querySelector('.info-box-title');
                            const numberElement = monthlyRevenueElement.querySelector('.info-box-number');
                            const textElement = monthlyRevenueElement.querySelector('.info-box-text');
                            titleElement.textContent = 'Daily Revenue';
                            numberElement.textContent = formatCurrency(stats.dailyRevenue || 0);
                            textElement.textContent = 'vs yesterday';
                            updateRevenueChange(monthlyRevenueElement, stats.dailyRevenue, stats.yesterdayRevenue);
                        }

                        // Update Membership Revenue with daily comparison
                        const membershipRevenueElement = document.querySelector('.info-box:nth-child(3)');
                        if (membershipRevenueElement) {
                            const titleElement = membershipRevenueElement.querySelector('.info-box-title');
                            const numberElement = membershipRevenueElement.querySelector('.info-box-number');
                            const textElement = membershipRevenueElement.querySelector('.info-box-text');
                            titleElement.textContent = 'Daily Membership Revenue';
                            numberElement.textContent = formatCurrency(stats.dailyMembershipRevenue || 0);
                            textElement.textContent = 'vs yesterday';
                            updateRevenueChange(membershipRevenueElement, stats.dailyMembershipRevenue, stats.yesterdayMembershipRevenue);
                        }

                        // Update Product Revenue with daily comparison
                        const productRevenueElement = document.querySelector('.info-box:nth-child(4)');
                        if (productRevenueElement) {
                            const titleElement = productRevenueElement.querySelector('.info-box-title');
                            const numberElement = productRevenueElement.querySelector('.info-box-number');
                            const textElement = productRevenueElement.querySelector('.info-box-text');
                            titleElement.textContent = 'Daily Product Revenue';
                            numberElement.textContent = formatCurrency(stats.dailyProductRevenue || 0);
                            textElement.textContent = 'vs yesterday';
                            updateRevenueChange(productRevenueElement, stats.dailyProductRevenue, stats.yesterdayProductRevenue);
                        }
                    } else {
                        // Show monthly revenue data
                        console.log(`Monthly Revenue: ${stats.monthlyRevenue}, Last Month Revenue: ${stats.lastMonthRevenue}`);
                        
                        // Update Monthly Revenue box to show Monthly Revenue
                        const monthlyRevenueElement = document.querySelector('.info-box:nth-child(2)');
                        if (monthlyRevenueElement) {
                            const titleElement = monthlyRevenueElement.querySelector('.info-box-title');
                            const numberElement = monthlyRevenueElement.querySelector('.info-box-number');
                            const textElement = monthlyRevenueElement.querySelector('.info-box-text');
                            titleElement.textContent = 'Monthly Revenue';
                            numberElement.textContent = formatCurrency(stats.monthlyRevenue || 0);
                            textElement.textContent = 'vs last month';
                            updateRevenueChange(monthlyRevenueElement, stats.monthlyRevenue, stats.lastMonthRevenue);
                        }

                        // Update Membership Revenue with monthly comparison
                        const membershipRevenueElement = document.querySelector('.info-box:nth-child(3)');
                        if (membershipRevenueElement) {
                            const titleElement = membershipRevenueElement.querySelector('.info-box-title');
                            const numberElement = membershipRevenueElement.querySelector('.info-box-number');
                            const textElement = membershipRevenueElement.querySelector('.info-box-text');
                            titleElement.textContent = 'Membership Revenue';
                            numberElement.textContent = formatCurrency(stats.monthlyMembershipRevenue || 0);
                            textElement.textContent = 'vs last month';
                            updateRevenueChange(membershipRevenueElement, stats.monthlyMembershipRevenue, stats.lastMonthMembershipRevenue);
                        }

                        // Update Product Revenue with monthly comparison
                        const productRevenueElement = document.querySelector('.info-box:nth-child(4)');
                        if (productRevenueElement) {
                            const titleElement = productRevenueElement.querySelector('.info-box-title');
                            const numberElement = productRevenueElement.querySelector('.info-box-number');
                            const textElement = productRevenueElement.querySelector('.info-box-text');
                            titleElement.textContent = 'Product Revenue';
                            numberElement.textContent = formatCurrency(stats.monthlyProductRevenue || 0);
                            textElement.textContent = 'vs last month';
                            updateRevenueChange(productRevenueElement, stats.monthlyProductRevenue, stats.lastMonthProductRevenue);
                        }
                    }
                    
                    // Update charts if they exist
                    if (typeof updateCharts === 'function') {
                        updateCharts(stats);
                    }
                } else {
                    throw new Error(data.message || 'Failed to fetch revenue data');
                }
            } catch (error) {
                console.error('Error fetching revenue data:', error);
                window.toast('Failed to load revenue data', 'error');
            }
        }

        // Function to calculate percentage change
        function calculatePercentageChange(current, previous) {
            if (!previous) return 0;
            return ((current - previous) / previous) * 100;
        }

        // Function to update revenue change indicator
        function updateRevenueChange(element, currentValue, previousValue) {
            const changeElement = element.querySelector('.revenue-change');
            const percentageElement = element.querySelector('.change-percentage');
            const iconElement = element.querySelector('.revenue-change i');
            
            const percentageChange = calculatePercentageChange(currentValue, previousValue);
            const isPositive = percentageChange >= 0;
            
            // Update classes
            changeElement.classList.toggle('negative', !isPositive);
            iconElement.className = isPositive ? 'fas fa-caret-up' : 'fas fa-caret-down';
            
            // Update percentage text
            percentageElement.textContent = `${isPositive ? '+' : ''}${percentageChange.toFixed(1)}%`;
        }

        // Function to handle all filtering
        async function applyFilters(page = 1) {
            try {
                currentPage = page;
                const searchQuery = document.querySelector('.search-box input').value;
                const dateFilter = document.getElementById('filterDay').value;
                const methodFilter = document.getElementById('filterMethod').value;
                const typeFilter = document.getElementById('filterType').value;

                // Build query parameters
                const params = new URLSearchParams({
                    page,
                    limit: itemsPerPage,
                    search: searchQuery,
                    sortBy: 'paymentDate',
                    sortOrder: 'desc'
                });

                // Add date filter
                if (dateFilter && dateFilter !== 'all') {
                    const now = new Date();
                    let startDate;
                    switch (dateFilter) {
                        case 'today':
                            startDate = new Date(now.setHours(0, 0, 0, 0));
                            break;
                        case '7':
                            startDate = new Date(now.setDate(now.getDate() - 7));
                            break;
                        case '30':
                            startDate = new Date(now.setDate(now.getDate() - 30));
                            break;
                        case '90':
                            startDate = new Date(now.setDate(now.getDate() - 90));
                            break;
                        case '180':
                            startDate = new Date(now.setDate(now.getDate() - 180));
                            break;
                        case '365':
                            startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                            break;
                    }
                    if (startDate) {
                        params.append('startDate', startDate.toISOString());
                        params.append('endDate', new Date().toISOString());
                    }
                }

                // Add method and type filters
                if (methodFilter) params.append('method', methodFilter);
                if (typeFilter) params.append('type', typeFilter);

                // Show loading state
                const tbody = document.querySelector('.members-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center;">
                            <div class="loading-spinner"></div>
                            Loading...
                        </td>
                    </tr>
                `;

                console.log('Fetching payments with params:', params.toString());
                const response = await fetch(`${baseUrl}/api/payments?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch payments');
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.success && data.data) {
                    // Extract payments and pagination from the correct structure
                    const payments = data.data.docs || [];
                    const pagination = data.data.pagination || {
                        page: currentPage,
                        totalPages: 1,
                        total: 0,
                        limit: itemsPerPage
                    };

                    // Store all payments for download/print functionality
                    allPayments = payments;
                    
                    tbody.innerHTML = ''; // Clear loading state

                    if (payments.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" style="text-align: center;">No payments found</td>
                            </tr>
                        `;
                        return;
                    }

                    // Populate table with filtered data
                    payments.forEach((payment, index) => {
                        if (!payment || typeof payment !== 'object') {
                            console.warn('Invalid payment data:', payment);
                            return;
                        }

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${(pagination.page - 1) * pagination.limit + index + 1}</td>
                            <td>${payment.memberId || 'N/A'}</td>
                            <td>${payment.fullName || 'N/A'}</td>
                            <td>${formatCurrency(payment.amount || 0)}</td>
                            <td>${formatDate(payment.paymentDate || new Date())}</td>
                            <td>${payment.paymentType ? payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1) : 'N/A'}</td>
                            <td>${getPaymentMethodIcon(payment.paymentMethod || 'cash')} ${payment.paymentMethod ? payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1) : 'N/A'}</td>
                            <td>${payment.remark || 'N/A'}</td>
                            <td>
                                <button class="action-btn delete" data-payment-id="${payment.paymentId || ''}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });

                    // Update pagination controls
                    updatePaginationControls(pagination);
                    totalPages = pagination.totalPages;

                    // Update revenue stats after filtering
                    await updateInfoBoxes();
                } else {
                    throw new Error(data.message || 'Failed to fetch payments');
                }
            } catch (error) {
                console.error('Error applying filters:', error);
                toast('Failed to apply filters', 'error');
                
                // Show error state in table
                const tbody = document.querySelector('.members-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; color: #dc3545;">
                            Error loading data. Please try again.
                        </td>
                    </tr>
                `;
            }
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            // Initial load
            applyFilters();
            updateInfoBoxes();

            // Search input event listener with debounce
            let searchTimeout;
            document.querySelector('.search-box input').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    applyFilters(1);
                }, 500);
            });

            // Date filter change
            document.getElementById('filterDay').addEventListener('change', () => {
                currentPage = 1;
                applyFilters(1);
            });

            // Method filter change
            document.getElementById('filterMethod').addEventListener('change', () => {
                currentPage = 1;
                applyFilters(1);
            });

            // Type filter change
            document.getElementById('filterType').addEventListener('change', () => {
                currentPage = 1;
                applyFilters(1);
            });

            // Reset filters button
            document.getElementById('resetFilters').addEventListener('click', () => {
                // Reset all filter values
                document.querySelector('.search-box input').value = '';
                document.getElementById('filterDay').value = 'today';
                document.getElementById('filterMethod').value = '';
                document.getElementById('filterType').value = '';
                
                // Reset pagination
                currentPage = 1;
                
                // Reset form data if any
                if (recordForm) {
                    recordForm.reset();
                    delete recordForm.dataset.selectedMemberId;
                    delete recordForm.dataset.paymentId;
                }
                
                // Refresh the data
                applyFilters(1);
                updateInfoBoxes();
                
                // Show success message
                toast('Filters have been reset', 'success');
            });

            // Pagination controls
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    applyFilters(currentPage - 1);
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                if (currentPage < totalPages) {
                    applyFilters(currentPage + 1);
                }
            });
        });

        // Function to show notification
        function toast(message, type = 'error') {
            const notification = document.createElement('div');
            notification.className = `notification-popup ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Expose toast function to window object
        window.toast = toast;

        // Function to delete payment
        async function deletePayment(paymentId) {
            try {
                const response = await fetch(`${baseUrl}/api/payments/${paymentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete payment');
                }

                const data = await response.json();

                if (data.success) {
                    toast('Payment deleted successfully', 'success');
                    // Refresh the payments table and revenue stats
                    applyFilters();
                    updateInfoBoxes();
                } else {
                    throw new Error(data.message || 'Failed to delete payment');
                }
            } catch (error) {
                console.error('Error deleting payment:', error);
                toast(error.message || 'Failed to delete payment', 'error');
            }
        }

        // Add event listener for delete buttons
        document.querySelector('.members-table').addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.action-btn.delete');
            if (!deleteBtn) return;

            const paymentId = deleteBtn.dataset.paymentId;
            if (!paymentId) return;

            // Show confirmation dialog using global confirmDialog
            const confirmed = await window.confirmDialog({
                title: 'Delete Payment',
                message: 'Are you sure you want to delete this payment record? This action cannot be undone.',
                type: 'delete'
            });

            if (confirmed) {
                await deletePayment(paymentId);
            }
        });

        // revenue logic 

        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Function to get payment method icon
        function getPaymentMethodIcon(method) {
            switch (method) {
                case 'cash':
                    return '<i class="fa-solid fa-money-bill"></i>';
                case 'card':
                    return '<i class="fa-solid fa-credit-card"></i>';
                case 'bank':
                    return '<i class="fa-solid fa-university"></i>';
                case 'online_payment':
                    return '<i class="fa-solid fa-globe"></i>';
                default:
                    return '<i class="fa-solid fa-money-bill"></i>';
            }
        }

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        const itemsPerPage = 10;
        let allPayments = [];

        // Function to update pagination controls
        function updatePaginationControls(pagination) {
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');

            // Update page info with proper number formatting
            pageInfo.textContent = `Page ${pagination.page} of ${pagination.totalPages} (Total: ${pagination.total} payments)`;

            // Update button states
            prevPageBtn.disabled = pagination.page <= 1;
            nextPageBtn.disabled = pagination.page >= pagination.totalPages;

            // Add visual feedback for disabled state
            prevPageBtn.classList.toggle('disabled', pagination.page <= 1);
            nextPageBtn.classList.toggle('disabled', pagination.page >= pagination.totalPages);
        }

        // Modal state management
        const recordModal = document.getElementById('recordModal');
        const recordForm = document.getElementById('recordForm');
        const recordPaymentBtn = document.getElementById('recordPaymentBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const memberSearch = document.getElementById('memberSearch');
        const searchResults = document.querySelector('.search-result-container');

        // Function to reset form
        function resetForm() {
            recordForm.reset();
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            memberSearch.value = '';
            document.getElementById('remark').value = '';
            delete recordForm.dataset.selectedMemberId;
            delete recordForm.dataset.paymentId;
            delete recordForm.dataset.selectedProductId;
            document.querySelector('#recordModal .modal-header h2').textContent = 'Add New Record';
            document.querySelector('#recordForm button[type="submit"]').textContent = 'Add Record';
            recordForm.dataset.mode = 'add';
            // Re-enable submit button
            const submitBtn = recordForm.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
        }

        // Function to toggle modal
        function toggleModal(show = true) {
            if (show) {
                recordModal.classList.add('active');
                document.body.style.overflow = 'hidden';
                resetForm();
            } else {
                recordModal.classList.remove('active');
                document.body.style.overflow = '';
                // Clear search results when closing
                searchResults.innerHTML = '';
            }
        }

        // Event Listeners for Modal
        recordPaymentBtn.addEventListener('click', () => toggleModal(true));
        cancelBtn.addEventListener('click', () => toggleModal(false));

        // Close modal when clicking outside
        recordModal.addEventListener('click', (e) => {
            if (e.target === recordModal) {
                toggleModal(false);
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && recordModal.classList.contains('active')) {
                toggleModal(false);
            }
        });

        // Add event listener for payment type change
        document.getElementById('paymentType').addEventListener('change', function(e) {
            const productSearchField = document.querySelector('.product-search-field');
            const productQuantityField = document.querySelector('.product-quantity-field');
            const quantityInput = document.getElementById('quantity');
            const productSearch = document.getElementById('productSearch');
            
            if (e.target.value === 'product') {
                productSearchField.style.display = 'block';
                productQuantityField.style.display = 'block';
                quantityInput.setAttribute('required', '');
                productSearch.setAttribute('required', '');
            } else {
                productSearchField.style.display = 'none';
                productQuantityField.style.display = 'none';
                quantityInput.removeAttribute('required');
                productSearch.removeAttribute('required');
                quantityInput.value = '1';
                productSearch.value = '';
                delete recordForm.dataset.selectedProductId;
            }
        });

        // Product search functionality
        let productSearchTimeout;
        document.getElementById('productSearch').addEventListener('input', async (e) => {
            clearTimeout(productSearchTimeout);
            const query = e.target.value.trim();
            const searchResults = document.querySelector('.product-search-result-container');
            
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }

            productSearchTimeout = setTimeout(async () => {
                try {
                    console.log('Searching for products with query:', query);
                    
                    // First, search for products using the search endpoint
                    const searchResponse = await fetch(`${baseUrl}/api/products/search?q=${encodeURIComponent(query)}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    console.log('Product search response status:', searchResponse.status);

                    if (!searchResponse.ok) {
                        const errorText = await searchResponse.text();
                        console.error('Product search response error:', errorText);
                        throw new Error(`Failed to search products: ${searchResponse.status} ${searchResponse.statusText}`);
                    }

                    const searchData = await searchResponse.json();
                    
                    console.log('Product search data:', searchData);
                    
                    if (searchData.success && searchData.data.length > 0) {
                        searchResults.innerHTML = searchData.data.map(product => `
                            <div class="search-result-item" data-product-id="${product.productId}">
                                <strong>${product.name}</strong>
                                <span>${product.productId}</span>
                                <span>Stock: ${product.stock}</span>
                                <span>Price: ${formatCurrency(product.price)}</span>
                            </div>
                        `).join('');

                        // Add click handlers to search results
                        document.querySelectorAll('.product-search-result-container .search-result-item').forEach(item => {
                            item.addEventListener('click', async () => {
                                const productId = item.dataset.productId;
                                
                                try {
                                    console.log('Fetching product details for ID:', productId);
                                    
                                    // Fetch detailed product information using the productId endpoint
                                    const detailResponse = await fetch(`${baseUrl}/api/products/${productId}`, {
                                        headers: {
                                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                                        }
                                    });

                                    console.log('Product detail response status:', detailResponse.status);

                                    if (!detailResponse.ok) {
                                        const errorText = await detailResponse.text();
                                        console.error('Product detail response error:', errorText);
                                        throw new Error(`Failed to fetch product details: ${detailResponse.status} ${detailResponse.statusText}`);
                                    }

                                    const detailData = await detailResponse.json();
                                    console.log('Product detail data:', detailData);
                                    
                                    if (detailData.success && detailData.data) {
                                        const product = detailData.data;
                                        document.getElementById('productSearch').value = `${product.name} (${product.productId})`;
                                        document.getElementById('amount').value = product.price;
                                        recordForm.dataset.selectedProductId = product.productId;
                                        searchResults.innerHTML = '';
                                        toast('Product selected successfully', 'success');
                                    } else {
                                        throw new Error(detailData.message || detailData.error || 'Failed to fetch product details');
                                    }
                                } catch (error) {
                                    console.error('Error fetching product details:', error);
                                    toast(`Failed to fetch product details: ${error.message}`, 'error');
                                }
                            });
                        });
                    } else {
                        searchResults.innerHTML = '<div class="no-results">No products found</div>';
                    }
                } catch (error) {
                    console.error('Error searching products:', error);
                    searchResults.innerHTML = '<div class="no-results">Error searching products</div>';
                    toast(`Error searching products: ${error.message}`, 'error');
                }
            }, 300);
        });

        // Update form submission to prevent double submission
        recordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get submit button and check if form is already submitting
            const submitBtn = recordForm.querySelector('button[type="submit"]');
            if (submitBtn.disabled) {
                return; // Prevent double submission
            }

            try {
                // Disable submit button immediately
                submitBtn.disabled = true;
                submitBtn.textContent = 'Processing...';

                const formData = {
                    amount: parseFloat(document.getElementById('amount').value),
                    paymentDate: document.getElementById('date').value,
                    paymentType: document.getElementById('paymentType').value,
                    paymentMethod: document.getElementById('method').value,
                    status: 'completed',
                    remark: document.getElementById('remark').value.trim() || null
                };

                // Add product-specific data if payment type is product
                if (formData.paymentType === 'product') {
                    const productId = recordForm.dataset.selectedProductId;
                    const quantity = parseInt(document.getElementById('quantity').value);

                    if (!productId) {
                        throw new Error('Please select a product');
                    }

                    formData.productId = productId;
                    formData.quantity = quantity;
                }

                const mode = recordForm.dataset.mode || 'add';
                const memberId = recordForm.dataset.selectedMemberId;

                if (!memberId) {
                    throw new Error('Please select a member first');
                }

                const url = mode === 'add'
                    ? `${baseUrl}/api/payments/member/${memberId}`
                    : `${baseUrl}/api/payments/${recordForm.dataset.paymentId}`;

                const method = mode === 'add' ? 'POST' : 'PUT';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    toast(`Payment ${mode === 'add' ? 'added' : 'updated'} successfully!`, 'success');
                    // Close modal and refresh data
                    toggleModal(false);
                    // Refresh the payments table and revenue stats
                    await Promise.all([
                        applyFilters(),
                        updateInfoBoxes()
                    ]);
                } else {
                    throw new Error(result.message || `Failed to ${mode} payment`);
                }
            } catch (error) {
                console.error('Error:', error);
                toast(error.message, 'error');
                // Re-enable submit button on error
                submitBtn.disabled = false;
                submitBtn.textContent = recordForm.dataset.mode === 'edit' ? 'Update Record' : 'Add Record';
            }
        });

        // Set current date when modal opens
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        });

        // Member search functionality with debounce
        let searchTimeout;
        memberSearch.addEventListener('input', async (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`${baseUrl}/api/members?search=${encodeURIComponent(query)}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) throw new Error('Failed to search members');

                    const data = await response.json();

                    if (data.success) {
                        const members = data.data;
                        searchResults.innerHTML = members.length ? members.map(member => `
                            <div class="search-result-item" data-member-id="${member.memberId}">
                                <div class="search-result-primary">
                                    <strong>${member.fullName}</strong>
                                    <span>${member.memberId}</span>
                                </div>
                                <div class="search-result-secondary">
                                    <small>${member.email || 'No email'}</small>
                                </div>
                            </div>
                        `).join('') : '<div class="no-results">No members found</div>';

                        // Add click handlers to search results
                        document.querySelectorAll('.search-result-item').forEach(item => {
                            item.addEventListener('click', () => {
                                const memberId = item.dataset.memberId;
                                const memberName = item.querySelector('strong').textContent;
                                memberSearch.value = memberName;
                                recordForm.dataset.selectedMemberId = memberId;
                                searchResults.innerHTML = '';
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error searching members:', error);
                    searchResults.innerHTML = '<div class="no-results">Error searching members</div>';
                }
            }, 300);
        });

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            if (!memberSearch.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.innerHTML = '';
            }
        });

        // Add edit functionality to payment table
        document.querySelector('.members-table').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.action-btn.edit');
            if (!editBtn) return;

            const paymentId = editBtn.dataset.paymentId;
            if (!paymentId) return;

            try {
                const response = await fetch(`${baseUrl}/api/payments/${paymentId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('Failed to fetch payment details');

                const data = await response.json();
                if (data.success) {
                    toggleModal(true);
                    populateFormForEdit(data.data);
                }
            } catch (error) {
                console.error('Error fetching payment details:', error);
                toast('Failed to load payment details', 'error');
            }
        });

        // Add download button event listener
        document.getElementById('download').addEventListener('click', () => {
            // Get the filtered payments
            const filteredPayments = allPayments.filter(payment => {
                const dateFilter = document.getElementById('filterDay').value;
                const methodFilter = document.getElementById('filterMethod').value;
                const typeFilter = document.getElementById('filterType').value;
                const searchQuery = document.querySelector('.search-box input').value.toLowerCase();

                // Apply date filter
                if (dateFilter && dateFilter !== 'all') {
                    const paymentDate = new Date(payment.paymentDate);
                    const now = new Date();
                    let startDate;
                    switch (dateFilter) {
                        case 'today':
                            startDate = new Date(now.setHours(0, 0, 0, 0));
                            break;
                        case '7':
                            startDate = new Date(now.setDate(now.getDate() - 7));
                            break;
                        case '30':
                            startDate = new Date(now.setDate(now.getDate() - 30));
                            break;
                        case '90':
                            startDate = new Date(now.setDate(now.getDate() - 90));
                            break;
                        case '180':
                            startDate = new Date(now.setDate(now.getDate() - 180));
                            break;
                        case '365':
                            startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                            break;
                    }
                    if (startDate && paymentDate < startDate) {
                        return false;
                    }
                }

                // Apply method filter
                if (methodFilter && payment.paymentMethod !== methodFilter) {
                    return false;
                }

                // Apply type filter
                if (typeFilter && payment.paymentType !== typeFilter) {
                    return false;
                }

                // Apply search filter
                if (searchQuery) {
                    const searchFields = [
                        payment.memberId,
                        payment.fullName,
                        payment.amount.toString(),
                        formatDate(payment.paymentDate)
                    ];
                    if (!searchFields.some(field => field.toLowerCase().includes(searchQuery))) {
                        return false;
                    }
                }

                return true;
            });

            if (filteredPayments.length === 0) {
                window.toast('No payment data to download', 'error');
                return;
            }

            // Create CSV content
            const headers = ['S.N', 'Member ID', 'Full Name', 'Amount', 'Date', 'Type', 'Method', 'Remark'];
            const csvContent = [
                headers.join(','),
                ...filteredPayments.map((payment, index) => [
                    index + 1,
                    payment.memberId,
                    payment.fullName,
                    formatCurrency(payment.amount),
                    formatDate(payment.paymentDate),
                    payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1),
                    payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1),
                    payment.remark || ''
                ].join(','))
            ].join('\n');

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `payments_list_${date}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            window.toast('Payment records downloaded successfully', 'success');
        });

        // Add print button event listener
        document.getElementById('print').addEventListener('click', () => {
            // Get the filtered payments
            const filteredPayments = allPayments.filter(payment => {
                const dateFilter = document.getElementById('filterDay').value;
                const methodFilter = document.getElementById('filterMethod').value;
                const typeFilter = document.getElementById('filterType').value;
                const searchQuery = document.querySelector('.search-box input').value.toLowerCase();

                // Apply date filter
                if (dateFilter && dateFilter !== 'all') {
                    const paymentDate = new Date(payment.paymentDate);
                    const now = new Date();
                    let startDate;
                    switch (dateFilter) {
                        case 'today':
                            startDate = new Date(now.setHours(0, 0, 0, 0));
                            break;
                        case '7':
                            startDate = new Date(now.setDate(now.getDate() - 7));
                            break;
                        case '30':
                            startDate = new Date(now.setDate(now.getDate() - 30));
                            break;
                        case '90':
                            startDate = new Date(now.setDate(now.getDate() - 90));
                            break;
                        case '180':
                            startDate = new Date(now.setDate(now.getDate() - 180));
                            break;
                        case '365':
                            startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                            break;
                    }
                    if (startDate && paymentDate < startDate) {
                        return false;
                    }
                }

                // Apply method filter
                if (methodFilter && payment.paymentMethod !== methodFilter) {
                    return false;
                }

                // Apply type filter
                if (typeFilter && payment.paymentType !== typeFilter) {
                    return false;
                }

                // Apply search filter
                if (searchQuery) {
                    const searchFields = [
                        payment.memberId,
                        payment.fullName,
                        payment.amount.toString(),
                        formatDate(payment.paymentDate)
                    ];
                    if (!searchFields.some(field => field.toLowerCase().includes(searchQuery))) {
                        return false;
                    }
                }

                return true;
            });

            if (filteredPayments.length === 0) {
                window.toast('No payment data to print', 'error');
                return;
            }

            // Create print window
            const printWindow = window.open('', '_blank');

            // Create print content
            const printContent = `
                <html>
                    <head>
                        <title>Payments Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; }
                            h1 { text-align: center; }
                            .header { margin-bottom: 20px; }
                            .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                            .summary { margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px; }
                            .summary-item { margin: 5px 0; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Payments Report</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                        </div>
                        <div class="summary">
                            <div class="summary-item"><strong>Total Records:</strong> ${filteredPayments.length}</div>
                            <div class="summary-item"><strong>Total Amount:</strong> ${formatCurrency(filteredPayments.reduce((sum, payment) => sum + payment.amount, 0))}</div>
                            <div class="summary-item"><strong>Date Range:</strong> ${document.getElementById('filterDay').value === 'all' ? 'All Time' : document.getElementById('filterDay').options[document.getElementById('filterDay').selectedIndex].text}</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>S.N</th>
                                    <th>Member ID</th>
                                    <th>Full Name</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Method</th>
                                    <th>Remark</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredPayments.map((payment, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${payment.memberId}</td>
                                        <td>${payment.fullName}</td>
                                        <td>${formatCurrency(payment.amount)}</td>
                                        <td>${formatDate(payment.paymentDate)}</td>
                                        <td>${payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1)}</td>
                                        <td>${payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)}</td>
                                        <td>${payment.remark || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="footer">
                            <p> ${new Date().getFullYear()} Knox Barbell - Payments Report</p>
                        </div>
                    </body>
                </html>
            `;

            // Write content to print window
            printWindow.document.write(printContent);
            printWindow.document.close();

            // Wait for content to load then print
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };

            window.toast('Printing payment records...', 'success');
        });

        // Function to fetch revenue statistics (wrapper for updateInfoBoxes)
        async function fetchRevenueStats() {
            try {
                await updateInfoBoxes();
            } catch (error) {
                console.error('Error fetching revenue statistics:', error);
                toast('Failed to load revenue statistics', 'error');
            }
        }

        // Toggle button functionality
        document.addEventListener('DOMContentLoaded', () => {
            const toggle = document.getElementById("revenueToggle");
            const slider = document.getElementById("slider");
            const dailyLabel = document.getElementById("dailyLabel");
            const monthlyLabel = document.getElementById("monthlyLabel");

            toggle.addEventListener("click", () => {
                isDaily = !isDaily;
                if (isDaily) {
                    slider.classList.remove("slide-monthly");
                    slider.classList.add("slide-daily");
                    dailyLabel.classList.add("toggle-active");
                    monthlyLabel.classList.remove("toggle-active");
                } else {
                    slider.classList.remove("slide-daily");
                    slider.classList.add("slide-monthly");
                    dailyLabel.classList.remove("toggle-active");
                    monthlyLabel.classList.add("toggle-active");
                }

                // Update the info boxes with the new data
                updateInfoBoxes();
            });
        });

        // Notification Modal Logic
        document.addEventListener('DOMContentLoaded', function() {
            const notificationIcon = document.querySelector('.notification');
            const notificationModal = document.querySelector('.notification-modal');
            const closeNotifications = document.querySelector('.close-notifications');
            const notificationList = document.querySelector('.notification-list');
            const notificationBadge = document.querySelector('.notification-badge');

            // Toggle notification modal
            notificationIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationModal.classList.toggle('active');
                if (notificationModal.classList.contains('active')) {
                    fetchNotifications();
                }
            });

            // Close notification modal
            closeNotifications.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationModal.classList.remove('active');
            });

            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                if (!notificationModal.contains(e.target) && !notificationIcon.contains(e.target)) {
                    notificationModal.classList.remove('active');
                }
            });

            // Fetch unread count
            async function fetchUnreadCount() {
                try {
                    const response = await fetch(`${baseUrl}/api/notifications/unread-count`);
                    const data = await response.json();
                    if (data.success) {
                        notificationBadge.textContent = data.data.unreadCount;
                        // Show/hide badge based on count
                        notificationBadge.style.display = data.data.unreadCount > 0 ? 'flex' : 'none';
                    }
                } catch (error) {
                    console.error('Error fetching unread count:', error);
                }
            }

            // Fetch notifications from API
            async function fetchNotifications() {
                try {
                    notificationList.innerHTML = `
                        <div class="notification-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                        </div>
                    `;

                    const response = await fetch(`${baseUrl}/api/notifications`);
                    const data = await response.json();

                    if (data.success) {
                        const notifications = data.data;
                        
                        if (notifications.length === 0) {
                            notificationList.innerHTML = `
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>No new notifications</p>
                                </div>
                            `;
                            return;
                        }

                        // Render notifications
                        notificationList.innerHTML = notifications.map(notif => `
                            <div class="notification-item ${notif.status === 'unread' ? 'unread' : ''}" 
                                 data-notification-id="${notif._id}">
                                <div class="notification-title">
                                    ${notif.title}
                                    ${notif.status === 'unread' ? '<span class="unread-dot"></span>' : ''}
                                </div>
                                <div class="notification-message">${notif.message}</div>
                                <div class="notification-time">${new Date(notif.createdAt).toLocaleString()}</div>
                            </div>
                        `).join('');

                        // Add click handler to mark notifications as read
                        const notificationItems = document.querySelectorAll('.notification-item');
                        notificationItems.forEach(item => {
                            item.addEventListener('click', async () => {
                                const notificationId = item.dataset.notificationId;
                                if (item.classList.contains('unread')) {
                                    try {
                                        const response = await fetch(`${baseUrl}/api/notifications/${notificationId}/read`, {
                                            method: 'PATCH',
                                            credentials: 'include'
                                        });
                                        
                                        if (response.ok) {
                                            // Update UI
                                            item.classList.remove('unread');
                                            const unreadDot = item.querySelector('.unread-dot');
                                            if (unreadDot) unreadDot.remove();
                                            
                                            // Update unread count
                                            await fetchUnreadCount();
                                        }
                                    } catch (error) {
                                        console.error('Error marking notification as read:', error);
                                    }
                                }

                                // Close notification modal
                                notificationModal.classList.remove('active');

                                // Redirect to application page
                                window.location.href = '/application';
                            });
                        });
                    } else {
                        throw new Error(data.message || 'Failed to fetch notifications');
                    }
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Failed to load notifications</p>
                        </div>
                    `;
                }
            }

            // Initial fetch of notifications and unread count
            fetchNotifications();
            fetchUnreadCount();

            // Refresh unread count periodically
            setInterval(fetchUnreadCount, 30000); // Every 30 seconds
        });
    </script>

    <script src="./js/financeChart.js"></script>
    <script src="/js/main.js"></script>
    <script src="./js/logout.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Function to format currency
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'NPR',
                    maximumFractionDigits: 0
                }).format(amount);
            }

            // Initial update
            await updateInfoBoxes();

            // Update every 5 minutes
            setInterval(updateInfoBoxes, 300000);
        });
    </script>

</body>

</html>