<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trainer Details | Knox Barbell</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/member-detail.css">
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Knox Barbell</h3>
      <button class="toggle-btn" id="toggleSidebar">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span><div class="tooltip">Dashboard</div></a></li>
      <li><a href="/members"><i class="fas fa-user"></i><span>Member</span><div class="tooltip">Member</div></a></li>
      <li><a href="/application"><i class="fa-solid fa-file-lines"></i><span>Application</span><div class="tooltip">Application</div></a></li>
      <li><a href="/membership"><i class="fas fa-id-card"></i><span>Membership</span><div class="tooltip">Membership</div></a></li>
      <li><a href="/trainers" class="active"><i class="fas fa-chalkboard-teacher"></i><span>Trainers</span><div class="tooltip">Trainers</div></a></li>
      <li><a href="/employee"><i class="fas fa-users"></i><span>Employee</span><div class="tooltip">Employee</div></a></li>
      <li><a href="/notifications"><i class="fas fa-bell"></i><span>Notifications</span><div class="tooltip">Notifications</div></a></li>
      <li><a href="/attendance"><i class="fas fa-calendar-check"></i><span>Attendance</span><div class="tooltip">Attendance</div></a></li>
      <li><a href="/events"><i class="fas fa-calendar-alt"></i><span>Events</span><div class="tooltip">Events</div></a></li>
      <li><a href="/finance"><i class="fas fa-wallet"></i><span>Finance</span><div class="tooltip">Finance</div></a></li>
      <li><a href="/locker"><i class="fas fa-box"></i><span>Locker</span><div class="tooltip">Locker</div></a></li>
      <li><a href="/product"><i class="fas fa-box"></i><span>Product</span><div class="tooltip">Product</div></a></li>
      <li class="logout-item"><a href="#" id="logoutButton"><i class="fas fa-sign-out-alt"></i><span>Logout</span><div class="tooltip">Logout</div></a></li>
    </ul>
  </div>
  <!-- Main Content -->
  <div class="main-content">
    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="mobile-toggle" id="mobileToggle"><i class="fas fa-bars"></i></button>
        <h3>Trainer Details</h3>
      </div>
      <div class="topbar-right">
        <div class="notification">
          <i class="fas fa-bell"></i>
          <span class="notification-badge">0</span>
          <div class="notification-modal">
            <div class="notification-header">
              <h3>Notifications</h3>
              <div class="notification-actions">
                <a href="/notifications" class="view-all-link">View All</a>
                <button class="close-notifications"><i class="fas fa-times"></i></button>
              </div>
            </div>
            <div class="notification-list">
              <div class="notification-loading"><i class="fas fa-spinner fa-spin"></i> Loading notifications...</div>
            </div>
          </div>
        </div>
        <div class="user-greeting">
          <img src="/img/Knox Logo-01.png" alt="User">
          <span>Hello, Knox Barbell</span>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- trainer detail header -->
      <header class="member-detail-header">
        <h1 class="member-detail-title">Trainer Details</h1>
        <div class="member-detail-actions">
          <a href="/trainers" class="member-detail-btn member-detail-btn--back">
            <i class="fas fa-arrow-left"></i> Back to Trainers
          </a>
        </div>
      </header>

      <!-- filter -->
      <div class="filter-group">
        <button id="downloadTrainerDetail" title="Download CSV">
          <i class="fa-solid fa-download"></i>
        </button>
        <button id="printTrainerDetail" title="Print">
          <i class="fa-solid fa-print"></i>
        </button>
      </div>

      <!-- trainer detail -->
      <div class="member-detail-page">
        <div id="trainerDetailRoot">
          <!-- Loading State -->
          <div class="member-loading-state" id="loadingSpinner">
            <i class="fas fa-spinner member-loading-spinner"></i>
            <p>Loading trainer details...</p>
          </div>

          <!-- Error State -->
          <div class="member-error-state" id="errorContainer" style="display:none;"></div>

          <!-- Trainer Content -->
          <div id="trainerDetailContainer" style="display:none;"></div>
        </div>
      </div>
    </div>

    <script>
      // Utility: get query param
      function getQueryParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      const trainerId = getQueryParam('trainerId');
      const loadingSpinner = document.getElementById('loadingSpinner');
      const trainerDetailContainer = document.getElementById('trainerDetailContainer');
      const errorContainer = document.getElementById('errorContainer');

      async function fetchTrainerDetails() {
        if (!trainerId) {
          showError('No trainer ID provided in URL.');
          return;
        }

        try {
          // Fetch trainer data
          const [trainerRes, attRes, payRes] = await Promise.all([
            fetch(`/api/trainers/${trainerId}`),
            fetch(`/api/attendances/trainer/${trainerId}`),
            fetch(`/api/trainers/${trainerId}/payment-history`)
          ]);

          const [trainerData, attData, payData] = await Promise.all([
            trainerRes.json(),
            attRes.json(),
            payRes.json()
          ]);

          if (!trainerData.success) throw new Error(trainerData.message || 'Trainer not found');

          const trainer = trainerData.data;
          const attendance = attData.success ? attData.data : [];
          const payments = payData.success ? payData.data : [];

          renderTrainerDetails(trainer, attendance, payments);
        } catch (err) {
          showError(err.message || 'Failed to load trainer details.');
        }
      }

      function showError(msg) {
        loadingSpinner.style.display = 'none';
        trainerDetailContainer.style.display = 'none';
        errorContainer.style.display = 'block';
        errorContainer.textContent = msg;
      }

      function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function renderTrainerDetails(trainer, attendance, payments) {
        loadingSpinner.style.display = 'none';
        errorContainer.style.display = 'none';
        trainerDetailContainer.style.display = 'block';

        // Calculate check-ins this month
        const currentMonthCheckins = attendance ? attendance.filter(a => {
          const d = new Date(a.date);
          const now = new Date();
          return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
        }).length : 0;

        window.trainerDetailData = trainer;
        window.trainerDetailAttendanceCount = currentMonthCheckins;
        window.trainerDetailPayments = payments;

        trainerDetailContainer.innerHTML = `
          <!-- Profile Section -->
          <section class="member-detail-card">
            <h2 class="member-detail-section-title">Personal Information</h2>
            <div class="member-detail-grid">
              <div class="member-detail-field">
                <label class="member-detail-label">Trainer ID</label>
                <div class="member-detail-value">${trainer.trainerId || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Full Name</label>
                <div class="member-detail-value">${trainer.fullName || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Email</label>
                <div class="member-detail-value">${trainer.email || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Contact</label>
                <div class="member-detail-value">${trainer.contact || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Gender</label>
                <div class="member-detail-value">${trainer.gender || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Date of Birth</label>
                <div class="member-detail-value">${formatDate(trainer.dateOfBirth)}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Address</label>
                <div class="member-detail-value">${trainer.address || 'N/A'}</div>
              </div>
            </div>
          </section>

          <!-- Emergency Info Section -->
          <section class="member-detail-card">
            <h2 class="member-detail-section-title">Emergency Contact</h2>
            <div class="member-detail-grid">
              <div class="member-detail-field">
                <label class="member-detail-label">Emergency Contact Name</label>
                <div class="member-detail-value">${trainer.emergencyContactName || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Relationship</label>
                <div class="member-detail-value">${trainer.emergencyContactRelationship || 'N/A'}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Emergency Number</label>
                <div class="member-detail-value">${trainer.emergencyNumber || 'N/A'}</div>
              </div>
            </div>
          </section>

          <!-- Employment Info Section -->
          <section class="member-detail-card">
            <h2 class="member-detail-section-title">Employment Information</h2>
            <div class="member-detail-grid">
              <div class="member-detail-field">
                <label class="member-detail-label">Join Date</label>
                <div class="member-detail-value">${formatDate(trainer.joinDate)}</div>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Status</label>
                <div class="member-detail-value">${trainer.status || 'N/A'}</div>
              </div>
            </div>
          </section>

          <!-- Assigned Members Section -->
          <section class="member-detail-card">
            <h2 class="member-detail-section-title">Assigned Members</h2>
            <div class="member-detail-grid">
              <div class="member-detail-field">
                <label class="member-detail-label">Current Members</label>
                <ul class="member-detail-list">
                  ${(trainer.assignedMembers && trainer.assignedMembers.length) ?
            trainer.assignedMembers.filter(m => !m.removedDate).map(m => `
                      <li class="member-detail-list-item">
                        <span class="member-detail-list-label">${m.fullName} (${m.memberId})</span>
                        <span class="member-detail-list-value">Assigned: ${formatDate(m.assignedDate)}</span>
                      </li>
                    `).join('') :
            '<li class="member-detail-list-item">No current members assigned</li>'}
                </ul>
              </div>
              <div class="member-detail-field">
                <label class="member-detail-label">Member Assignment History</label>
                <ul class="member-detail-list">
                  ${(trainer.assignedMemberHistory && trainer.assignedMemberHistory.length) ?
            trainer.assignedMemberHistory.map(m => `
                      <li class="member-detail-list-item">
                        <span class="member-detail-list-label">${m.fullName} (${m.memberId})</span>
                        <span class="member-detail-list-value">
                          ${formatDate(m.assignedDate)} → ${m.removedDate ? formatDate(m.removedDate) : 'Active'}
                        </span>
                      </li>
                    `).join('') :
            '<li class="member-detail-list-item">No assignment history available</li>'}
                </ul>
              </div>
            </div>
          </section>

          <!-- Attendance Section -->
          <section class="member-detail-card">
            <h2 class="member-detail-section-title">Attendance</h2>
            <div class="member-detail-grid">
              <div class="member-detail-field">
                <label class="member-detail-label">Check-ins This Month</label>
                <div class="member-detail-value">${currentMonthCheckins} check-ins</div>
              </div>
            </div>
          </section>

          <!-- Payment History Section -->
          <section class="member-detail-card member-payment-history">
            <h2 class="member-detail-section-title">Payment History</h2>
            <div class="table-container">
              <table class="member-payment-table">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Method</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${payments && payments.length ?
            payments.map((p, i) => `
                      <tr>
                        <td>${i + 1}</td>
                        <td>Rs${p.amount.toFixed(2)}</td>
                        <td>${formatDate(p.paymentDate)}</td>
                        <td>${p.paymentMethod || 'N/A'}</td>
                        <td>${p.status || 'N/A'}</td>
                      </tr>
                    `).join('') :
            `<tr>
                      <td colspan="5" style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                        No payment history found
                      </td>
                    </tr>`}
                </tbody>
              </table>
            </div>
          </section>
        `;
      }

      fetchTrainerDetails();

      // Download trainer detail as CSV
      document.getElementById('downloadTrainerDetail').addEventListener('click', () => {
        if (!window.trainerDetailData) {
          window.toast('No trainer data to download', 'error');
          return;
        }
        const trainer = window.trainerDetailData;
        let csvContent = '';
        // Personal Info
        csvContent += 'Personal Information\n';
        csvContent += 'Trainer ID,Full Name,Email,Contact,Gender,Date of Birth,Address\n';
        csvContent += [
          trainer.trainerId || '',
          trainer.fullName || '',
          trainer.email || '',
          trainer.contact || '',
          trainer.gender || '',
          trainer.dateOfBirth ? new Date(trainer.dateOfBirth).toLocaleDateString() : '',
          trainer.address || ''
        ].join(',') + '\n\n';
        // Emergency Info
        csvContent += 'Emergency Contact\n';
        csvContent += 'Name,Relationship,Number\n';
        csvContent += [
          trainer.emergencyContactName || '',
          trainer.emergencyContactRelationship || '',
          trainer.emergencyNumber || ''
        ].join(',') + '\n\n';
        // Employment Info
        csvContent += 'Employment Information\n';
        csvContent += 'Join Date,Status\n';
        csvContent += [
          trainer.joinDate ? new Date(trainer.joinDate).toLocaleDateString() : '',
          trainer.status || ''
        ].join(',') + '\n\n';
        // Assigned Members
        csvContent += 'Assigned Members\n';
        csvContent += 'Current Members\n';
        csvContent += 'Member Name,Member ID,Assigned Date\n';
        if (trainer.assignedMembers && trainer.assignedMembers.length) {
          trainer.assignedMembers.filter(m => !m.removedDate).forEach(m => {
            csvContent += [m.fullName, m.memberId, m.assignedDate ? new Date(m.assignedDate).toLocaleDateString() : ''].join(',') + '\n';
          });
        } else {
          csvContent += 'No current members assigned\n';
        }
        csvContent += '\nAssignment History\n';
        csvContent += 'Member Name,Member ID,Assigned Date,Removed Date\n';
        if (trainer.assignedMemberHistory && trainer.assignedMemberHistory.length) {
          trainer.assignedMemberHistory.forEach(m => {
            csvContent += [m.fullName, m.memberId, m.assignedDate ? new Date(m.assignedDate).toLocaleDateString() : '', m.removedDate ? new Date(m.removedDate).toLocaleDateString() : 'Active'].join(',') + '\n';
          });
        } else {
          csvContent += 'No assignment history available\n';
        }
        csvContent += '\n';
        // Attendance
        csvContent += 'Attendance\n';
        csvContent += 'Check-ins This Month\n';
        csvContent += (window.trainerDetailAttendanceCount !== undefined ? window.trainerDetailAttendanceCount : 'N/A') + ' check-ins\n\n';
        // Payment History
        csvContent += 'Payment History\n';
        csvContent += 'Amount,Date,Method,Status\n';
        if (window.trainerDetailPayments && window.trainerDetailPayments.length) {
          window.trainerDetailPayments.forEach(p => {
            csvContent += [
              'Rs' + (p.amount ? p.amount.toFixed(2) : '0.00'),
              p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : '',
              p.paymentMethod || '',
              p.status || ''
            ].join(',') + '\n';
          });
        } else {
          csvContent += 'No payment history found\n';
        }
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];
        link.setAttribute('href', url);
        link.setAttribute('download', `trainer_detail_${date}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.toast('Trainer detail downloaded', 'success');
      });

      // Print trainer detail
      document.getElementById('printTrainerDetail').addEventListener('click', () => {
        if (!window.trainerDetailData) {
          window.toast('No trainer data to print', 'error');
          return;
        }
        const trainer = window.trainerDetailData;
        const date = new Date().toLocaleString();
        const attendanceCount = window.trainerDetailAttendanceCount !== undefined ? window.trainerDetailAttendanceCount : 'N/A';
        const payments = window.trainerDetailPayments || [];
        const printContent = `
          <html>
          <head>
            <title>Trainer Detail Report</title>
            <style>
              body { font-family: Arial, sans-serif; }
              h1 { text-align: center; }
              .header { margin-bottom: 20px; }
              .footer { margin-top: 20px; text-align: center; font-size: 12px; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f5f5f5; }
              section { margin-bottom: 2rem; }
              .section-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Trainer Detail Report</h1>
              <p>Generated on: ${date}</p>
            </div>
            <section>
              <div class="section-title">Personal Information</div>
              <table><tbody>
                <tr><th>Trainer ID</th><td>${trainer.trainerId || ''}</td></tr>
                <tr><th>Full Name</th><td>${trainer.fullName || ''}</td></tr>
                <tr><th>Email</th><td>${trainer.email || ''}</td></tr>
                <tr><th>Contact</th><td>${trainer.contact || ''}</td></tr>
                <tr><th>Gender</th><td>${trainer.gender || ''}</td></tr>
                <tr><th>Date of Birth</th><td>${trainer.dateOfBirth ? new Date(trainer.dateOfBirth).toLocaleDateString() : ''}</td></tr>
                <tr><th>Address</th><td>${trainer.address || ''}</td></tr>
              </tbody></table>
            </section>
            <section>
              <div class="section-title">Emergency Contact</div>
              <table><tbody>
                <tr><th>Name</th><td>${trainer.emergencyContactName || ''}</td></tr>
                <tr><th>Relationship</th><td>${trainer.emergencyContactRelationship || ''}</td></tr>
                <tr><th>Number</th><td>${trainer.emergencyNumber || ''}</td></tr>
              </tbody></table>
            </section>
            <section>
              <div class="section-title">Employment Information</div>
              <table><tbody>
                <tr><th>Join Date</th><td>${trainer.joinDate ? new Date(trainer.joinDate).toLocaleDateString() : ''}</td></tr>
                <tr><th>Status</th><td>${trainer.status || ''}</td></tr>
              </tbody></table>
            </section>
            <section>
              <div class="section-title">Assigned Members</div>
              <div><strong>Current Members</strong></div>
              <table><thead><tr><th>Member Name</th><th>Member ID</th><th>Assigned Date</th></tr></thead><tbody>
                ${(trainer.assignedMembers && trainer.assignedMembers.length) ?
                  trainer.assignedMembers.filter(m => !m.removedDate).map(m => `<tr><td>${m.fullName}</td><td>${m.memberId}</td><td>${m.assignedDate ? new Date(m.assignedDate).toLocaleDateString() : ''}</td></tr>`).join('') :
                  '<tr><td colspan="3">No current members assigned</td></tr>'}
              </tbody></table>
              <div><strong>Assignment History</strong></div>
              <table><thead><tr><th>Member Name</th><th>Member ID</th><th>Assigned Date</th><th>Removed Date</th></tr></thead><tbody>
                ${(trainer.assignedMemberHistory && trainer.assignedMemberHistory.length) ?
                  trainer.assignedMemberHistory.map(m => `<tr><td>${m.fullName}</td><td>${m.memberId}</td><td>${m.assignedDate ? new Date(m.assignedDate).toLocaleDateString() : ''}</td><td>${m.removedDate ? new Date(m.removedDate).toLocaleDateString() : 'Active'}</td></tr>`).join('') :
                  '<tr><td colspan="4">No assignment history available</td></tr>'}
              </tbody></table>
            </section>
            <section>
              <div class="section-title">Attendance</div>
              <table><tbody>
                <tr><th>Check-ins This Month</th><td>${attendanceCount} check-ins</td></tr>
              </tbody></table>
            </section>
            <section>
              <div class="section-title">Payment History</div>
              <table><thead><tr><th>Amount</th><th>Date</th><th>Method</th><th>Status</th></tr></thead><tbody>
                ${(payments && payments.length) ?
                  payments.map(p => `<tr><td>Rs${p.amount ? p.amount.toFixed(2) : '0.00'}</td><td>${p.paymentDate ? new Date(p.paymentDate).toLocaleDateString() : ''}</td><td>${p.paymentMethod || ''}</td><td>${p.status || ''}</td></tr>`).join('') :
                  '<tr><td colspan="4">No payment history found</td></tr>'}
              </tbody></table>
            </section>
            <div class="footer">
              <p>© ${new Date().getFullYear()} Knox Barbell - Trainer Detail Report</p>
            </div>
          </body>
          </html>
        `;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.onload = function () {
          printWindow.print();
          printWindow.close();
        };
        window.toast('Printing trainer detail...', 'success');
      });
    </script>
</body>

</html>
