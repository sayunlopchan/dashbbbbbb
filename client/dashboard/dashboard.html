<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knox Barbell - Admin Dashboard</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/base.css">
    <link rel="stylesheet" href="./css/dash.css">
    <link rel="stylesheet" href="./css/barChart.css">
    <link rel="stylesheet" href="./css/pieChart.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Knox Barbell</h3>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/dashboard" class="active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                    <div class="tooltip">Dashboard</div>
                </a>
            </li>
            <li>
                <a href="/members">
                    <i class="fas fa-user"></i>
                    <span>Member</span>
                    <div class="tooltip">Member</div>
                </a>
            </li>
            <li>
                <a href="/application">
                    <i class="fa-solid fa-file-lines"></i>
                    <span>Application</span>
                    <div class="tooltip">Application</div>
                </a>
            </li>
            <li>
                <a href="/membership">
                    <i class="fas fa-id-card"></i>
                    <span>Membership</span>
                    <div class="tooltip">Membership</div>
                </a>
            </li>
            <li>
                <a href="/trainers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Trainers</span>
                    <div class="tooltip">Trainers</div>
                </a>
            </li>
            <li>
                <a href="/employee">
                    <i class="fas fa-users"></i>
                    <span>Employee</span>
                    <div class="tooltip">Employee</div>
                </a>
            </li>
            <li>
                <a href="/notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <div class="tooltip">Notifications</div>
                </a>
            </li>
            <li>
                <a href="/attendance">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                    <div class="tooltip">Attendance</div>
                </a>
            </li>
            <li>
                <a href="/events">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                    <div class="tooltip">Events</div>
                </a>
            </li>
            <li>
                <a href="/finance">
                    <i class="fas fa-wallet"></i>
                    <span>Finance</span>
                    <div class="tooltip">Finance</div>
                </a>
            </li>
            <li>
                <a href="/locker">
                    <i class="fas fa-lock"></i>
                    <span>Locker</span>
                    <div class="tooltip">Locker</div>
                </a>
            </li>
            <li>
                <a href="/product">
                    <i class="fas fa-box"></i>
                    <span>Product</span>
                    <div class="tooltip">Product</div>
                </a>
            </li>
            <li class="logout-item">
                <a href="#" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                    <div class="tooltip">Logout</div>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Dashboard</h3>
            </div>
            <div class="topbar-right">
                <!-- notification  -->
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">0</span>

                    <!-- Notification Modal -->
                    <div class="notification-modal">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <a href="/notifications" class="view-all-link">View All</a>
                                <button class="close-notifications">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be populated here -->
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-greeting">
                    <img src="/img/Knox Logo-01.png" alt="User">
                    <span>Hello, Knox Barbell</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- overview -->
            <div class="content-header">
                <h1>Dashboard Overview</h1>

                <!-- daily-monthly toggle start-->
                <div class="toggle-container" id="revenueToggle">
                    <div class="toggle-slider slide-daily" id="slider"></div>
                    <div class="toggle-label toggle-active" id="dailyLabel">Daily</div>
                    <div class="toggle-label" id="monthlyLabel">Monthly</div>
                </div>
                <!-- daily-monthly toggle end -->
            </div>

            <!-- Info Boxes -->
            <div class="info-boxes">
                <!-- Total neumber of members -->
                <div class="info-box info-box-members">
                    <div class="info-box-header">
                        <span class="info-box-title">Total Members</span>
                        <div class="info-box-icon members">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <span class="info-box-number" id="members-count">0</span>
                        <span class="info-box-text">Active Members: 0</span>
                        <a href="/members" class="info-box-link">View all members</a>
                    </div>
                </div>

                <!-- number of member Attendance today  -->
                <div class="info-box info-box-attendance">
                    <div class="info-box-header">
                        <span class="info-box-title">Attendance</span>
                        <div class="info-box-icon attendance">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <span class="info-box-number" id="attendance-count">0</span>
                        <span class="info-box-text">Check-ins today</span>
                        <a href="/attendance" class="info-box-link">View attendance</a>
                    </div>
                </div>

                <!--Total Revenue this month -->
                <div class="info-box info-box-revenue">
                    <div class="info-box-header">
                        <span class="info-box-title">Revenue</span>
                        <div class="info-box-icon revenue">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <div class="revenue-comparison">
                            <span class="revenue-change">
                                <i class="fas fa-caret-up"></i>
                                <span class="change-percentage">0%</span>
                            </span>
                            <span class="info-box-number" id="revenue-count">NPR 0</span>

                        </div>
                        <p class="info-box-text">vs last month</p>
                        <a href="/finance" class="info-box-link">View revenue</a>
                    </div>
                </div>

                <!-- Upcomming EVENTS -->
                <div class="info-box info-box-events">
                    <div class="info-box-header">
                        <span class="info-box-title">Events</span>
                        <div class="info-box-icon events">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="info-box-content">
                        <span class="info-box-number" id="events-count">0</span>
                        <span class="info-box-text">Upcoming Events</span>
                        <a href="/events" class="info-box-link">View events</a>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Bar chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title" id="barChartYear">Members vs Applications - 2025</span>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <span class="legend-color members-legend"></span>
                                <span class="legend-text">Members</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color applications-legend"></span>
                                <span class="legend-text">Applications</span>
                            </div>
                        </div>
                    </div>
                    <div id="memberBarChart" class="bar-chart">
                        <!-- Bar chart will be dynamically generated here -->
                    </div>
                </div>
                <!-- Pie chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <span class="chart-title">Membership</span>
                        <!-- <a href="#" class="chart-view-all">View All</a> -->
                    </div>
                    <div id="membershipPieChart" class="pie-chart">
                        <!-- Pie chart will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Expiry Alert Section -->
            <div class="expiry-alert">
                <div class="section-header">
                    <span class="section-title">Expiry Alert</span>
                    <a href="/notifications" class="section-view-all">View All</a>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Member Id</th>
                            <th>Members</th>
                            <th>Email Address</th>
                            <th>Status</th>
                            <th>Days</th>
                        </tr>
                    </thead>
                    <tbody id="expiryAlertTableBody">
                        <tr>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                        </tr>

                    </tbody>
                </table>
            </div>

            <!-- Events and Announcements -->
            <div class="events-announcements">
                <div class="events-container">
                    <div class="section-header">
                        <span class="section-title">Upcoming Events</span>
                        <a href="/events" class="section-view-all">View All</a>
                    </div>
                    <div class="event-card">
                        <div class="event-title">loading...</div>
                        <div class="event-description">loading...</div>
                    </div>
                    <div class="event-card">
                        <div class="event-title">loading...</div>
                        <div class="event-description">loading...</div>
                    </div>
                </div>

                <div class="announcements-container">
                    <div class="section-header">
                        <span class="section-title">Recent Announcements</span>
                        <a href="/events" class="section-view-all">View All</a>
                    </div>
                    <div class="announcement-item">
                        <div class="announcement-title">loading...</div>
                        <div class="announcement-description">loading...</div>
                        <div class="announcement-meta">
                            <span>loading...</span>
                            <span>loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEWSLETTER SUBSCRIIBERS -->
            <div class="newsletter-subscribers">
                <div class="section-header">
                    <h3>Newsletter Subscribers</h3>
                </div>
                <table class="subscribers-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Email</th>
                            <th>Subscribed Date</th>
                        </tr>
                    </thead>
                    <tbody id="newsletterSubscribersTableBody">
                        <tr>
                            <td colspan="3">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <script src="/js/main.js"></script>
    <script src="./js/logout.js"></script>
    <script src="./js/dashboardChart.js"></script>
    <script>

        // toggle btn 
        const toggle = document.getElementById("revenueToggle");
        const slider = document.getElementById("slider");
        const dailyLabel = document.getElementById("dailyLabel");
        const monthlyLabel = document.getElementById("monthlyLabel");

        let isDaily = true;

        toggle.addEventListener("click", () => {
            isDaily = !isDaily;
            if (isDaily) {
                slider.classList.remove("slide-monthly");
                slider.classList.add("slide-daily");
                dailyLabel.classList.add("toggle-active");
                monthlyLabel.classList.remove("toggle-active");
            } else {
                slider.classList.remove("slide-daily");
                slider.classList.add("slide-monthly");
                dailyLabel.classList.remove("toggle-active");
                monthlyLabel.classList.add("toggle-active");
            }

            // Update the revenue info box with the new data
            updateRevenueInfoBox();
        });

        // Function to update revenue info box based on toggle state
        async function updateRevenueInfoBox() {
            try {
                console.log(`Updating revenue info box for: ${isDaily ? 'Daily' : 'Monthly'} view`);

                const revenueResponse = await fetch(`${baseUrl}/api/payments/stats`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const revenueText = await revenueResponse.text();
                let revenueData;
                try {
                    revenueData = JSON.parse(revenueText);
                } catch (parseError) {
                    throw new Error('Invalid revenue data format');
                }

                if (!revenueData.success) {
                    throw new Error('Failed to fetch revenue data');
                }

                console.log('Revenue data received:', revenueData.data);

                const revenueBox = document.querySelector('.info-box-revenue');
                if (revenueBox) {
                    const revenueNumber = document.getElementById('revenue-count');
                    const revenueText = revenueBox.querySelector('.info-box-text');
                    const revenueChange = revenueBox.querySelector('.revenue-change');
                    const changePercentage = revenueBox.querySelector('.change-percentage');
                    const changeIcon = revenueBox.querySelector('.revenue-change i');

                    if (isDaily) {
                        // Show daily revenue
                        const dailyRevenue = revenueData.data.dailyRevenue || 0;
                        const yesterdayRevenue = revenueData.data.yesterdayRevenue || 0;

                        console.log(`Daily Revenue: ${dailyRevenue}, Yesterday Revenue: ${yesterdayRevenue}`);

                        if (revenueNumber) {
                            const formattedRevenue = dailyRevenue.toLocaleString('en-IN', {
                                style: 'currency',
                                currency: 'NPR',
                                maximumFractionDigits: 0
                            });
                            revenueNumber.textContent = formattedRevenue;
                        }

                        // Calculate daily percentage change
                        const percentageChange = yesterdayRevenue === 0 ? 0 :
                            ((dailyRevenue - yesterdayRevenue) / yesterdayRevenue) * 100;

                        const isPositive = percentageChange >= 0;

                        // Update classes
                        revenueChange.classList.toggle('negative', !isPositive);
                        changeIcon.className = isPositive ? 'fas fa-caret-up' : 'fas fa-caret-down';

                        // Update percentage text
                        changePercentage.textContent = `${isPositive ? '+' : ''}${percentageChange.toFixed(1)}%`;

                        // Update comparison text
                        if (revenueText) {
                            revenueText.textContent = 'vs yesterday';
                        }
                    } else {
                        // Show monthly revenue
                        const monthlyRevenue = revenueData.data.monthlyRevenue || 0;
                        const lastMonthRevenue = revenueData.data.lastMonthRevenue || 0;

                        console.log(`Monthly Revenue: ${monthlyRevenue}, Last Month Revenue: ${lastMonthRevenue}`);

                        if (revenueNumber) {
                            const formattedRevenue = monthlyRevenue.toLocaleString('en-IN', {
                                style: 'currency',
                                currency: 'NPR',
                                maximumFractionDigits: 0
                            });
                            revenueNumber.textContent = formattedRevenue;
                        }

                        // Calculate monthly percentage change
                        const percentageChange = lastMonthRevenue === 0 ? 0 :
                            ((monthlyRevenue - lastMonthRevenue) / lastMonthRevenue) * 100;

                        const isPositive = percentageChange >= 0;

                        // Update classes
                        revenueChange.classList.toggle('negative', !isPositive);
                        changeIcon.className = isPositive ? 'fas fa-caret-up' : 'fas fa-caret-down';

                        // Update percentage text
                        changePercentage.textContent = `${isPositive ? '+' : ''}${percentageChange.toFixed(1)}%`;

                        // Update comparison text
                        if (revenueText) {
                            revenueText.textContent = 'vs last month';
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating revenue info box:', error);
                // Show error state
                const revenueBox = document.querySelector('.info-box-revenue');
                if (revenueBox) {
                    const revenueNumber = document.getElementById('revenue-count');
                    const revenueText = revenueBox.querySelector('.info-box-text');
                    if (revenueNumber) revenueNumber.textContent = 'NPR 0';
                    if (revenueText) revenueText.textContent = isDaily ? 'vs yesterday' : 'vs last month';
                }
            }
        }

        // dashboard logic
        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch and update dashboard info boxes
            async function updateDashboardInfoBoxes() {
                try {
                    // Fetch members data
                    const membersResponse = await fetch(`${baseUrl}/api/members`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    const membersText = await membersResponse.text();
                    let membersData;
                    try {
                        membersData = JSON.parse(membersText);
                    } catch (parseError) {
                        throw new Error('Invalid members data format');
                    }

                    const totalMembers = membersData.data?.length || 0;

                    // Update revenue info box using the new function
                    await updateRevenueInfoBox();

                    // Fetch attendance data
                    const attendancesResponse = await fetch(`${baseUrl}/api/attendances`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    const attendancesText = await attendancesResponse.text();
                    let attendancesData;
                    try {
                        attendancesData = JSON.parse(attendancesText);
                    } catch (parseError) {
                        throw new Error('Invalid attendance data format');
                    }

                    // Debug log for attendance data
                    console.log('Attendance API data:', attendancesData);

                    // Get today's date in YYYY-MM-DD format
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];

                    // Count today's check-ins
                    let todayCheckInsCount = 0;
                    if (attendancesData && attendancesData.data && Array.isArray(attendancesData.data)) {
                        todayCheckInsCount = attendancesData.data.filter(attendance => {
                            try {
                                if (!attendance.date) return false;
                                // Convert attendance date to local date string
                                const attendanceDate = new Date(attendance.date);
                                const localAttendanceDateStr = attendanceDate.getFullYear() + '-' +
                                    String(attendanceDate.getMonth() + 1).padStart(2, '0') + '-' +
                                    String(attendanceDate.getDate()).padStart(2, '0');
                                const today = new Date();
                                const localTodayStr = today.getFullYear() + '-' +
                                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                                    String(today.getDate()).padStart(2, '0');
                                // Debug log
                                console.log('Comparing attendance date', localAttendanceDateStr, 'to today', localTodayStr);
                                return localAttendanceDateStr === localTodayStr;
                            } catch (error) {
                                return false;
                            }
                        }).length;
                    } else {
                        // Fallback if data is missing or not an array
                        console.warn('Attendance data missing or not an array:', attendancesData);
                        todayCheckInsCount = 0;
                    }

                    // Fetch events data
                    const eventsResponse = await fetch(`${baseUrl}/api/events`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    const eventsText = await eventsResponse.text();
                    let eventsData;
                    try {
                        eventsData = JSON.parse(eventsText);
                    } catch (parseError) {
                        throw new Error('Invalid events data format');
                    }

                    // Count upcoming events
                    let upcomingEventsCount = 0;
                    if (eventsData && eventsData.docs && Array.isArray(eventsData.docs)) {
                        const currentDate = new Date();
                        upcomingEventsCount = eventsData.docs.filter(event => {
                            try {
                                if (!event.startTime) return false;
                                const eventDate = new Date(event.startTime);
                                return eventDate > currentDate;
                            } catch (error) {
                                return false;
                            }
                        }).length;
                    }

                    // Update all info boxes
                    const membersBox = document.querySelector('.info-box-members');
                    const attendanceBox = document.querySelector('.info-box-attendance');
                    const eventsBox = document.querySelector('.info-box-events');

                    if (membersBox) {
                        const membersNumber = document.getElementById('members-count');
                        const membersText = membersBox.querySelector('.info-box-text');
                        if (membersNumber) membersNumber.textContent = totalMembers;
                        if (membersText) membersText.textContent = `Active Members: ${totalMembers}`;
                    }

                    if (attendanceBox) {
                        const attendanceNumber = document.getElementById('attendance-count');
                        if (attendanceNumber) attendanceNumber.textContent = todayCheckInsCount;
                    }

                    if (eventsBox) {
                        const eventsNumber = document.getElementById('events-count');
                        if (eventsNumber) eventsNumber.textContent = upcomingEventsCount;
                    }

                } catch (error) {
                    // Show error state in info boxes
                    const infoBoxes = document.querySelectorAll('.info-box-members, .info-box-attendance, .info-box-revenue, .info-box-events');
                    infoBoxes.forEach(box => {
                        const number = box.querySelector('.info-box-number');
                        if (number) number.textContent = '0';
                    });
                }
            }

            // Initial data fetch
            await updateDashboardInfoBoxes();
            await updateRevenueInfoBox(); // Ensure revenue is loaded initially

            // Refresh data periodically
            setInterval(updateDashboardInfoBoxes, 10 * 60 * 1000); // Refresh every 10 minutes

            // Add this function to the existing script block
            async function fetchMembersExpiringWithin7Days() {
                try {
                    const response = await fetch(`${baseUrl}/api/members`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to fetch members. Status: ${response.status}, ${errorText}`);
                    }

                    const membersText = await response.text();
                    let membersData;
                    try {
                        membersData = JSON.parse(membersText);
                    } catch (parseError) {
                        throw new Error('Invalid members data format');
                    }

                    const expiryAlertTableBody = document.getElementById('expiryAlertTableBody');

                    // Validate expiryAlertTableBody exists
                    if (!expiryAlertTableBody) {
                        return;
                    }

                    // Clear existing rows
                    expiryAlertTableBody.innerHTML = '';

                    // Current date
                    const currentDate = new Date();

                    // Extract the actual members array
                    const membersArray = membersData.data || [];

                    if (!Array.isArray(membersArray)) {
                        expiryAlertTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">Unable to load members data</td>
                            </tr>
                        `;
                        return;
                    }

                    // Filter and populate expiring members
                    const expiringMembers = membersArray.filter(member => {
                        if (!member.endDate) {
                            return false;
                        }

                        const endDate = new Date(member.endDate);
                        const daysDifference = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));

                        // Return members expiring within 7 days (both future and past)
                        return daysDifference <= 7;
                    }).sort((a, b) => {
                        // Sort by closest to expiration
                        const aEndDate = new Date(a.endDate);
                        const bEndDate = new Date(b.endDate);
                        return Math.abs(aEndDate - currentDate) - Math.abs(bEndDate - currentDate);
                    });

                    // Populate table with expiring members
                    if (expiringMembers.length === 0) {
                        expiryAlertTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">No members expiring within 7 days</td>
                            </tr>
                        `;
                        return;
                    }

                    expiringMembers.forEach(member => {
                        const endDate = new Date(member.endDate);
                        const daysDifference = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${member.memberId || 'N/A'}</td>
                            <td>${member.fullName || 'Unknown'}</td>
                            <td>${member.email || 'N/A'}</td>
                            <td>
                                <span class="status ${daysDifference < 0 ? 'expired' : 'expiring'}">
                                    ${daysDifference < 0 ? 'Expired' : 'Expiring'}
                                </span>
                            </td>
                            <td>${daysDifference < 0 ? `${Math.abs(daysDifference)} days ago` : `In ${daysDifference} days`}</td>
                        `;
                        expiryAlertTableBody.appendChild(row);
                    });

                    // Limit to top 5 expiring members
                    const rows = expiryAlertTableBody.querySelectorAll('tr');
                    if (rows.length > 5) {
                        for (let i = 5; i < rows.length; i++) {
                            rows[i].remove();
                        }
                    }

                } catch (error) {
                    const expiryAlertTableBody = document.getElementById('expiryAlertTableBody');
                    if (expiryAlertTableBody) {
                        expiryAlertTableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center">
                                    Error loading expiring members: ${error.message}
                                </td>
                            </tr>
                        `;
                    }
                }
            }

            // Call the function when the dashboard loads
            await fetchMembersExpiringWithin7Days();
        });

        // Function to fetch and update upcoming event count
        async function updateUpcomingEventCount() {
            try {
                const response = await fetch(`${baseUrl}/api/events`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const rawText = await response.text();

                // Try to parse the JSON
                let data;
                try {
                    data = JSON.parse(rawText);
                } catch (parseError) {
                    throw new Error('Invalid JSON response from server');
                }

                if (!response.ok) {
                    throw new Error('Failed to fetch events');
                }

                // Get current date
                const currentDate = new Date();

                // Filter upcoming events
                const upcomingEvents = data.docs.filter(event => {
                    const eventDate = new Date(event.startTime);
                    return eventDate > currentDate;
                });

                // Update the count in the events info box
                const eventCountElement = document.getElementById('events-count');
                if (eventCountElement) {
                    eventCountElement.textContent = upcomingEvents.length;
                }
            } catch (error) {
                const eventCountElement = document.getElementById('events-count');
                if (eventCountElement) {
                    eventCountElement.textContent = '0';
                }
            }
        }


        // Function to fetch and display events and announcements
        async function updateEventsAndAnnouncements() {
            try {
                // Fetch events
                const eventsResponse = await fetch(`${baseUrl}/api/events`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const eventsText = await eventsResponse.text();
                let eventsData;
                try {
                    eventsData = JSON.parse(eventsText);
                } catch (parseError) {
                    throw new Error('Invalid events data format');
                }

                if (!eventsData.success) {
                    throw new Error(eventsData.message || 'Failed to fetch events');
                }

                // Get current date
                const currentDate = new Date();

                // Filter and sort upcoming events
                const upcomingEvents = eventsData.docs
                    .filter(event => {
                        try {
                            if (!event.startTime) return false;
                            const eventDate = new Date(event.startTime);
                            return eventDate > currentDate;
                        } catch {
                            return false;
                        }
                    })
                    .sort((a, b) => new Date(a.startTime) - new Date(b.startTime))
                    .slice(0, 2); // Top 2

                // Update events container
                const eventsContainer = document.querySelector('.events-container');
                if (eventsContainer) {
                    const sectionHeader = eventsContainer.querySelector('.section-header');
                    eventsContainer.innerHTML = '';
                    if (sectionHeader) eventsContainer.appendChild(sectionHeader);

                    if (upcomingEvents.length === 0) {
                        const fallback = `<div class="event-card" style="text-align:center; color:#888; padding:24px 0;">
                    <i class='fas fa-calendar-times' style='font-size:1.5em; margin-bottom:6px; display:block; color:#bbb;'></i>
                    No upcoming events found
                </div>`;
                        eventsContainer.innerHTML += fallback;
                    } else {
                        upcomingEvents.forEach(event => {
                            const card = document.createElement('div');
                            card.className = 'event-card';

                            const title = document.createElement('div');
                            title.className = 'event-title';
                            title.textContent = event.title;

                            const description = document.createElement('div');
                            description.className = 'event-description';

                            let descriptionText = 'No description available';
                            if (Array.isArray(event.description)) {
                                descriptionText = event.description.join(' ');
                                if (descriptionText.length > 100) {
                                    descriptionText = descriptionText.substring(0, 100) + '...';
                                }
                            }

                            description.textContent = descriptionText;
                            card.appendChild(title);
                            card.appendChild(description);
                            eventsContainer.appendChild(card);
                        });
                    }
                }

                // Fetch announcements
                const announcementsResponse = await fetch(`${baseUrl}/api/announcements`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const announcementsText = await announcementsResponse.text();
                let announcementsData;
                try {
                    announcementsData = JSON.parse(announcementsText);
                } catch (parseError) {
                    throw new Error('Invalid announcements data format');
                }

                if (!announcementsData.success) {
                    throw new Error(announcementsData.message || 'Failed to fetch announcements');
                }

                // Update announcements container
                const announcementsContainer = document.querySelector('.announcements-container');
                if (announcementsContainer) {
                    const sectionHeader = announcementsContainer.querySelector('.section-header');
                    announcementsContainer.innerHTML = '';
                    if (sectionHeader) announcementsContainer.appendChild(sectionHeader);

                    if (!announcementsData.docs || announcementsData.docs.length === 0) {
                        const fallback = `<div class="announcement-item" style="text-align:center; color:#888; padding:24px 0;">
                    <i class='fas fa-bullhorn' style='font-size:1.5em; margin-bottom:6px; display:block; color:#bbb;'></i>
                    No announcements found
                </div>`;
                        announcementsContainer.innerHTML += fallback;
                    } else {
                        const recent = announcementsData.docs[0];

                        const item = document.createElement('div');
                        item.className = 'announcement-item';

                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'announcement-title';
                        titleDiv.textContent = recent.title;

                        const descDiv = document.createElement('div');
                        descDiv.className = 'announcement-description';
                        descDiv.textContent = recent.description
                            ? recent.description.substring(0, 150) + '...'
                            : 'No description available';

                        const metaDiv = document.createElement('div');
                        metaDiv.className = 'announcement-meta';
                        metaDiv.innerHTML = `
                    <span>by ${recent.authorName || 'Unknown'}</span>
                    <span>${new Date(recent.createdAt).toLocaleDateString()}</span>
                `;

                        item.appendChild(titleDiv);
                        item.appendChild(descDiv);
                        item.appendChild(metaDiv);

                        announcementsContainer.appendChild(item);
                    }
                }

            } catch (error) {
                console.error('Error loading events or announcements:', error);

                // Error fallback UI
                const eventsContainer = document.querySelector('.events-container');
                if (eventsContainer) {
                    const sectionHeader = eventsContainer.querySelector('.section-header');
                    eventsContainer.innerHTML = '';
                    if (sectionHeader) eventsContainer.appendChild(sectionHeader);
                    const errorCard = document.createElement('div');
                    errorCard.className = 'event-card';
                    errorCard.innerHTML = `
                <div class="event-title">Error loading events</div>
                <div class="event-description">Please try again later</div>
            `;
                    eventsContainer.appendChild(errorCard);
                }

                const announcementsContainer = document.querySelector('.announcements-container');
                if (announcementsContainer) {
                    const sectionHeader = announcementsContainer.querySelector('.section-header');
                    announcementsContainer.innerHTML = '';
                    if (sectionHeader) announcementsContainer.appendChild(sectionHeader);
                    const errorItem = document.createElement('div');
                    errorItem.className = 'announcement-item';
                    errorItem.innerHTML = `
                <div class="announcement-title">Error loading announcement</div>
                <div class="announcement-description">Please try again later</div>
                <div class="announcement-meta"><span>Error</span></div>
            `;
                    announcementsContainer.appendChild(errorItem);
                }
            }
        }

        // Call both functions when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateUpcomingEventCount();
            updateEventsAndAnnouncements();
        });

        // Newsletter Subscribers Table Logic
        async function fetchNewsletterSubscribers() {
            const tbody = document.getElementById('newsletterSubscribersTableBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
            try {
                const res = await fetch('/api/newsletter/subscribers');
                const data = await res.json();
                if (!data.success || !Array.isArray(data.data)) {
                    tbody.innerHTML = '<tr><td colspan="3">Failed to load subscribers</td></tr>';
                    return;
                }
                if (data.data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:#888; font-size:1.1em; padding:24px 0;">
                        <i class='fas fa-user-slash' style='font-size:1.5em; margin-bottom:6px; display:block; color:#bbb;'></i>
                        No subscribers found
                    </td></tr>`;
                    return;
                }
                tbody.innerHTML = data.data.map((subscriber, idx) => `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${subscriber.email}</td>
                        <td>${new Date(subscriber.subscribedAt).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="3">Error loading subscribers</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchNewsletterSubscribers);
    </script>
</body>

</html>