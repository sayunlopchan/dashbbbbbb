<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Knox Barbell - Notifications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/events.css">
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Knox Barbell</h3>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                    <div class="tooltip">Dashboard</div>
                </a>
            </li>
            <li>
                <a href="/members">
                    <i class="fas fa-user"></i>
                    <span>Member</span>
                    <div class="tooltip">Member</div>
                </a>
            </li>
            <li>
                <a href="/application">
                    <i class="fa-solid fa-file-lines"></i>
                    <span>Application</span>
                    <div class="tooltip">Application</div>
                </a>
            </li>
            <li>
                <a href="/membership">
                    <i class="fas fa-id-card"></i>
                    <span>Membership</span>
                    <div class="tooltip">Membership</div>
                </a>
            </li>
            <li>
                <a href="/trainers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Trainers</span>
                    <div class="tooltip">Trainers</div>
                </a>
            </li>
            <li>
                <a href="/employee">
                    <i class="fas fa-users"></i>
                    <span>Employee</span>
                    <div class="tooltip">Employee</div>
                </a>
            </li>
            <li>
                <a href="/notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <div class="tooltip">Notifications</div>
                </a>
            </li>
            <li>
                <a href="/attendance">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                    <div class="tooltip">Attendance</div>
                </a>
            </li>
            <li>
                <a href="/events" class="active">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                    <div class="tooltip">Events</div>
                </a>
            </li>
            <li>
                <a href="/finance">
                    <i class="fas fa-wallet"></i>
                    <span>Finance</span>
                    <div class="tooltip">Finance</div>
                </a>
            </li>
            <li>
                <a href="/product">
                    <i class="fas fa-box"></i>
                    <span>Product</span>
                    <div class="tooltip">Product</div>
                </a>
            </li>
            <li class="logout-item">
                <a href="#" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                    <div class="tooltip">Logout</div>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Events</h3>
            </div>
            <div class="topbar-right">
                <!-- notification  -->
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">0</span>
                    
                    <!-- Notification Modal -->
                    <div class="notification-modal">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <a href="/notifications" class="view-all-link">View All</a>
                                <button class="close-notifications">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be populated here -->
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-greeting">
                    <img src="/img/Knox Logo-01.png" alt="User">
                    <span>Hello, Knox Barbell</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <div class="content-header">
                <h1>Events & Announcements</h1>
            </div>

            <!-- Switch tab-->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('events')">Events</button>
                <button class="tab" onclick="switchTab('announcements')">Announcements</button>
            </div>

            <!-- Search and add -->
            <div class="search-add active" id="eventSearch">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Search event...">
                </div>
                <button id="addTrainerBtn" class="add-btn">
                    <span>+</span>
                    Add Event
                </button>
            </div>
            <div class="search-add" id="announcementSearch">
                <div class="search-box">
                    <input type="text" id="search" placeholder="Search announcement...">
                </div>
                <button id="addTrainerBtn" class="add-btn">
                    <span>+</span>
                    Add Announcement
                </button>
            </div>
            <!-- Search and add -->

            <!-- Events Tab -->
            <div id="events" class="card-list">
                <div class="card">
                    <h3>loading...</h3>
                    <small>loading...</small>
                    <p>loading...</p>
                    <p class="participants">ðŸ‘¥loading... participants <br> <span class="instructor">loading...</span></p>
                    <p class="edit"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete"><i class="fa-solid fa-trash"></i></p>
                </div>
            </div>

            <!-- Announcements Tab -->
            <div id="announcements" class="ann-card-list" style="display:none">
                <div class="card">
                    <h3>New Equipment Arriving Soon</h3>
                    <small>Posted on 4/27/2025 by Mrs. Manish Gaha</small>
                    <p>Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla vobis. Solitudo consectetur
                        supplanto caput solium. Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla
                        vobis.</p>
                    <p class="edit"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete"><i class="fa-solid fa-trash"></i></p>
                </div>
                <div class="card">
                    <h3>New Equipment Arriving Soon</h3>
                    <small>Posted on 4/27/2025 by Mrs. Manish Gaha</small>
                    <p>Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla vobis. Solitudo consectetur
                        supplanto caput solium. Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla
                        vobis.</p>
                    <p class="edit"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete"><i class="fa-solid fa-trash"></i></p>
                </div>
                <div class="card">
                    <h3>New Equipment Arriving Soon</h3>
                    <small>Posted on 4/27/2025 by Mrs. Manish Gaha</small>
                    <p>Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla vobis. Solitudo consectetur
                        supplanto caput solium. Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla
                        vobis.</p>
                    <p class="edit"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete"><i class="fa-solid fa-trash"></i></p>
                </div>
                <div class="card">
                    <h3>New Equipment Arriving Soon</h3>
                    <small>Posted on 4/27/2025 by Mrs. Manish Gaha</small>
                    <p>Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla vobis. Solitudo consectetur
                        supplanto caput solium. Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla
                        vobis.</p>
                    <p class="edit"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete"><i class="fa-solid fa-trash"></i></p>
                </div>
                <div class="card">
                    <h3>New Equipment Arriving Soon</h3>
                    <small>Posted on 4/27/2025 by Mrs. Manish Gaha</small>
                    <p>Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla vobis. Solitudo consectetur
                        supplanto caput solium. Contra apud blanditiis defungo curso chiropraghum utrum viscus nulla
                        vobis.</p>
                    <p class="edit"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete"><i class="fa-solid fa-trash"></i></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="addEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Add New Event</h2>
                    <p>Create a new event for Knox Barbell</p>
                </div>
                <button class="modal-close" id="closeEventModal">&times;</button>
            </div>
            <form id="addEventForm">
                <div class="form-grid form-grid-event">
                    <div class="form-group">
                        <label for="eventTitle">Event Title</label>
                        <input type="text" id="eventTitle" name="title" required placeholder="Enter event title">
                    </div>
                    <div class="form-group">
                        <label for="eventOrganizer">Organizer</label>
                        <input type="text" id="eventOrganizer" name="organizer" required placeholder="Enter event organizer">
                    </div>
                    <div class="form-group">
                        <label for="eventCategory">Category</label>
                        <select id="eventCategory" name="category" required>
                            <option value="">Select a category</option>
                            <option value="fitness">Fitness</option>
                            <option value="competition">Competition</option>
                            <option value="workshop">Workshop</option>
                            <option value="social">Social</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventLocation">Location</label>
                        <input type="text" id="eventLocation" name="location" required
                            placeholder="Enter event location">
                    </div>
                    <div class="form-group">
                        <label for="eventStartTime">Start Time</label>
                        <input type="datetime-local" id="eventStartTime" name="startTime" required>
                    </div>
                    <div class="form-group">
                        <label for="eventEndTime">End Time</label>
                        <input type="datetime-local" id="eventEndTime" name="endTime" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="eventDescription">Description</label>
                        <textarea id="eventDescription" name="description" rows="4" required
                            placeholder="Enter event description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="eventTags">Tags (optional)</label>
                        <input type="text" id="eventTags" name="tags" placeholder="Enter tags separated by comma">
                    </div>
                    <div class="form-group">
                        <label for="eventImages">Images (optional)</label>
                        <input type="file" id="eventImages" name="images" multiple accept="image/*">
                    </div>
                    <div class="form-group">
                        <div class="image-preview-container"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEventModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Announcement Modal -->
    <div class="modal-overlay" id="addAnnouncementModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Add New Announcement</h2>
                    <p>Create a new announcement for Knox Barbell</p>
                </div>
                <button class="modal-close" id="closeAnnouncementModal">&times;</button>
            </div>
            <form id="addAnnouncementForm">
                <div class="form-grid form-grid-announcement">
                    <div class="form-group">
                        <label for="announcementTitle">Announcement Title</label>
                        <input type="text" id="announcementTitle" name="title" required placeholder="Enter announcement title">
                    </div>
                    <div class="form-group full-width">
                        <label for="announcementDescription">Description</label>
                        <textarea id="announcementDescription" name="description" rows="4" required placeholder="Enter announcement description"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAnnouncementModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Announcement</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Edit Event Modal -->
    <div class="modal-overlay" id="editEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Edit Event</h2>
                    <p>Update event details</p>
                </div>
                <button class="modal-close" id="closeEditEventModal">&times;</button>
            </div>
            <form id="editEventForm">
                <input type="hidden" id="editEventId">
                <div class="form-grid form-grid-event">
                    <div class="form-group">
                        <label for="editEventTitle">Event Title</label>
                        <input type="text" id="editEventTitle" name="title" required placeholder="Enter event title">
                    </div>
                    <div class="form-group">
                        <label for="editEventOrganizer">Organizer</label>
                        <input type="text" id="editEventOrganizer" name="organizer" required placeholder="Enter event organizer">
                    </div>
                    <div class="form-group">
                        <label for="editEventCategory">Category</label>
                        <select id="editEventCategory" name="category" required>
                            <option value="">Select a category</option>
                            <option value="fitness">Fitness</option>
                            <option value="competition">Competition</option>
                            <option value="workshop">Workshop</option>
                            <option value="social">Social</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editEventLocation">Location</label>
                        <input type="text" id="editEventLocation" name="location" required placeholder="Enter event location">
                    </div>
                    <div class="form-group">
                        <label for="editEventStartTime">Start Time</label>
                        <input type="datetime-local" id="editEventStartTime" name="startTime" required>
                    </div>
                    <div class="form-group">
                        <label for="editEventEndTime">End Time</label>
                        <input type="datetime-local" id="editEventEndTime" name="endTime" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editEventDescription">Description</label>
                        <textarea id="editEventDescription" name="description" rows="4" required placeholder="Enter event description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editEventTags">Tags (optional)</label>
                        <input type="text" id="editEventTags" name="tags" placeholder="Enter tags separated by comma">
                    </div>
                    <div class="form-group">
                        <label for="editEventImages">Images (optional)</label>
                        <input type="file" id="editEventImages" name="images" multiple accept="image/*">
                    </div>
                    <div class="form-group">
                        <div class="image-preview-container" id="editImagePreviewContainer"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEditEventModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Edit Announcement Modal -->
    <div class="modal-overlay" id="editAnnouncementModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Edit Announcement</h2>
                    <p>Update announcement details</p>
                </div>
                <button class="modal-close" id="closeEditAnnouncementModal">&times;</button>
            </div>
            <form id="editAnnouncementForm">
                <input type="hidden" id="editAnnouncementId">
                <div class="form-grid form-grid-announcement">
                    <div class="form-group">
                        <label for="editAnnouncementTitle">Announcement Title</label>
                        <input type="text" id="editAnnouncementTitle" name="title" required placeholder="Enter announcement title">
                    </div>
                    <div class="form-group full-width">
                        <label for="editAnnouncementDescription">Description</label>
                        <textarea id="editAnnouncementDescription" name="description" rows="4" required placeholder="Enter announcement description"></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelEditAnnouncementModal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Announcement</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Function to render events
        function renderEvents(events) {
            const eventsContainer = document.getElementById('events');
            eventsContainer.innerHTML = ''; // Clear existing events

            if (!events || events.length === 0) {
                const noEventsCard = document.createElement('div');
                noEventsCard.classList.add('card', 'no-events');
                noEventsCard.innerHTML = `
                    <div class="no-events-content">
                        <i class="fas fa-calendar-times"></i>
                        <h3>No Events Found</h3>
                        <p>There are no events scheduled at the moment.</p>
                        <button class="btn btn-primary" id="addFirstEvent">
                            <i class="fas fa-plus"></i> Create Your First Event
                        </button>
                    </div>
                `;
                eventsContainer.appendChild(noEventsCard);

                // Add event listener to the "Create Your First Event" button
                document.getElementById('addFirstEvent').addEventListener('click', () => {
                    addEventModal.classList.add('active');
                });

                return;
            }

            events.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.classList.add('card');
                
                // Create image container if event has images
                let imageHTML = '';
                if (event.images && event.images.length > 0) {
                    imageHTML = `
                        <div class="event-images">
                            ${event.images.map(image => `
                                <img src="/uploads/${image.filename}" 
                                     alt="${image.originalName || image.filename}" 
                                     class="event-image" 
                                     onerror="this.style.display='none'">
                            `).join('')}
                        </div>
                    `;
                }

                eventCard.innerHTML = `
                    ${imageHTML}
                    <h3>${event.title}</h3>
                    <small>${formatDate(event.startTime)}</small>
                    <p>${event.description}</p>
                    <p class="participants">ðŸ‘¥ ${event.participantCount || 0} participants <br> 
                        <span class="instructor">with ${event.organizer}</span>
                    </p>
                    <p class="edit" data-event-id="${event.eventId}"><i class="fa-solid fa-pen"></i></p>
                    <p class="delete" data-event-id="${event.eventId}"><i class="fa-solid fa-trash"></i></p>
                `;
                eventsContainer.appendChild(eventCard);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit').forEach(editBtn => {
                editBtn.addEventListener('click', handleEditEvent);
            });

            document.querySelectorAll('.delete').forEach(deleteBtn => {
                deleteBtn.addEventListener('click', handleDeleteEvent);
            });
        }

        // Fetch events from API
        async function fetchEvents() {
            try {
                const response = await fetch('/api/events');
                if (!response.ok) {
                    throw new Error('Failed to fetch events');
                }
                const data = await response.json();
                renderEvents(data.docs || []); // Assuming mongoose-paginate returns docs
            } catch (error) {
                console.error('Error fetching events:', error);
                window.toast('Failed to load events', 'error');
            }
        }

        // Handle edit event
        async function handleEditEvent(event) {
            const eventId = event.currentTarget.dataset.eventId;
            try {
                const response = await fetch(`/api/events/${eventId}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch event details');
                }
                const data = await response.json();
                if (data.success) {
                    openEditEventModal(data.event);
                } else {
                    throw new Error(data.message || 'Failed to fetch event details');
                }
            } catch (error) {
                console.error('Error fetching event details:', error);
                window.toast('Failed to load event details', 'error');
            }
        }

        // Handle delete event
        async function handleDeleteEvent(event) {
            const eventId = event.currentTarget.dataset.eventId;
            
            const confirmed = await window.confirmDialog({
                title: 'Delete Event',
                message: 'Are you sure you want to delete this event? This action cannot be undone.',
                type: 'delete'
            });

            if (!confirmed) return;

            try {
                console.log('Attempting to delete event with ID:', eventId); // Debug log
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE'
                });

                console.log('Delete response status:', response.status); // Debug log

                if (response.ok) {
                    window.toast('Event deleted successfully', 'success');
                    fetchEvents(); // Refresh events list
                } else {
                    const errorData = await response.json();
                    window.toast(errorData.message || 'Failed to delete event', 'error');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                window.toast('An error occurred while deleting the event', 'error');
            }
        }

        // Edit Event Modal Elements
        const editEventModal = document.getElementById('editEventModal');
        const closeEditEventModalBtn = document.getElementById('closeEditEventModal');
        const cancelEditEventModalBtn = document.getElementById('cancelEditEventModal');
        const editEventForm = document.getElementById('editEventForm');
        const editImageUpload = document.getElementById('editEventImages');
        const editImagePreviewContainer = document.getElementById('editImagePreviewContainer');

        // Store selected files for edit form
        let editSelectedFiles = [];
        let existingImages = []; // Store existing images from the event

        // Function to open edit event modal
        async function openEditEventModal(event) {
            try {
                // Debug log to see what data we're receiving
                console.log('Event data received:', event);

                // Ensure we have valid data before proceeding
                if (!event) {
                    throw new Error('No event data received');
                }

                // Clear selected files and existing images
                editSelectedFiles = [];
                existingImages = [];

                // Populate form with event details
                const formFields = {
                    'editEventId': event.eventId,
                    'editEventTitle': event.title || '',
                    'editEventOrganizer': event.organizer || '',
                    'editEventCategory': event.category || '',
                    'editEventLocation': event.location || '',
                    'editEventDescription': event.description || '',
                    'editEventTags': event.tags ? event.tags.join(', ') : ''
                };

                // Set form field values
                Object.entries(formFields).forEach(([fieldId, value]) => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.value = value;
                    } else {
                        console.warn(`Element with id ${fieldId} not found`);
                    }
                });

                // Format dates properly for datetime-local input
                const formatDateForInput = (dateString) => {
                    if (!dateString) return '';
                    try {
                        const date = new Date(dateString);
                        if (isNaN(date.getTime())) {
                            console.warn('Invalid date:', dateString);
                            return '';
                        }
                        return date.toISOString().slice(0, 16);
                    } catch (error) {
                        console.error('Error formatting date:', error);
                        return '';
                    }
                };

                // Set date values
                const startTimeElement = document.getElementById('editEventStartTime');
                const endTimeElement = document.getElementById('editEventEndTime');

                if (startTimeElement) {
                    startTimeElement.value = formatDateForInput(event.startTime);
                }
                if (endTimeElement) {
                    endTimeElement.value = formatDateForInput(event.endTime);
                }

                // Clear existing image previews
                editImagePreviewContainer.innerHTML = '';

                // Show existing images if any
                if (event.images && Array.isArray(event.images) && event.images.length > 0) {
                    existingImages = [...event.images]; // Store existing images
                    event.images.forEach(image => {
                        if (!image || !image.filename) return; // Skip invalid images

                        const imagePreview = document.createElement('div');
                        imagePreview.classList.add('image-preview');

                        const previewImg = document.createElement('img');
                        previewImg.src = `/uploads/${image.filename}`;
                        previewImg.classList.add('preview-image');
                        previewImg.onerror = () => {
                            console.warn('Failed to load image:', image.filename);
                            editImagePreviewContainer.removeChild(imagePreview);
                        };

                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = 'Ã—';
                        removeBtn.classList.add('remove-image');
                        removeBtn.style.position = 'absolute';
                        removeBtn.style.top = '5px';
                        removeBtn.style.right = '5px';
                        removeBtn.style.background = 'rgba(255,0,0,0.7)';
                        removeBtn.style.color = 'white';
                        removeBtn.style.border = 'none';
                        removeBtn.style.borderRadius = '50%';
                        removeBtn.style.width = '15px';
                        removeBtn.style.height = '15px';
                        removeBtn.style.fontSize = '10px';
                        removeBtn.style.display = 'flex';
                        removeBtn.style.justifyContent = 'center';
                        removeBtn.style.alignItems = 'center';
                        removeBtn.style.cursor = 'pointer';

                        removeBtn.addEventListener('click', () => {
                            // Remove from existing images
                            const imageIndex = existingImages.findIndex(img => img.filename === image.filename);
                            if (imageIndex > -1) {
                                existingImages.splice(imageIndex, 1);
                            }
                            editImagePreviewContainer.removeChild(imagePreview);
                            editImageUpload.disabled = false;
                        });

                        imagePreview.appendChild(previewImg);
                        imagePreview.appendChild(removeBtn);
                        imagePreview.style.position = 'relative';

                        editImagePreviewContainer.appendChild(imagePreview);
                    });
                }

                // Show modal
                editEventModal.classList.add('active');
            } catch (error) {
                console.error('Error opening edit modal:', error);
                window.toast('Failed to load event details', 'error');
            }
        }

        // Close Edit Modal Functions
        function closeEditEventModal() {
            editEventModal.classList.remove('active');
            editEventForm.reset();
            editImagePreviewContainer.innerHTML = '';
            editImageUpload.disabled = false;
            editSelectedFiles = []; // Clear selected files
            existingImages = []; // Clear existing images
        }

        closeEditEventModalBtn.addEventListener('click', closeEditEventModal);
        cancelEditEventModalBtn.addEventListener('click', closeEditEventModal);

        // Close modal when clicking outside
        editEventModal.addEventListener('click', (e) => {
            if (e.target === editEventModal) {
                closeEditEventModal();
            }
        });

        // Handle edit form submission
        editEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const eventId = document.getElementById('editEventId').value;
            console.log('Attempting to edit event with ID:', eventId); // Debug log

            // Get the submit button and disable it with loading state
            const submitBtn = editEventForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

            // Create FormData object
            const formData = new FormData();
            
            // Add text fields
            formData.append('title', document.getElementById('editEventTitle').value);
            formData.append('organizer', document.getElementById('editEventOrganizer').value);
            formData.append('category', document.getElementById('editEventCategory').value);
            formData.append('location', document.getElementById('editEventLocation').value);

            // Format dates properly
            const startTime = document.getElementById('editEventStartTime').value;
            const endTime = document.getElementById('editEventEndTime').value;
            
            if (startTime) {
                formData.append('startTime', new Date(startTime).toISOString());
            }
            if (endTime) {
                formData.append('endTime', new Date(endTime).toISOString());
            }

            formData.append('description', document.getElementById('editEventDescription').value);
            
            // Add tags if provided
            const tags = document.getElementById('editEventTags').value;
            if (tags) {
                formData.append('tags', tags);
            }

            // Add new images if selected
            if (editSelectedFiles.length > 0) {
                console.log(`Adding ${editSelectedFiles.length} new images to edit form`);
                for (let i = 0; i < editSelectedFiles.length; i++) {
                    console.log(`Adding new image ${i + 1}:`, editSelectedFiles[i].name);
                    formData.append('images', editSelectedFiles[i]);
                }
            }

            try {
                console.log('Sending PUT request to:', `/api/events/${eventId}`); // Debug log
                const response = await fetch(`/api/events/${eventId}`, {
                    method: 'PUT',
                    body: formData
                });

                console.log('Response status:', response.status); // Debug log

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 404) {
                    window.toast('Event not found. It may have been deleted.', 'error');
                    closeEditEventModal();
                    fetchEvents(); // Refresh events list
                    return;
                }

                const result = await response.json();
                console.log('Response data:', result); // Debug log

                if (response.ok) {
                    window.toast('Event updated successfully!', 'success');
                    closeEditEventModal();
                    fetchEvents(); // Refresh events list
                } else {
                    window.toast(result.message || 'Failed to update event', 'error');
                }
            } catch (error) {
                console.error('Error updating event:', error);
                window.toast('An error occurred while updating the event', 'error');
            } finally {
                // Re-enable the submit button and restore original text
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Image Upload Handling for Edit Modal
        editImageUpload.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const currentImageCount = editImagePreviewContainer.querySelectorAll('.image-preview').length;

            if (currentImageCount + files.length > 3) {
                window.toast('You can only upload a maximum of 3 images', 'error');
                e.target.value = '';
                return;
            }

            // Store the selected files
            editSelectedFiles = editSelectedFiles.concat(files);

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imagePreview = document.createElement('div');
                    imagePreview.classList.add('image-preview');

                    const previewImg = document.createElement('img');
                    previewImg.src = event.target.result;
                    previewImg.classList.add('preview-image');

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.classList.add('remove-image');
                    removeBtn.style.position = 'absolute';
                    removeBtn.style.top = '5px';
                    removeBtn.style.right = '5px';
                    removeBtn.style.background = 'rgba(255,0,0,0.7)';
                    removeBtn.style.color = 'white';
                    removeBtn.style.border = 'none';
                    removeBtn.style.borderRadius = '50%';
                    removeBtn.style.width = '15px';
                    removeBtn.style.height = '15px';
                    removeBtn.style.fontSize = '10px';
                    removeBtn.style.display = 'flex';
                    removeBtn.style.justifyContent = 'center';
                    removeBtn.style.alignItems = 'center';
                    removeBtn.style.cursor = 'pointer';

                    removeBtn.addEventListener('click', () => {
                        // Remove the file from editSelectedFiles array
                        const fileIndex = editSelectedFiles.indexOf(file);
                        if (fileIndex > -1) {
                            editSelectedFiles.splice(fileIndex, 1);
                        }
                        editImagePreviewContainer.removeChild(imagePreview);
                        editImageUpload.disabled = false;
                    });

                    imagePreview.appendChild(previewImg);
                    imagePreview.appendChild(removeBtn);
                    imagePreview.style.position = 'relative';

                    editImagePreviewContainer.appendChild(imagePreview);

                    const updatedImageCount = editImagePreviewContainer.querySelectorAll('.image-preview').length;
                    if (updatedImageCount >= 3) {
                        editImageUpload.disabled = true;
                        window.toast('Maximum of 3 images reached', 'info');
                    }
                };
                reader.readAsDataURL(file);
            });

            // Don't reset file input - keep the files for form submission
            // e.target.value = '';
        });

        // Existing switchTab function
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');

            document.getElementById('events').style.display = tab === 'events' ? 'grid' : 'none';
            document.getElementById('announcements').style.display = tab === 'announcements' ? 'grid' : 'none';
            if (tab == 'events') {
                document.getElementById("eventSearch").classList.add("active");
                document.getElementById("announcementSearch").classList.remove("active");
            } else {
                document.getElementById("eventSearch").classList.remove("active")
                document.getElementById("announcementSearch").classList.add("active")
            }
        }

        // Event Modal Functionality
        const addEventBtn = document.getElementById('addTrainerBtn');
        const addEventModal = document.getElementById('addEventModal');
        const closeEventModalBtn = document.getElementById('closeEventModal');
        const cancelEventModalBtn = document.getElementById('cancelEventModal');
        const addEventForm = document.getElementById('addEventForm');
        const imageUpload = document.getElementById('eventImages');
        const imageUploadContainer = document.querySelector('.form-group input[type="file"]').closest('.form-group');

        // Store uploaded images
        let uploadedImages = [];
        let selectedFiles = []; // Store selected files

        // Modify form submission to use fetchEvents for immediate update
        addEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('Form submission started');

            // Get the submit button and disable it with loading state
            const submitBtn = addEventForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

            // Create FormData object
            const formData = new FormData();
            
            // Add text fields
            formData.append('title', document.getElementById('eventTitle').value);
            formData.append('organizer', document.getElementById('eventOrganizer').value);
            formData.append('category', document.getElementById('eventCategory').value);
            formData.append('location', document.getElementById('eventLocation').value);
            formData.append('startTime', new Date(document.getElementById('eventStartTime').value).toISOString());
            formData.append('endTime', new Date(document.getElementById('eventEndTime').value).toISOString());
            
            // Handle description as a single string
            const description = document.getElementById('eventDescription').value;
            formData.append('description', description);
            
            // Add tags if provided
            const tags = document.getElementById('eventTags').value;
            if (tags) {
                formData.append('tags', tags);
            }

            // Add images if selected
            if (selectedFiles.length > 0) {
                console.log(`Adding ${selectedFiles.length} images to form data`);
                for (let i = 0; i < selectedFiles.length; i++) {
                    console.log(`Adding image ${i + 1}:`, selectedFiles[i].name);
                    formData.append('images', selectedFiles[i]);
                }
            } else {
                console.log('No images selected');
            }

            console.log('FormData contents:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }

            try {
                console.log('Sending request to /api/events');
                const response = await fetch('/api/events', {
                    method: 'POST',
                    body: formData // FormData will automatically set the correct Content-Type
                });

                console.log('Response status:', response.status);

                if (response.status === 401) {
                    // Token expired, redirect to login
                    window.location.href = '/login';
                    return;
                }

                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    // Show success notification
                    window.toast('Event created successfully!', 'success');

                    // Close modal and refresh events
                    closeEventModal();
                    fetchEvents(); // Refresh events list
                } else {
                    // Show error notification
                    window.toast(result.message || 'Failed to create event', 'error');
                }
            } catch (error) {
                console.error('Error creating event:', error);
                window.toast('An error occurred while creating the event', 'error');
            } finally {
                // Re-enable the submit button and restore original text
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Image Upload Handling
        imageUpload.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const imagePreviewContainer = document.querySelector('.image-preview-container');

            // Check current number of images
            const currentImageCount = imagePreviewContainer.querySelectorAll('.image-preview').length;

            // Limit to 3 images total
            if (currentImageCount + files.length > 3) {
                window.toast('You can only upload a maximum of 3 images', 'error');
                // Reset file input
                e.target.value = '';
                return;
            }

            // Store the selected files
            selectedFiles = selectedFiles.concat(files);

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imagePreview = document.createElement('div');
                    imagePreview.classList.add('image-preview');

                    const previewImg = document.createElement('img');
                    previewImg.src = event.target.result;
                    previewImg.classList.add('preview-image');

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.classList.add('remove-image');
                    removeBtn.style.position = 'absolute';
                    removeBtn.style.top = '5px';
                    removeBtn.style.right = '5px';
                    removeBtn.style.background = 'rgba(255,0,0,0.7)';
                    removeBtn.style.color = 'white';
                    removeBtn.style.border = 'none';
                    removeBtn.style.borderRadius = '50%';
                    removeBtn.style.width = '15px';
                    removeBtn.style.height = '15px';
                    removeBtn.style.fontSize = '10px';
                    removeBtn.style.display = 'flex';
                    removeBtn.style.justifyContent = 'center';
                    removeBtn.style.alignItems = 'center';
                    removeBtn.style.cursor = 'pointer';

                    removeBtn.addEventListener('click', () => {
                        // Remove the file from selectedFiles array
                        const fileIndex = selectedFiles.indexOf(file);
                        if (fileIndex > -1) {
                            selectedFiles.splice(fileIndex, 1);
                        }
                        imagePreviewContainer.removeChild(imagePreview);
                        // Re-enable file input if it was disabled
                        imageUpload.disabled = false;
                    });

                    imagePreview.appendChild(previewImg);
                    imagePreview.appendChild(removeBtn);
                    imagePreview.style.position = 'relative';

                    imagePreviewContainer.appendChild(imagePreview);

                    // Check if we've reached the maximum number of images
                    const updatedImageCount = imagePreviewContainer.querySelectorAll('.image-preview').length;
                    if (updatedImageCount >= 3) {
                        imageUpload.disabled = true;
                        window.toast('Maximum of 3 images reached', 'info');
                    }
                };
                reader.readAsDataURL(file);
            });

            // Don't reset file input - keep the files for form submission
            // e.target.value = '';
        });

        // Open Modal
        addEventBtn.addEventListener('click', () => {
            addEventModal.classList.add('active');
            // Reset form and previews
            addEventForm.reset();
            const imagePreviewContainer = document.querySelector('.image-preview-container');
            imagePreviewContainer.innerHTML = '';
            imageUpload.disabled = false;
            selectedFiles = []; // Clear selected files
        });

        // Close Modal Functions
        function closeEventModal() {
            addEventModal.classList.remove('active');
            addEventForm.reset();
            const imagePreviewContainer = document.querySelector('.image-preview-container');
            imagePreviewContainer.innerHTML = '';
            imageUpload.disabled = false;
            selectedFiles = []; // Clear selected files
        }

        closeEventModalBtn.addEventListener('click', closeEventModal);
        cancelEventModalBtn.addEventListener('click', closeEventModal);

        // Close modal when clicking outside
        addEventModal.addEventListener('click', (e) => {
            if (e.target === addEventModal) {
                closeEventModal();
            }
        });

        // Fetch announcements from API
        async function fetchAnnouncements() {
            try {
                const response = await fetch('/api/announcements');
                if (!response.ok) {
                    throw new Error('Failed to fetch announcements');
                }
                const data = await response.json();
                renderAnnouncements(data.docs || []); // Assuming mongoose-paginate returns docs
            } catch (error) {
                console.error('Error fetching announcements:', error);
                window.toast('Failed to load announcements', 'error');
            }
        }

        // Function to render announcements
        function renderAnnouncements(announcements) {
            const announcementsContainer = document.getElementById('announcements');
            announcementsContainer.innerHTML = ''; // Clear existing announcements

            if (!announcements || announcements.length === 0) {
                const noAnnouncementsCard = document.createElement('div');
                noAnnouncementsCard.classList.add('card', 'no-events');
                noAnnouncementsCard.innerHTML = `
                    <div class="no-events-content">
                        <i class="fas fa-bullhorn"></i>
                        <h3>No Announcements Found</h3>
                        <p>There are no announcements at the moment.</p>
                        <button class="btn btn-primary" id="addFirstAnnouncement">
                            <i class="fas fa-plus"></i> Create Your First Announcement
                        </button>
                    </div>
                `;
                announcementsContainer.appendChild(noAnnouncementsCard);

                // Add event listener to the "Create Your First Announcement" button
                document.getElementById('addFirstAnnouncement').addEventListener('click', () => {
                    addAnnouncementModal.classList.add('active');
                });

                return;
            }

            announcements.forEach(announcement => {
                const announcementCard = document.createElement('div');
                announcementCard.classList.add('card');
                announcementCard.innerHTML = `
                    <h3>${announcement.title}</h3>
                    <small>Posted on ${formatDate(announcement.postDate)} by ${announcement.authorName}</small>
                    <p>${announcement.description}</p>
                    <p class="edit" data-announcement-id="${announcement.announcementId}" data-announcement='${JSON.stringify(announcement)}'><i class="fa-solid fa-pen"></i></p>
                    <p class="delete" data-announcement-id="${announcement.announcementId}"><i class="fa-solid fa-trash"></i></p>
                `;
                announcementsContainer.appendChild(announcementCard);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('#announcements .edit').forEach(editBtn => {
                editBtn.addEventListener('click', handleEditAnnouncement);
            });

            document.querySelectorAll('#announcements .delete').forEach(deleteBtn => {
                deleteBtn.addEventListener('click', handleDeleteAnnouncement);
            });
        }

        // Handle edit announcement
        function handleEditAnnouncement(event) {
            const announcementId = event.currentTarget.dataset.announcementId;
            const announcementData = JSON.parse(event.currentTarget.dataset.announcement);
            openEditAnnouncementModal(announcementData);
        }

        // Handle delete announcement
        async function handleDeleteAnnouncement(event) {
            const announcementId = event.currentTarget.dataset.announcementId;
            
            const confirmed = await window.confirmDialog({
                title: 'Delete Announcement',
                message: 'Are you sure you want to delete this announcement? This action cannot be undone.',
                type: 'delete'
            });

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/announcements/${announcementId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    window.toast('Announcement deleted successfully', 'success');
                    fetchAnnouncements(); // Refresh announcements list
                } else {
                    const errorData = await response.json();
                    window.toast(errorData.message || 'Failed to delete announcement', 'error');
                }
            } catch (error) {
                console.error('Error deleting announcement:', error);
                window.toast('An error occurred while deleting the announcement', 'error');
            }
        }

        // Add Announcement Modal Functionality
        const addAnnouncementBtn = document.querySelector('#announcementSearch .add-btn');
        const addAnnouncementModal = document.getElementById('addAnnouncementModal');
        const closeAnnouncementModalBtn = document.getElementById('closeAnnouncementModal');
        const cancelAnnouncementModalBtn = document.getElementById('cancelAnnouncementModal');
        const addAnnouncementForm = document.getElementById('addAnnouncementForm');

        // Open Announcement Modal
        addAnnouncementBtn.addEventListener('click', () => {
            addAnnouncementModal.classList.add('active');
        });

        // Close Announcement Modal Functions
        function closeAnnouncementModal() {
            addAnnouncementModal.classList.remove('active');
            addAnnouncementForm.reset();
        }

        closeAnnouncementModalBtn.addEventListener('click', closeAnnouncementModal);
        cancelAnnouncementModalBtn.addEventListener('click', closeAnnouncementModal);

        // Close modal when clicking outside
        addAnnouncementModal.addEventListener('click', (e) => {
            if (e.target === addAnnouncementModal) {
                closeAnnouncementModal();
            }
        });

        // Submit Announcement Form
        addAnnouncementForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get the submit button and disable it with loading state
            const submitBtn = addAnnouncementForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

            // Collect form data
            const formData = {
                title: document.getElementById('announcementTitle').value,
                description: document.getElementById('announcementDescription').value,
                authorName: 'Knox Barbell Admin' // TODO: Replace with actual logged-in user's name
            };

            try {
                console.log('Creating announcement with data:', formData); // Debug log

                const response = await fetch('/api/announcements', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status); // Debug log

                // Get the response text first
                const responseText = await response.text();
                console.log('Raw response:', responseText); // Debug log

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('Error parsing response:', parseError);
                    window.toast('Server returned invalid response', 'error');
                    return;
                }

                if (response.ok) {
                    // Show success notification
                    window.toast('Announcement created successfully!', 'success');

                    // Close modal and refresh announcements
                    closeAnnouncementModal();
                    fetchAnnouncements(); // Refresh announcements list
                } else {
                    // Show error notification with more details
                    const errorMessage = result.message || result.error || 'Failed to create announcement';
                    console.error('Server error:', errorMessage);
                    window.toast(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error creating announcement:', error);
                window.toast('An error occurred while creating the announcement', 'error');
            } finally {
                // Re-enable the submit button and restore original text
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Fetch announcements when page loads
        document.addEventListener('DOMContentLoaded', () => {
            fetchAnnouncements();
        });

        // Search functionality for events and announcements
        function setupSearch() {
            const eventSearchInput = document.querySelector('#eventSearch .search-box input');
            const announcementSearchInput = document.querySelector('#announcementSearch .search-box input');

            // Event search
            eventSearchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const events = document.querySelectorAll('#events .card');

                events.forEach(event => {
                    const title = event.querySelector('h3').textContent.toLowerCase();
                    const description = event.querySelector('p:not(.participants):not(.edit):not(.delete)').textContent.toLowerCase();

                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        event.style.display = 'block';
                    } else {
                        event.style.display = 'none';
                    }
                });
            });

            // Announcement search
            announcementSearchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const announcements = document.querySelectorAll('#announcements .card');

                announcements.forEach(announcement => {
                    const title = announcement.querySelector('h3').textContent.toLowerCase();
                    const description = announcement.querySelector('p:not(.edit):not(.delete)').textContent.toLowerCase();

                    if (title.includes(searchTerm) || description.includes(searchTerm)) {
                        announcement.style.display = 'block';
                    } else {
                        announcement.style.display = 'none';
                    }
                });
            });
        }

        // Modify existing DOMContentLoaded event to include search setup
        document.addEventListener('DOMContentLoaded', () => {
            fetchEvents();
            fetchAnnouncements();
            setupSearch();
        });

        // Edit Announcement Modal Elements
        const editAnnouncementModal = document.getElementById('editAnnouncementModal');
        const closeEditAnnouncementModalBtn = document.getElementById('closeEditAnnouncementModal');
        const cancelEditAnnouncementModalBtn = document.getElementById('cancelEditAnnouncementModal');
        const editAnnouncementForm = document.getElementById('editAnnouncementForm');

        // Function to open edit announcement modal
        function openEditAnnouncementModal(announcement) {
            try {
                console.log('Announcement data received:', announcement);

                if (!announcement) {
                    throw new Error('No announcement data received');
                }

                // Populate form with announcement details
                document.getElementById('editAnnouncementId').value = announcement.announcementId;
                document.getElementById('editAnnouncementTitle').value = announcement.title || '';
                document.getElementById('editAnnouncementDescription').value = announcement.description || '';

                // Show modal
                editAnnouncementModal.classList.add('active');
            } catch (error) {
                console.error('Error opening edit announcement modal:', error);
                window.toast('Failed to load announcement details', 'error');
            }
        }

        // Close Edit Announcement Modal Functions
        function closeEditAnnouncementModal() {
            editAnnouncementModal.classList.remove('active');
            editAnnouncementForm.reset();
        }

        closeEditAnnouncementModalBtn.addEventListener('click', closeEditAnnouncementModal);
        cancelEditAnnouncementModalBtn.addEventListener('click', closeEditAnnouncementModal);

        // Close modal when clicking outside
        editAnnouncementModal.addEventListener('click', (e) => {
            if (e.target === editAnnouncementModal) {
                closeEditAnnouncementModal();
            }
        });

        // Handle edit announcement form submission
        editAnnouncementForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const announcementId = document.getElementById('editAnnouncementId').value;
            console.log('Attempting to edit announcement with ID:', announcementId);

            // Get the submit button and disable it with loading state
            const submitBtn = editAnnouncementForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

            const formData = {
                title: document.getElementById('editAnnouncementTitle').value,
                description: document.getElementById('editAnnouncementDescription').value
            };

            try {
                console.log('Sending PUT request to:', `/api/announcements/${announcementId}`);
                const response = await fetch(`/api/announcements/${announcementId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);

                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }

                if (response.status === 404) {
                    window.toast('Announcement not found. It may have been deleted.', 'error');
                    closeEditAnnouncementModal();
                    fetchAnnouncements();
                    return;
                }

                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    window.toast('Announcement updated successfully!', 'success');
                    closeEditAnnouncementModal();
                    fetchAnnouncements();
                } else {
                    window.toast(result.message || 'Failed to update announcement', 'error');
                }
            } catch (error) {
                console.error('Error updating announcement:', error);
                window.toast('An error occurred while updating the announcement', 'error');
            } finally {
                // Re-enable the submit button and restore original text
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    
    
            // Notification Modal Logic
            document.addEventListener('DOMContentLoaded', function() {
            const notificationIcon = document.querySelector('.notification');
            const notificationModal = document.querySelector('.notification-modal');
            const closeNotifications = document.querySelector('.close-notifications');
            const notificationList = document.querySelector('.notification-list');
            const notificationBadge = document.querySelector('.notification-badge');

            // Toggle notification modal
            notificationIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationModal.classList.toggle('active');
                if (notificationModal.classList.contains('active')) {
                    fetchNotifications();
                }
            });

            // Close notification modal
            closeNotifications.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationModal.classList.remove('active');
            });

            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                if (!notificationModal.contains(e.target) && !notificationIcon.contains(e.target)) {
                    notificationModal.classList.remove('active');
                }
            });

            // Fetch unread count
            async function fetchUnreadCount() {
                try {
                    const response = await fetch(`${baseUrl}/api/notifications/unread-count`);
                    const data = await response.json();
                    if (data.success) {
                        notificationBadge.textContent = data.data.unreadCount;
                        // Show/hide badge based on count
                        notificationBadge.style.display = data.data.unreadCount > 0 ? 'flex' : 'none';
                    }
                } catch (error) {
                    console.error('Error fetching unread count:', error);
                }
            }

            // Fetch notifications from API
            async function fetchNotifications() {
                try {
                    notificationList.innerHTML = `
                        <div class="notification-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                        </div>
                    `;

                    const response = await fetch(`${baseUrl}/api/notifications`);
                    const data = await response.json();

                    if (data.success) {
                        const notifications = data.data;
                        
                        if (notifications.length === 0) {
                            notificationList.innerHTML = `
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>No new notifications</p>
                                </div>
                            `;
                            return;
                        }

                        // Render notifications
                        notificationList.innerHTML = notifications.map(notif => `
                            <div class="notification-item ${notif.status === 'unread' ? 'unread' : ''}" 
                                 data-notification-id="${notif._id}">
                                <div class="notification-title">
                                    ${notif.title}
                                    ${notif.status === 'unread' ? '<span class="unread-dot"></span>' : ''}
                                </div>
                                <div class="notification-message">${notif.message}</div>
                                <div class="notification-time">${new Date(notif.createdAt).toLocaleString()}</div>
                            </div>
                        `).join('');

                        // Add click handler to mark notifications as read
                        const notificationItems = document.querySelectorAll('.notification-item');
                        notificationItems.forEach(item => {
                            item.addEventListener('click', async () => {
                                const notificationId = item.dataset.notificationId;
                                if (item.classList.contains('unread')) {
                                    try {
                                        const response = await fetch(`${baseUrl}/api/notifications/${notificationId}/read`, {
                                            method: 'PATCH',
                                            credentials: 'include'
                                        });
                                        
                                        if (response.ok) {
                                            // Update UI
                                            item.classList.remove('unread');
                                            const unreadDot = item.querySelector('.unread-dot');
                                            if (unreadDot) unreadDot.remove();
                                            
                                            // Update unread count
                                            await fetchUnreadCount();
                                        }
                                    } catch (error) {
                                        console.error('Error marking notification as read:', error);
                                    }
                                }

                                // Close notification modal
                                notificationModal.classList.remove('active');

                                // Redirect to application page
                                window.location.href = '/application';
                            });
                        });
                    } else {
                        throw new Error(data.message || 'Failed to fetch notifications');
                    }
                } catch (error) {
                    console.error('Error fetching notifications:', error);
                    notificationList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Failed to load notifications</p>
                        </div>
                    `;
                }
            }

            // Initial fetch of notifications and unread count
            fetchNotifications();
            fetchUnreadCount();

            // Refresh unread count periodically
            setInterval(fetchUnreadCount, 30000); // Every 30 seconds
        });
    
    
    </script>

    <script src="/js/main.js"></script>
    <script src="./js/logout.js"></script>
</body>

</html>