<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knox Barbell - Locker Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/trainer.css">
</head>

<body>
    <!-- sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Knox Barbell</h3>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                    <div class="tooltip">Dashboard</div>
                </a>
            </li>
            <li>
                <a href="/members">
                    <i class="fas fa-user"></i>
                    <span>Member</span>
                    <div class="tooltip">Member</div>
                </a>
            </li>
            <li>
                <a href="/application">
                    <i class="fa-solid fa-file-lines"></i>
                    <span>Application</span>
                    <div class="tooltip">Application</div>
                </a>
            </li>
            <li>
                <a href="/membership">
                    <i class="fas fa-id-card"></i>
                    <span>Membership</span>
                    <div class="tooltip">Membership</div>
                </a>
            </li>
            <li>
                <a href="/trainers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Trainers</span>
                    <div class="tooltip">Trainers</div>
                </a>
            </li>
            <li>
                <a href="/employee">
                    <i class="fas fa-users"></i>
                    <span>Employee</span>
                    <div class="tooltip">Employee</div>
                </a>
            </li>

            <li>
                <a href="/notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <div class="tooltip">Notifications</div>
                </a>
            </li>
            <li>
                <a href="/attendance">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                    <div class="tooltip">Attendance</div>
                </a>
            </li>
            <li>
                <a href="/events">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                    <div class="tooltip">Events</div>
                </a>
            </li>
            <li>
                <a href="/finance">
                    <i class="fas fa-wallet"></i>
                    <span>Finance</span>
                    <div class="tooltip">Finance</div>
                </a>
            </li>
            <li>
                <a href="/locker" class="active">
                    <i class="fas fa-lock"></i>
                    <span>Locker</span>
                    <div class="tooltip">Locker</div>
                </a>
            </li>
            <li>
                <a href="/product">
                    <i class="fas fa-box"></i>
                    <span>Product</span>
                    <div class="tooltip">Product</div>
                </a>
            </li>
            <li class="logout-item">
                <a href="#" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                    <div class="tooltip">Logout</div>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Locker Management</h3>
            </div>
            <div class="topbar-right">
                <!-- notification  -->
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">0</span>

                    <!-- Notification Modal -->
                    <div class="notification-modal">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <a href="/notifications" class="view-all-link">View All</a>
                                <button class="close-notifications">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be populated here -->
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-greeting">
                    <img src="/img/Knox Logo-01.png" alt="User">
                    <span>Hello, Knox Barbell</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- header -->
            <div class="content-header">
                <h1>Locker Management</h1>
                <button id="assignLockerBtn">
                    <span><i class="fa-solid fa-plus"></i></span>
                    <p>Assign Locker</p>
                </button>
            </div>
            <!-- filter -->
            <div class="filter-group">
                <select id="lockerStatusFilter">
                    <option value="">All Statuses</option>
                    <option value="assigned">Assigned</option>
                    <option value="unassigned">Unassigned</option>
                </select>
                <button id="resetLockerFilters" title="Reset Filters">
                    <i class="fa-solid fa-rotate"></i>
                </button>
                <button id="downloadLockers" title="Download CSV">
                    <i class="fa-solid fa-download"></i>
                </button>
                <button id="printLockers" title="Print">
                    <i class="fa-solid fa-print"></i>
                </button>
            </div>

            <!-- Locker Assignments Table -->
            <div class="container">
                <div class="table-container">
                    <table class="trainer-table">
                        <thead>
                            <tr>
                                <th>S.N</th>
                                <th>Member ID</th>
                                <th>Member Name</th>
                                <th>Member Email</th>
                                <th>Locker Number</th>
                                <th>Assigned Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center">Loading locker assignments...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div class="pagination-controls">
                    <button id="prevPage" class="pagination-btn" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextPage" class="pagination-btn" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Locker Modal -->
    <div class="modal-overlay" id="assignLockerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Assign Locker to Member</h2>
                    <p>Search and select a member to assign a locker.</p>
                </div>
            </div>
            <form id="assignLockerForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="memberSearch">Search Members</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="memberSearch" placeholder="Search by member ID, name, or email..." autocomplete="off">
                            <div class="search-results" id="memberSearchResults"></div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Selected Member</label>
                        <div id="selectedMemberInfo" class="selected-member-info" style="display: none;">
                            <div class="member-card">
                                <div class="member-details">
                                    <strong id="selectedMemberName"></strong>
                                    <span id="selectedMemberId"></span>
                                    <span id="selectedMemberEmail"></span>
                                </div>
                                <button type="button" id="removeSelectedMember" class="btn btn-secondary">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="lockerNumber">Locker Number</label>
                        <input type="text" id="lockerNumber" required placeholder="e.g., 101" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="paymentAmount">Payment Amount</label>
                        <input type="number" id="paymentAmount" required placeholder="e.g., 500" min="0" step="0.01" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="paymentMethod">Payment Method</label>
                        <select id="paymentMethod" required>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="bank">Bank Transfer</option>
                            <option value="online_payment">Online Payment</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAssignLockerBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitAssignLockerBtn" disabled>Assign Locker</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script src="./js/logout.js"></script>
    <script>
        // DOM Elements
        const assignLockerBtn = document.getElementById('assignLockerBtn');
        const assignLockerModal = document.getElementById('assignLockerModal');
        const assignLockerForm = document.getElementById('assignLockerForm');
        const cancelAssignLockerBtn = document.getElementById('cancelAssignLockerBtn');
        const lockerTableBody = document.querySelector('.trainer-table tbody');
        const prevPageBtn = document.getElementById("prevPage");
        const nextPageBtn = document.getElementById("nextPage");
        const pageInfo = document.getElementById("pageInfo");

        // Pagination state
        let currentPage = 1;
        let totalPages = 1;
        const itemsPerPage = 10;
        let allLockerAssignments = []; // Store all locker assignments

        // Member assignment variables
        let selectedMember = null;

        // Utility Functions
        const toast = (message, type = 'success') => {
            window.toast(message, type);
        };

        // Fetch and Display Locker Assignments
        async function fetchLockerAssignments(page = 1) {
            try {
                console.log('Fetching locker assignments for page:', page);
                const response = await fetch('/api/members/lockers', {
                    credentials: 'include'
                });
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Locker assignments result:', result);

                if (result.success) {
                    // Store all locker assignments
                    allLockerAssignments = result.data;
                    console.log('All locker assignments:', allLockerAssignments);

                    // Calculate pagination
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedAssignments = allLockerAssignments.slice(startIndex, endIndex);

                    // Calculate total pages
                    totalPages = Math.ceil(allLockerAssignments.length / itemsPerPage);

                    // Render the table with paginated data
                    displayLockerAssignments(paginatedAssignments);

                    // Update pagination
                    updatePagination({
                        currentPage: page,
                        totalPages: totalPages,
                        total: allLockerAssignments.length
                    });
                } else {
                    console.error('Failed to fetch locker assignments:', result.message);
                    lockerTableBody.innerHTML = `<tr><td colspan="8" class="text-center">Error loading locker assignments. Please try again.</td></tr>`;
                    updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
                }
            } catch (error) {
                console.error('Error fetching locker assignments:', error);
                lockerTableBody.innerHTML = `<tr><td colspan="8" class="text-center">Error loading locker assignments. Please try again.</td></tr>`;
                updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
            }
        }

        function updatePagination(paginationData) {
            currentPage = parseInt(paginationData.currentPage) || 1;
            totalPages = parseInt(paginationData.totalPages) || 1;

            pageInfo.textContent = `Page ${currentPage} of ${totalPages} (Total: ${paginationData.total} assignments)`;

            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;

            prevPageBtn.classList.toggle('disabled', currentPage <= 1);
            nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
        }

        // Display Locker Assignments in Table
        function displayLockerAssignments(assignments) {
            lockerTableBody.innerHTML = '';

            if (!assignments || !Array.isArray(assignments) || assignments.length === 0) {
                lockerTableBody.innerHTML = `<tr><td colspan="8" class="text-center">No locker assignments found.</td></tr>`;
                return;
            }

            let rowNumber = (currentPage - 1) * itemsPerPage + 1;
            assignments.forEach((assignment) => {
                if (!assignment || !Array.isArray(assignment.lockers) || assignment.lockers.length === 0) return;
                assignment.lockers.forEach((locker) => {
                    const tr = document.createElement("tr");
                    const assignedDate = locker.assignedDate ? new Date(locker.assignedDate).toLocaleDateString() : 'N/A';
                    tr.innerHTML = `
                        <td>${rowNumber++}</td>
                        <td>${assignment.memberId || 'N/A'}</td>
                        <td>${assignment.fullName || 'N/A'}</td>
                        <td>${assignment.email || 'N/A'}</td>
                        <td>${locker.lockerNumber || 'N/A'}</td>
                        <td>${assignedDate}</td>
                        <td>
                            <span class="status active">
                                Assigned
                            </span>
                        </td>
                        <td>
                            <button class="action-btn delete" data-member-id="${assignment.memberId || ''}" ${!assignment.memberId ? 'disabled' : ''} title="Remove Locker">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    lockerTableBody.appendChild(tr);
                });
            });

            attachLockerActionListeners();
        }

        // Attach Action Listeners for Locker Table
        function attachLockerActionListeners() {
            document.querySelectorAll('.trainer-table .action-btn.delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    const memberId = btn.getAttribute('data-member-id');
                    if (memberId) {
                        showLockerConfirmationDialog(memberId);
                    }
                });
            });
        }

        // Show Confirmation Dialog for Locker Removal
        function showLockerConfirmationDialog(memberId) {
            window.confirmDialog({
                title: 'Remove Locker Assignment',
                message: 'Are you sure you want to remove this locker assignment? This action cannot be undone.',
                type: 'delete'
            }).then(confirmed => {
                if (confirmed) {
                    removeLockerFromMember(memberId);
                }
            });
        }

        // Remove Locker from Member
        async function removeLockerFromMember(memberId) {
            try {
                const response = await fetch(`/api/members/${memberId}/remove-locker`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                const result = await response.json();

                if (response.ok) {
                    toast('Locker removed successfully!', 'success');
                    fetchLockerAssignments(currentPage); // Refresh current page
                } else {
                    throw new Error(result.message || 'Failed to remove locker');
                }
            } catch (error) {
                console.error('Error removing locker:', error);
                toast(error.message, 'error');
            }
        }

        // Pagination event listeners
        prevPageBtn.addEventListener("click", () => {
            if (currentPage > 1) {
                fetchLockerAssignments(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
                fetchLockerAssignments(currentPage + 1);
            }
        });

        // Filter event listeners
        document.getElementById('lockerStatusFilter').addEventListener('change', () => {
            currentPage = 1;
            fetchLockerAssignments(currentPage);
        });

        document.getElementById('resetLockerFilters').addEventListener('click', () => {
            currentPage = 1;
            document.getElementById('lockerStatusFilter').value = '';
            fetchLockerAssignments(1);
            toast('Filters have been reset', 'info');
        });

        // Modal Handling
        assignLockerBtn.addEventListener('click', function () {
            resetAssignLockerModal();
            assignLockerModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        cancelAssignLockerBtn.addEventListener('click', function () {
            assignLockerModal.classList.remove('active');
            document.body.style.overflow = '';
        });

        // Close modal when clicking outside
        assignLockerModal.addEventListener('click', function (e) {
            if (e.target === assignLockerModal) {
                assignLockerModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // Reset Assign Locker Modal
        function resetAssignLockerModal() {
            assignLockerForm.reset();
            document.getElementById('memberSearch').value = '';
            document.getElementById('memberSearchResults').innerHTML = '';
            document.getElementById('selectedMemberInfo').style.display = 'none';
            document.getElementById('submitAssignLockerBtn').disabled = true;
            selectedMember = null;
        }

        // Member Search Functionality
        document.getElementById('memberSearch').addEventListener('input', function (e) {
            const query = e.target.value.trim();
            searchMembers(query);
        });

        document.getElementById('removeSelectedMember').addEventListener('click', function () {
            removeSelectedMember();
        });

        // Search members
        async function searchMembers(query) {
            if (!query || query.length < 2) {
                document.getElementById('memberSearchResults').innerHTML = '';
                document.getElementById('memberSearchResults').classList.remove('active');
                return;
            }

            try {
                const response = await fetch(`/api/members/search?q=${encodeURIComponent(query)}`, {
                    credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                    displayMemberSearchResults(result.data);
                } else {
                    document.getElementById('memberSearchResults').innerHTML = '<div class="search-result-item">No members found</div>';
                    document.getElementById('memberSearchResults').classList.add('active');
                }
            } catch (error) {
                console.error('Error searching members:', error);
                document.getElementById('memberSearchResults').innerHTML = '<div class="search-result-item">Error searching members</div>';
                document.getElementById('memberSearchResults').classList.add('active');
            }
        }

        // Display member search results
        function displayMemberSearchResults(members) {
            const resultsContainer = document.getElementById('memberSearchResults');

            if (!members || members.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No members found</div>';
                resultsContainer.classList.add('active');
                return;
            }

            const resultsHTML = members.map(member => `
                <div class="search-result-item" data-member-id="${member.memberId}" data-member-name="${member.fullName}" data-member-email="${member.email}">
                    <div class="member-name">${member.fullName}</div>
                    <div class="member-details">${member.memberId} • ${member.email}</div>
                </div>
            `).join('');

            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.classList.add('active');

            // Add click listeners to search results
            resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectMember({
                        memberId: item.dataset.memberId,
                        fullName: item.dataset.memberName,
                        email: item.dataset.memberEmail
                    });
                });
            });
        }

        // Select member from search results
        function selectMember(member) {
            selectedMember = member;

            // Update selected member info
            document.getElementById('selectedMemberName').textContent = member.fullName;
            document.getElementById('selectedMemberId').textContent = member.memberId;
            document.getElementById('selectedMemberEmail').textContent = member.email;

            // Show selected member info
            document.getElementById('selectedMemberInfo').style.display = 'block';

            // Hide search results
            document.getElementById('memberSearchResults').classList.remove('active');

            // Enable assign button
            document.getElementById('submitAssignLockerBtn').disabled = false;
        }

        // Remove selected member
        function removeSelectedMember() {
            selectedMember = null;
            document.getElementById('selectedMemberInfo').style.display = 'none';
            document.getElementById('submitAssignLockerBtn').disabled = true;
        }

        // Assign Locker Form Submission
        assignLockerForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!selectedMember) {
                toast('Please select a member first', 'error');
                return;
            }

            const lockerNumber = document.getElementById('lockerNumber').value.trim();
            const paymentAmount = parseFloat(document.getElementById('paymentAmount').value.trim());
            const paymentMethod = document.getElementById('paymentMethod').value.trim();

            if (!lockerNumber || !paymentAmount || !paymentMethod || isNaN(paymentAmount) || paymentAmount <= 0) {
                toast('Please fill in all fields with valid values', 'error');
                return;
            }

            try {
                const requestData = {
                    lockerNumber: lockerNumber,
                    paymentAmount: paymentAmount,
                    paymentMethod: paymentMethod
                };
                
                console.log('Sending locker assignment request:', requestData);
                console.log('Selected member:', selectedMember);

                const response = await fetch(`/api/members/${selectedMember.memberId}/assign-locker`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response result:', result);

                if (response.ok) {
                    toast('Locker assigned successfully!', 'success');
                    assignLockerModal.classList.remove('active');
                    document.body.style.overflow = '';
                    resetAssignLockerModal();
                    fetchLockerAssignments(currentPage); // Refresh current page
                } else {
                    throw new Error(result.message || 'Failed to assign locker');
                }
            } catch (error) {
                console.error('Error assigning locker:', error);
                toast(error.message, 'error');
            }
        });

        // Update CSV and print logic to flatten all lockers per member
        document.getElementById('downloadLockers').addEventListener('click', () => {
            if (allLockerAssignments.length === 0) {
                toast('No locker data to download', 'error');
                return;
            }
            const headers = ['S.N', 'Member ID', 'Member Name', 'Member Email', 'Locker Number', 'Assigned Date', 'Status'];
            let csvRows = [headers.join(',')];
            let sn = 1;
            allLockerAssignments.forEach(assignment => {
                if (Array.isArray(assignment.lockers)) {
                    assignment.lockers.forEach(locker => {
                        csvRows.push([
                            sn++,
                            assignment.memberId,
                            assignment.fullName,
                            assignment.email,
                            locker.lockerNumber || 'N/A',
                            locker.assignedDate ? formatDate(locker.assignedDate) : 'N/A',
                            'Assigned'
                        ].join(','));
                    });
                }
            });
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const date = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `locker_assignments_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('printLockers').addEventListener('click', () => {
            if (allLockerAssignments.length === 0) {
                toast('No locker data to print', 'error');
                return;
            }
            let sn = 1;
            let rows = '';
            allLockerAssignments.forEach(assignment => {
                if (Array.isArray(assignment.lockers)) {
                    assignment.lockers.forEach(locker => {
                        rows += `
                            <tr>
                                <td>${sn++}</td>
                                <td>${assignment.memberId}</td>
                                <td>${assignment.fullName}</td>
                                <td>${assignment.email}</td>
                                <td>${locker.lockerNumber || 'N/A'}</td>
                                <td>${locker.assignedDate ? formatDate(locker.assignedDate) : 'N/A'}</td>
                                <td>Assigned</td>
                            </tr>
                        `;
                    });
                }
            });
            const printWindow = window.open('', '_blank');
            const printContent = `
                <html>
                <head>
                    <title>Locker Assignments Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f5f5f5; }
                        h1 { text-align: center; }
                        .header { margin-bottom: 20px; }
                        .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Locker Assignments Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>S.N</th>
                                <th>Member ID</th>
                                <th>Member Name</th>
                                <th>Member Email</th>
                                <th>Locker Number</th>
                                <th>Assigned Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>© ${new Date().getFullYear()} Knox Barbell - Locker Assignments Report</p>
                    </div>
                </body>
                </html>
            `;
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.onload = function () {
                printWindow.print();
                printWindow.close();
            };
            toast('Printing locker assignments...', 'success');
        });

        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Initial fetch of locker assignments
        fetchLockerAssignments(1);
    </script>
</body>

</html>