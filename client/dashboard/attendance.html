<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knox Barbell - Attendance</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/attendance.css">
  <!-- Add SheetJS library for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Knox Barbell</h3>
      <button class="toggle-btn" id="toggleSidebar">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <a href="/dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
          <div class="tooltip">Dashboard</div>
        </a>
      </li>
      <li>
        <a href="/members">
          <i class="fas fa-user"></i>
          <span>Member</span>
          <div class="tooltip">Member</div>
        </a>
      </li>
      <li>
        <a href="/application">
          <i class="fa-solid fa-file-lines"></i>
          <span>Application</span>
          <div class="tooltip">Application</div>
        </a>
      </li>
      <li>
        <a href="/membership">
          <i class="fas fa-id-card"></i>
          <span>Membership</span>
          <div class="tooltip">Membership</div>
        </a>
      </li>
      <li>
        <a href="/trainers">
          <i class="fas fa-chalkboard-teacher"></i>
          <span>Trainers</span>
          <div class="tooltip">Trainers</div>
        </a>
      </li>
      <li>
        <a href="/employee">
          <i class="fas fa-users"></i>
          <span>Employee</span>
          <div class="tooltip">Employee</div>
        </a>
      </li>
      <li>
        <a href="/notifications">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
          <div class="tooltip">Notifications</div>
        </a>
      </li>
      <li>
        <a href="/attendance" class="active">
          <i class="fas fa-calendar-check"></i>
          <span>Attendance</span>
          <div class="tooltip">Attendance</div>
        </a>
      </li>
      <li>
        <a href="/events">
          <i class="fas fa-calendar-alt"></i>
          <span>Events</span>
          <div class="tooltip">Events</div>
        </a>
      </li>
      <li>
        <a href="/finance">
          <i class="fas fa-wallet"></i>
          <span>Finance</span>
          <div class="tooltip">Finance</div>
        </a>
      </li>
      <li>
        <a href="/product">
          <i class="fas fa-box"></i>
          <span>Product</span>
          <div class="tooltip">Product</div>
        </a>
      </li>
      <li class="logout-item">
        <a href="#" id="logoutButton">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
          <div class="tooltip">Logout</div>
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="mobile-toggle" id="mobileToggle">
          <i class="fas fa-bars"></i>
        </button>
        <h3>Attendance</h3>
      </div>
      <div class="topbar-right">
        <!-- notification  -->
        <div class="notification">
          <i class="fas fa-bell"></i>
          <span class="notification-badge">0</span>

          <!-- Notification Modal -->
          <div class="notification-modal">
            <div class="notification-header">
              <h3>Notifications</h3>
              <div class="notification-actions">
                <a href="/notifications" class="view-all-link">View All</a>
                <button class="close-notifications">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <div class="notification-list">
              <!-- Notifications will be populated here -->
              <div class="notification-loading">
                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
              </div>
            </div>
          </div>
        </div>
        <div class="user-greeting">
          <img src="/img/Knox Logo-01.png" alt="User">
          <span>Hello, Knox Barbell</span>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <!-- Header -->
      <div class="content-header">
        <h1>Attendance Overview</h1>
        <button id="addAttendanceBtn">
          <span>+</span>
          <p>Mark Attendance</p>
        </button>
      </div>


      <!-- Info Boxes -->
      <div class="info-boxes">
        <!-- Total Members coount -->
        <div class="info-box">
          <div class="info-box-icon members">
            <i class="fas fa-users"></i>
          </div>
          <span class="info-box-title">Total Members</span>
          <p class="info-box-number">0</p>
        </div>
        <!-- Check-in-Today -->
        <div class="info-box">
          <div class="info-box-icon attendance">
            <i class="fas fa-calendar-check"></i>
          </div>
          <span class="info-box-title">Checks-in-today</span>
          <p class="info-box-number">0</p>
        </div>
        <!-- Current Date -->
        <div class="info-box">
          <div class="info-box-icon events">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <span class="info-box-title">Date</span>
          <p class="info-box-number">--/--/----</p>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filters">
        <!-- calander date filter -->
        <div class="filter-group date-box">
          <input type="date" id="filterDate">
        </div>

        <!-- search -->
        <div class="filter-group search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchAttendance" placeholder="Search Member..." autocomplete="off">
        </div>
        <!--  -->
        <div class="filter-group download-filter">
          <!-- Select last day filter -->
          <select name="download-filter" id="filterDownload">
            <option value="today" selected>Today</option>
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="365">Last 12 Months</option>
          </select>

          <!-- download in CSV -->
          <button class="download" id="downloadAttendance" title="Download CSV">
            <i class="fa-solid fa-download"></i>
          </button>
          <button class="print" id="printAttendance" title="Print">
            <i class="fa-solid fa-print"></i>
          </button>
          <!-- Reset Filters Button -->
          <button class="reset" id="resetFilters" title="Reset Filters">
            <i class="fa-solid fa-rotate"></i>
          </button>
        </div>
      </div>


      <!-- Member Attendance table -->
      <div class="table-container">
        <table class="members-table">
          <thead>
            <tr>
              <th>S.N</th>
              <th>ID</th>
              <th>Full Name</th>
              <th>Email Id</th>
              <th>Check-In-Time</th>
              <th>Date</th>
              <th>Check-Out-Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>
                <button class="action-btn delete" data-member-id="${attendance.member.memberId}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-controls">
        <button id="prevPage" class="pagination-btn" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" class="pagination-btn" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Add Attendance Modal -->
  <div class="modal-overlay" id="addAttenModal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Mark New Attendance</h2>
          <p id="modalSubtitle">Fill in the details to mark a new attendance.</p>
        </div>
      </div>
      <form id="attenForm">
        <input type="hidden" id="attendanceMode" value="add">
        <input type="hidden" id="selectedMemberId" name="selectedMemberId">
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="attenSearch">Search Member</label>
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="attenSearch" name="attenSearch" placeholder="Search by name or ID..."
                autocomplete="off" required>
              <div class="search-result-container"></div>
            </div>
          </div>
          <div class="form-group full-width">
            <label for="time">Check-In-Time</label>
            <input type="time" id="time" name="checkInTime">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitAttendanceBtn">Mark Attendance</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation Dialog Modal -->
  <div class="modal-overlay" id="confirmationModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 id="confirmationTitle">Confirm Action</h2>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <p id="confirmationMessage">Are you sure you want to proceed with this action?</p>
      </div>
      <div class="form-actions" style="justify-content: center; gap: 20px;">
        <button type="button" class="btn btn-secondary" id="cancelAction">Cancel</button>
        <button type="button" class="btn" id="confirmAction" style="transition: all 0.3s ease;">Confirm</button>
      </div>
    </div>
  </div>

  <script>

    // Notification Modal Logic
    document.addEventListener('DOMContentLoaded', function () {
      const notificationIcon = document.querySelector('.notification');
      const notificationModal = document.querySelector('.notification-modal');
      const closeNotifications = document.querySelector('.close-notifications');
      const notificationList = document.querySelector('.notification-list');
      const notificationBadge = document.querySelector('.notification-badge');

      // Toggle notification modal
      notificationIcon.addEventListener('click', function (e) {
        e.stopPropagation();
        notificationModal.classList.toggle('active');
        if (notificationModal.classList.contains('active')) {
          fetchNotifications();
        }
      });

      // Close notification modal
      closeNotifications.addEventListener('click', function (e) {
        e.stopPropagation();
        notificationModal.classList.remove('active');
      });

      // Close modal when clicking outside
      document.addEventListener('click', function (e) {
        if (!notificationModal.contains(e.target) && !notificationIcon.contains(e.target)) {
          notificationModal.classList.remove('active');
        }
      });

      // Fetch unread count
      async function fetchUnreadCount() {
        try {
          const response = await fetch(`${baseUrl}/api/notifications/unread-count`);
          const data = await response.json();
          if (data.success) {
            notificationBadge.textContent = data.data.unreadCount;
            // Show/hide badge based on count
            notificationBadge.style.display = data.data.unreadCount > 0 ? 'flex' : 'none';
          }
        } catch (error) {
          console.error('Error fetching unread count:', error);
        }
      }

      // Fetch notifications from API
      async function fetchNotifications() {
        try {
          notificationList.innerHTML = `
                        <div class="notification-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                        </div>
                    `;

          const response = await fetch(`${baseUrl}/api/notifications`);
          const data = await response.json();

          if (data.success) {
            const notifications = data.data;

            if (notifications.length === 0) {
              notificationList.innerHTML = `
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>No new notifications</p>
                                </div>
                            `;
              return;
            }

            // Render notifications
            notificationList.innerHTML = notifications.map(notif => `
                            <div class="notification-item ${notif.status === 'unread' ? 'unread' : ''}" 
                                 data-notification-id="${notif._id}">
                                <div class="notification-title">
                                    ${notif.title}
                                    ${notif.status === 'unread' ? '<span class="unread-dot"></span>' : ''}
                                </div>
                                <div class="notification-message">${notif.message}</div>
                                <div class="notification-time">${new Date(notif.createdAt).toLocaleString()}</div>
                            </div>
                        `).join('');

            // Add click handler to mark notifications as read
            const notificationItems = document.querySelectorAll('.notification-item');
            notificationItems.forEach(item => {
              item.addEventListener('click', async () => {
                const notificationId = item.dataset.notificationId;
                if (item.classList.contains('unread')) {
                  try {
                    const response = await fetch(`${baseUrl}/api/notifications/${notificationId}/read`, {
                      method: 'PATCH',
                      credentials: 'include'
                    });

                    if (response.ok) {
                      // Update UI
                      item.classList.remove('unread');
                      const unreadDot = item.querySelector('.unread-dot');
                      if (unreadDot) unreadDot.remove();

                      // Update unread count
                      await fetchUnreadCount();
                    }
                  } catch (error) {
                    console.error('Error marking notification as read:', error);
                  }
                }

                // Close notification modal
                notificationModal.classList.remove('active');

                // Redirect to application page
                window.location.href = '/application';
              });
            });
          } else {
            throw new Error(data.message || 'Failed to fetch notifications');
          }
        } catch (error) {
          console.error('Error fetching notifications:', error);
          notificationList.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Failed to load notifications</p>
                        </div>
                    `;
        }
      }

      // Initial fetch of notifications and unread count
      fetchNotifications();
      fetchUnreadCount();

      // Refresh unread count periodically
      setInterval(fetchUnreadCount, 30000); // Every 30 seconds
    });
  </script>
  <script src="/js/main.js"></script>
  <script src="./js/logout.js"></script>
  <script>
    // Modal Elements
    const addAttendanceBtn = document.getElementById('addAttendanceBtn');
    const addAttenModal = document.getElementById('addAttenModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const attenForm = document.getElementById('attenForm');
    const attenSearch = document.getElementById('attenSearch');
    const searchResultContainer = document.querySelector('.search-result-container');
    const timeInput = document.getElementById('time');
    const selectedMemberId = document.getElementById('selectedMemberId');

    // Function to open modal
    function openAttendanceModal() {
      addAttenModal.classList.add('active');
      // Reset form when opening
      attenForm.reset();
      document.getElementById('attendanceMode').value = 'add';
      document.getElementById('modalTitle').textContent = 'Mark New Attendance';
      document.getElementById('modalSubtitle').textContent = 'Fill in the details to mark a new attendance.';
      
      // Set current time
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      timeInput.value = `${hours}:${minutes}`;
    }

    // Function to close modal
    function closeAttendanceModal() {
      addAttenModal.classList.remove('active');
      // Clear search results
      searchResultContainer.innerHTML = '';
      // Clear selected member
      selectedMemberId.value = '';
    }

    // Debounce function to limit API calls
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Function to search members
    async function searchMembers(query) {
      if (!query.trim()) {
        searchResultContainer.innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`${baseUrl}/api/members/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.success) {
          if (data.data.length === 0) {
            searchResultContainer.innerHTML = `
              <div class="search-no-results">
                <i class="fas fa-search"></i>
                <p>No members found</p>
              </div>
            `;
            return;
          }

          searchResultContainer.innerHTML = data.data.map(member => `
            <div class="search-result-item" 
                 data-member-id="${member.memberId}"
                 data-member-name="${member.fullName}">
              <div class="member-info">
                <span class="member-name">${member.fullName}</span>
                <span class="member-id">${member.memberId}</span>
              </div>
              <span class="member-email">${member.email}</span>
            </div>
          `).join('');

          // Add click handlers to search results
          document.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
              const memberId = item.dataset.memberId;
              const memberName = item.dataset.memberName;
              selectedMemberId.value = memberId;
              attenSearch.value = `${memberName} (${memberId})`; // Show both name and ID
              searchResultContainer.innerHTML = '';
            });
          });
        } else {
          searchResultContainer.innerHTML = `
            <div class="search-error">
              <i class="fas fa-exclamation-circle"></i>
              <p>Error searching members</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error searching members:', error);
        searchResultContainer.innerHTML = `
          <div class="search-error">
            <i class="fas fa-exclamation-circle"></i>
            <p>Error searching members</p>
          </div>
        `;
      }
    }

    // Debounced search function
    const debouncedSearch = debounce(searchMembers, 300);

    // Event Listeners for Search
    attenSearch.addEventListener('input', (e) => {
      debouncedSearch(e.target.value);
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!attenSearch.contains(e.target) && !searchResultContainer.contains(e.target)) {
        searchResultContainer.innerHTML = '';
      }
    });

    // Form submit handler
    attenForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!selectedMemberId.value) {
        window.toast('Please select a member', 'error');
        return;
      }

      const submitBtn = document.getElementById('submitAttendanceBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Marking...';

      try {
        // Format the time for the API
        const [hours, minutes] = timeInput.value.split(':');
        const checkInTime = new Date();
        checkInTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

        const response = await fetch(`${baseUrl}/api/attendances/check-in/${selectedMemberId.value}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            time: checkInTime.toISOString()
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          window.toast('Attendance marked successfully', 'success');
          closeAttendanceModal();
          // Refresh the attendance data
          await fetchAttendanceData();
          // Refresh today's check-ins count
          await fetchTodayCheckIns();
        } else {
          // Handle specific error cases
          if (result.message === 'Member already checked in today') {
            window.toast('This member has already checked in today', 'warning');
          } else if (result.message === 'Invalid check-in time') {
            window.toast('Please select a valid check-in time', 'error');
          } else {
            window.toast(result.message || 'Failed to mark attendance', 'error');
          }
        }
      } catch (error) {
        console.error('Error marking attendance:', error);
        window.toast('Error marking attendance. Please try again.', 'error');
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Mark Attendance';
      }
    });

    // Event Listeners for Modal
    addAttendanceBtn.addEventListener('click', openAttendanceModal);
    cancelBtn.addEventListener('click', closeAttendanceModal);

    // Close modal when clicking outside
    addAttenModal.addEventListener('click', (e) => {
      if (e.target === addAttenModal) {
        closeAttendanceModal();
      }
    });

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && addAttenModal.classList.contains('active')) {
        closeAttendanceModal();
      }
    });

    // Function to fetch and update total members count
    async function fetchTotalMembers() {
      try {
        const response = await fetch(`${baseUrl}/api/members`);
        const data = await response.json();

        if (data.success) {
          // Update the total members count in the info box
          const totalMembersElement = document.querySelector('.info-box:first-child .info-box-number');
          totalMembersElement.textContent = data.data.length || 0;
        } else {
          console.error('Failed to fetch members:', data.message);
          window.toast('Failed to fetch members count', 'error');
        }
      } catch (error) {
        console.error('Error fetching members:', error);
        window.toast('Error fetching members count', 'error');
      }
    }

    // Function to fetch today's check-ins
    async function fetchTodayCheckIns() {
      try {
        const today = new Date().toLocaleDateString('en-CA');
        const response = await fetch(`${baseUrl}/api/attendances?date=${today}`);
        const data = await response.json();

        if (data.success) {
          // Count check-ins for today
          const todayCheckIns = data.data.filter(attendance => {
            if (!attendance.checkIn || !attendance.checkIn.time) return false;
            const checkInDate = new Date(attendance.checkIn.time);
            return checkInDate.toLocaleDateString('en-CA') === today;
          }).length;

          // Update the check-ins count in the info box
          const checkInsElement = document.querySelector('.info-box:nth-child(2) .info-box-number');
          checkInsElement.textContent = todayCheckIns;
        }
      } catch (error) {
        console.error('Error fetching today\'s check-ins:', error);
      }
    }

    // Store all attendance data
    let allAttendanceData = [];

    // Helper function to get date range based on filter
    function getDateRange(range) {
      const today = new Date();
      today.setHours(23, 59, 59, 999); // End of today
      const startDate = new Date();
      startDate.setHours(0, 0, 0, 0); // Start of today

      switch (range) {
        case '7':
          startDate.setDate(today.getDate() - 7);
          break;
        case '30':
          startDate.setDate(today.getDate() - 30);
          break;
        case '365':
          startDate.setDate(today.getDate() - 365);
          break;
        default: // today
          // Already set to today
          break;
      }

      return { startDate, endDate: today };
    }

    // Function to fetch and display attendance data
    async function fetchAttendanceData(date = null, dateRange = null) {
      try {
        let url = `${baseUrl}/api/attendances`;
        const params = new URLSearchParams();

        if (dateRange) {
          // If dateRange is provided, use it for fetching data
          const { startDate, endDate } = getDateRange(dateRange);
          params.append('startDate', startDate.toISOString());
          params.append('endDate', endDate.toISOString());
        } else {
          // Otherwise use the specific date or today's date
          const today = new Date().toLocaleDateString('en-CA');
          params.append('date', date || today);
        }

        const response = await fetch(`${url}?${params.toString()}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();

        if (result.success) {
          allAttendanceData = result.data;
          displayAttendanceData(allAttendanceData);
          updateAttendanceCounts(allAttendanceData);
        } else {
          throw new Error(result.message || 'Failed to fetch attendance data');
        }
      } catch (error) {
        console.error('Error fetching attendance data:', error);
        window.toast('Error fetching attendance data. Please refresh the page.', 'error');
      }
    }

    // Function to fetch data for download/print
    async function fetchDataForExport(dateRange) {
      try {
        const url = `${baseUrl}/api/attendances`;
        const params = new URLSearchParams();
        const { startDate, endDate } = getDateRange(dateRange);
        
        params.append('startDate', startDate.toISOString());
        params.append('endDate', endDate.toISOString());

        const response = await fetch(`${url}?${params.toString()}`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.message || 'Failed to fetch data for export');
        }

        return result.data;
      } catch (error) {
        console.error('Error fetching data for export:', error);
        throw error;
      }
    }

    // Function to display attendance data with filters
    function displayAttendanceData(data) {
      const tbody = document.querySelector('.members-table tbody');
      const searchTerm = document.getElementById('searchAttendance').value.toLowerCase().trim();
      const dateFilter = document.getElementById('filterDate').value;
      
      // Filter data based on search term and date
      let filteredData = data;
      
      // Apply date filter if set
      if (dateFilter) {
        const filterDate = new Date(dateFilter).toLocaleDateString('en-CA');
        filteredData = filteredData.filter(attendance => {
          const attendanceDate = new Date(attendance.date).toLocaleDateString('en-CA');
          return attendanceDate === filterDate;
        });
      }
      
      // Apply search filter if search term exists
      if (searchTerm) {
        filteredData = filteredData.filter(attendance => {
          return (
            attendance.member.memberId.toLowerCase().includes(searchTerm) ||
            attendance.member.fullName.toLowerCase().includes(searchTerm) ||
            attendance.member.email.toLowerCase().includes(searchTerm)
          );
        });
      }

      // Store filtered data for download/print
      window.currentFilteredData = filteredData;

      if (filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="no-data">No attendance records found</td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredData.map((attendance, index) => {
        const checkInTime = attendance.checkIn?.time ? new Date(attendance.checkIn.time).toLocaleTimeString() : 'N/A';
        const checkOutTime = attendance.checkOut?.time ? new Date(attendance.checkOut.time).toLocaleTimeString() : 'N/A';
        const date = new Date(attendance.date).toLocaleDateString();
        const isCheckedOut = attendance.checkOut?.time !== null;

        return `
          <tr>
            <td>${index + 1}</td>
            <td>${attendance.member.memberId}</td>
            <td>${attendance.member.fullName}</td>
            <td>${attendance.member.email}</td>
            <td>${checkInTime}</td>
            <td>${date}</td>
            <td>${checkOutTime}</td>
            <td class="action-buttons">
              ${!isCheckedOut ? `
                <button class="action-btn checkout" 
                        data-attendance-id="${attendance._id}" 
                        data-member-id="${attendance.member.memberId}"
                        title="Check Out">
                  <i class="fas fa-sign-out-alt"></i>
                </button>
              ` : `
                <span class="action-icon checked" title="Checked Out">
                  <i class="fas fa-check-circle"></i>
                </span>
              `}
              <button class="action-btn delete" 
                      data-member-id="${attendance.member.memberId}"
                      title="Delete">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      // Reattach event listeners to action buttons
      attachActionListeners();
    }

    // Function to update attendance counts
    function updateAttendanceCounts(data) {
      // Update total members count - fetch from members API instead of attendance data
      fetchTotalMembers();

      // Update today's check-ins count
      const today = new Date().toLocaleDateString('en-CA');
      const todayCheckIns = data.filter(attendance => {
        const attendanceDate = new Date(attendance.date).toLocaleDateString('en-CA');
        return attendanceDate === today;
      }).length;
      const checkInsElement = document.querySelector('.info-box:nth-child(2) .info-box-number');
      checkInsElement.textContent = todayCheckIns;

      // Update current date
      const dateElement = document.querySelector('.info-box:nth-child(3) .info-box-number');
      dateElement.textContent = new Date().toLocaleDateString();
    }

    // Update download filter event listener
    document.getElementById('filterDownload').addEventListener('change', (e) => {
      const dateRange = e.target.value;
      fetchAttendanceData(null, dateRange);
    });

    // Update date filter event listener
    document.getElementById('filterDate').addEventListener('change', (e) => {
      const selectedDate = e.target.value;
      // Reset the days filter when using date filter
      document.getElementById('filterDownload').value = 'today';
      if (selectedDate) {
        fetchAttendanceData(selectedDate);
      } else {
        fetchAttendanceData(); // Fetch today's data if no date selected
      }
    });

    // Update reset filters
    document.getElementById('resetFilters').addEventListener('click', () => {
      // Reset date filter
      document.getElementById('filterDate').value = '';
      // Reset search input
      document.getElementById('searchAttendance').value = '';
      // Reset download filter
      document.getElementById('filterDownload').value = 'today';
      // Refresh the display with today's data
      fetchAttendanceData();
      window.toast('Filters have been reset', 'info');
    });

    // Update download button event listener
    document.getElementById('downloadAttendance').addEventListener('click', async () => {
      try {
        const dateRange = document.getElementById('filterDownload').value;
        const exportData = await fetchDataForExport(dateRange);

        if (!exportData || exportData.length === 0) {
          window.toast('No attendance data to download', 'error');
          return;
        }

        // Create CSV content
        const headers = ['S.N', 'Member ID', 'Full Name', 'Email', 'Check-In Time', 'Date', 'Check-Out Time'];
        const csvContent = [
          headers.join(','),
          ...exportData.map((attendance, index) => [
            index + 1,
            attendance.member.memberId,
            attendance.member.fullName,
            attendance.member.email,
            formatTime(attendance.checkIn?.time),
            formatDate(attendance.date),
            formatTime(attendance.checkOut?.time)
          ].join(','))
        ].join('\n');

        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];
        
        // Create filename based on date range
        let filename = 'attendance_report';
        if (dateRange !== 'today') {
          filename += `_last_${dateRange}_days`;
        }
        filename += `_${date}.csv`;

        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        window.toast('Attendance report downloaded successfully', 'success');
      } catch (error) {
        console.error('Error downloading attendance:', error);
        window.toast('Failed to download attendance report', 'error');
      }
    });

    // Update print button event listener
    document.getElementById('printAttendance').addEventListener('click', async () => {
      try {
        const dateRange = document.getElementById('filterDownload').value;
        const exportData = await fetchDataForExport(dateRange);

        if (!exportData || exportData.length === 0) {
          window.toast('No attendance data to print', 'error');
          return;
        }

        // Create print window
        const printWindow = window.open('', '_blank');

        // Create print content
        const printContent = `
          <html>
          <head>
            <title>Attendance Report</title>
            <style>
              body { font-family: Arial, sans-serif; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f5f5f5; }
              h1 { text-align: center; }
              .header { margin-bottom: 20px; }
              .footer { margin-top: 20px; text-align: center; font-size: 12px; }
              .filters { margin-bottom: 20px; text-align: center; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Attendance Report</h1>
              <div class="filters">
                ${dateRange !== 'today' ? `<p>Period: Last ${dateRange} days</p>` : ''}
                <p>Generated on: ${new Date().toLocaleString()}</p>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th>S.N</th>
                  <th>Member ID</th>
                  <th>Full Name</th>
                  <th>Email</th>
                  <th>Check-In Time</th>
                  <th>Date</th>
                  <th>Check-Out Time</th>
                </tr>
              </thead>
              <tbody>
                ${exportData.map((attendance, index) => `
                  <tr>
                    <td>${index + 1}</td>
                    <td>${attendance.member.memberId}</td>
                    <td>${attendance.member.fullName}</td>
                    <td>${attendance.member.email}</td>
                    <td>${formatTime(attendance.checkIn?.time)}</td>
                    <td>${formatDate(attendance.date)}</td>
                    <td>${formatTime(attendance.checkOut?.time)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <div class="footer">
              <p>© ${new Date().getFullYear()} Knox Barbell - Attendance Report</p>
            </div>
          </body>
          </html>
        `;

        // Write content to print window
        printWindow.document.write(printContent);
        printWindow.document.close();

        // Wait for content to load then print
        printWindow.onload = function () {
          printWindow.print();
          printWindow.close();
        };

        window.toast('Printing attendance report...', 'success');
      } catch (error) {
        console.error('Error printing attendance:', error);
        window.toast('Failed to print attendance report', 'error');
      }
    });

    // Update search event listener to work with current data
    document.getElementById('searchAttendance').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase().trim();
      displayAttendanceData(allAttendanceData);
    });

    // Helper function to format date
    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // Helper function to format time
    function formatTime(timeString) {
      if (!timeString) return 'N/A';
      const date = new Date(timeString);
      return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
    }

    // Function to attach event listeners to action buttons
    function attachActionListeners() {
      document.querySelectorAll('.action-btn').forEach(button => {
        button.addEventListener('click', async (e) => {
          const attendanceId = e.currentTarget.dataset.attendanceId;
          
          if (e.currentTarget.classList.contains('checkout')) {
            const memberId = e.currentTarget.dataset.memberId;
            const confirmed = await window.confirmDialog({
              title: 'Check Out Member',
              message: 'Are you sure you want to check out this member?',
              type: 'info'
            });

            if (confirmed) {
              try {
                const response = await fetch(`${baseUrl}/api/attendances/check-out/${memberId}`, {
                  method: 'POST',
                  credentials: 'include',
                  headers: {
                    'Content-Type': 'application/json'
                  }
                });
                const result = await response.json();

                if (result.success) {
                  window.toast('Member checked out successfully', 'success');
                  // Refresh the attendance data
                  fetchAttendanceData(document.getElementById('filterDate').value || null);
                } else {
                  window.toast(result.message || 'Failed to check out member', 'error');
                }
              } catch (error) {
                console.error('Error checking out member:', error);
                window.toast('Error checking out member', 'error');
              }
            }
          } else if (e.currentTarget.classList.contains('delete')) {
            const memberId = e.currentTarget.dataset.memberId;
            const confirmed = await window.confirmDialog({
              title: 'Delete Attendance',
              message: 'Are you sure you want to delete this attendance record?',
              type: 'delete'
            });

            if (confirmed) {
              try {
                const response = await fetch(`${baseUrl}/api/attendances/member/${memberId}`, {
                  method: 'DELETE',
                  credentials: 'include'
                });
                const result = await response.json();

                if (result.success) {
                  window.toast('Attendance record deleted successfully', 'success');
                  // Refresh the attendance data
                  fetchAttendanceData(document.getElementById('filterDate').value || null);
                } else {
                  window.toast(result.message || 'Failed to delete attendance record', 'error');
                }
              } catch (error) {
                console.error('Error deleting attendance:', error);
                window.toast('Error deleting attendance record', 'error');
              }
            }
          }
        });
      });
    }

    // Initial load - make sure this runs after DOM is fully loaded
    window.addEventListener('load', () => {
      // Set today's date in the date filter
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filterDate').value = today;
      
      // Fetch initial data
      fetchAttendanceData();
      fetchTotalMembers();
    });
  </script>
</body>
</html>