<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knox Barbell - Attendance</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/attendance.css">
  <!-- Add SheetJS library for XLSX export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Knox Barbell</h3>
      <button class="toggle-btn" id="toggleSidebar">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <a href="/dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
          <div class="tooltip">Dashboard</div>
        </a>
      </li>
      <li>
        <a href="/members">
          <i class="fas fa-user"></i>
          <span>Member</span>
          <div class="tooltip">Member</div>
        </a>
      </li>
      <li>
        <a href="/application">
          <i class="fas fa-user"></i>
          <span>Application</span>
          <div class="tooltip">Application</div>
        </a>
      </li>
      <li>
        <a href="/membership">
          <i class="fas fa-id-card"></i>
          <span>Membership</span>
          <div class="tooltip">Membership</div>
        </a>
      </li>
      <li>
        <a href="/trainers">
          <i class="fas fa-chalkboard-teacher"></i>
          <span>Trainers</span>
          <div class="tooltip">Trainers</div>
        </a>
      </li>
      <li>
        <a href="/employee">
          <i class="fas fa-users"></i>
          <span>Employee</span>
          <div class="tooltip">Employee</div>
        </a>
      </li>
      <li>
        <a href="/notifications">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
          <div class="tooltip">Notifications</div>
        </a>
      </li>
      <li>
        <a href="/attendance" class="active">
          <i class="fas fa-calendar-check"></i>
          <span>Attendance</span>
          <div class="tooltip">Attendance</div>
        </a>
      </li>
      <li>
        <a href="/events">
          <i class="fas fa-calendar-alt"></i>
          <span>Events</span>
          <div class="tooltip">Events</div>
        </a>
      </li>
      <li>
        <a href="/finance">
          <i class="fas fa-wallet"></i>
          <span>Finance</span>
          <div class="tooltip">Finance</div>
        </a>
      </li>
      <li>
        <a href="/product">
          <i class="fas fa-box"></i>
          <span>Product</span>
          <div class="tooltip">Product</div>
        </a>
      </li>
      <li class="logout-item">
        <a href="#" id="logoutButton">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
          <div class="tooltip">Logout</div>
        </a>
      </li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Topbar -->
    <div class="topbar">
      <div class="topbar-left">
        <button class="mobile-toggle" id="mobileToggle">
          <i class="fas fa-bars"></i>
        </button>
        <h3>Attendance</h3>
      </div>
      <div class="topbar-right">
        <div class="notification">
          <i class="fas fa-bell"></i>
          <span class="notification-badge">3</span>
        </div>
        <div class="user-greeting">
          <img src="/img/Knox Logo-01.png" alt="User">
          <span>Hello, Knox Barbell</span>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="content-header">
        <h1>Attendance Overview</h1>
        <button id="addAttendanceBtn">
          <span>+</span>
          <p>Mark Attendance</p>
        </button>
      </div>


      <!-- Info Boxes -->
      <div class="info-boxes">
        <!-- Total Members coount -->
        <div class="info-box">
          <div class="info-box-icon members">
            <i class="fas fa-users"></i>
          </div>
          <span class="info-box-title">Total Members</span>
          <p class="info-box-number">0</p>
        </div>
        <!-- Check-in-Today -->
        <div class="info-box">
          <div class="info-box-icon attendance">
            <i class="fas fa-calendar-check"></i>
          </div>
          <span class="info-box-title">Checks-in-today</span>
          <p class="info-box-number">0</p>
        </div>
        <!-- Current Date -->
        <div class="info-box">
          <div class="info-box-icon events">
            <i class="fas fa-calendar-alt"></i>
          </div>
          <span class="info-box-title">Date</span>
          <p class="info-box-number">--/--/----</p>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filters">
        <!-- calander date filter -->
        <div class="filter-group date-box">
          <input type="date" id="filterDate">
        </div>

        <!-- search -->
        <div class="filter-group search-box">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="Search Member..." autocomplete="off">
        </div>
        <!--  -->
        <div class="filter-group download-filter">

          <!-- Select last day filter -->
          <select name="download-filter" id="filterDownload">
            <option value="today" selected>Today</option>
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="365">Last 12 Months</option>
          </select>

          <!-- download in CSV -->
          <button class="download" id="download"><i class="fa-solid fa-download"></i></button>
          <button class="print" id="print"><i class="fa-solid fa-print"></i></button>
          <!-- Reset Filters Button -->
          <button class="reset" id="resetFilters" title="Reset Filters">
            <i class="fa-solid fa-rotate"></i>
          </button>
        </div>
      </div>


      <!-- Member Attendance Detail -->
      <div class="table-container">
        <table class="members-table">
          <thead>
            <tr>
              <th>S.N</th>
              <th>ID</th>
              <th>Full Name</th>
              <th>Email Id</th>
              <th>Check-In-Time</th>
              <th>Date</th>
              <th>Check-Out-Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>loading...</td>
              <td>
                <button class="action-btn delete" data-member-id="${attendance.member.memberId}">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div class="pagination-controls">
        <button id="prevPage" class="pagination-btn" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span id="pageInfo">Page 1</span>
        <button id="nextPage" class="pagination-btn" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Add Attendance Modal -->
  <div class="modal-overlay" id="addAttenModal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Mark New Attendance</h2>
          <p id="modalSubtitle">Fill in the details to mark a new attendance.</p>
        </div>
      </div>
      <form id="attenForm">
        <input type="hidden" id="attendanceMode" value="add">
        <input type="hidden" id="selectedMemberId" name="selectedMemberId">
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="attenSearch">Search Member</label>
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" id="attenSearch" name="attenSearch" placeholder="Search by name or ID..."
                autocomplete="off" required>
              <div class="search-result-container"></div>
            </div>
          </div>
          <div class="form-group full-width">
            <label for="time">Check-In-Time</label>
            <input type="time" id="time" name="checkInTime">
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitAttendanceBtn">Mark Attendance</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirmation Dialog Modal -->
  <div class="modal-overlay" id="confirmationModal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h2 id="confirmationTitle">Confirm Action</h2>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <p id="confirmationMessage">Are you sure you want to proceed with this action?</p>
      </div>
      <div class="form-actions" style="justify-content: center; gap: 20px;">
        <button type="button" class="btn btn-secondary" id="cancelAction">Cancel</button>
        <button type="button" class="btn" id="confirmAction" style="transition: all 0.3s ease;">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // Attendance Management Module
    const AttendanceManager = {
      // Configuration and State
      config: {
        apiBaseUrl: 'http://localhost:4000/api',
        endpoints: {
          members: '/members',
          attendances: '/attendances',
          checkIn: '/attendances/check-in',
          checkOut: '/attendances/check-out'
        },
        pagination: {
          currentPage: 1,
          totalPages: 1,
          itemsPerPage: 10,
          total: 0
        }
      },

      // DOM Element References
      elements: {
        addAttendanceBtn: document.getElementById('addAttendanceBtn'),
        addAttenModal: document.getElementById('addAttenModal'),
        attenForm: document.getElementById('attenForm'),
        attenSearch: document.getElementById('attenSearch'),
        searchResultContainer: document.querySelector('.search-result-container'),
        timeInput: document.getElementById('time'),
        checkoutTimeInput: document.getElementById('checkoutTime'),
        tableBody: document.querySelector('.members-table tbody'),
        filterDate: document.getElementById('filterDate'),
        searchInput: document.querySelector('.search-box input'),
        downloadBtn: document.getElementById('download'),
        printBtn: document.getElementById('print'),
        prevPageBtn: document.getElementById('prevPage'),
        nextPageBtn: document.getElementById('nextPage'),
        pageInfo: document.getElementById('pageInfo'),
        infoBoxes: {
          totalMembers: document.querySelector('.info-box:nth-child(1) .info-box-number'),
          checkIns: document.querySelector('.info-box:nth-child(2) .info-box-number'),
          date: document.querySelector('.info-box:nth-child(3) .info-box-number')
        },
        confirmationModal: document.getElementById('confirmationModal'),
        confirmationTitle: document.getElementById('confirmationTitle'),
        confirmationMessage: document.getElementById('confirmationMessage'),
        confirmActionBtn: document.getElementById('confirmAction'),
        cancelActionBtn: document.getElementById('cancelAction'),
        filterDownload: document.getElementById('filterDownload')
      },

      // Utility Methods
      utils: {
        debounce(func, delay) {
          let timeoutId;
          return function () {
            const context = this;
            const args = arguments;
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
              func.apply(context, args);
            }, delay);
          };
        },

        formatDate(dateString) {
          return dateString
            ? new Date(dateString).toLocaleDateString('en-US', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            })
            : 'N/A';
        },

        formatTime(dateString) {
          return dateString
            ? new Date(dateString).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            })
            : 'N/A';
        },

        formatDateTime(dateString) {
          return dateString
            ? new Date(dateString).toLocaleString('en-US', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })
            : 'N/A';
        },

        async fetchData(url, options = {}) {
          try {
            const response = await fetch(url, {
              headers: {
                'Content-Type': 'application/json',
                ...options.headers
              },
              ...options
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.message || 'Request failed');
            }

            return await response.json();
          } catch (error) {
            showNotification(error.message, 'error');
            throw error;
          }
        },

        // Method to format time to HH:mm format
        formatTimeForAPI(timeString) {
          if (!timeString) return null;

          // Parse the time input
          const [hours, minutes] = timeString.split(':');

          // Create a full date with the specified time
          const now = new Date();
          const formattedTime = new Date(
            now.getFullYear(),
            now.getMonth(),
            now.getDate(),
            parseInt(hours),
            parseInt(minutes)
          );

          // Return a format that can be easily parsed
          return formattedTime.toISOString();
        },

        createPaginationContainer() {
          // Create pagination container
          const container = document.createElement('div');
          container.classList.add('pagination-container');

          // Previous button
          const prevBtn = document.createElement('button');
          prevBtn.innerHTML = '&laquo; Previous';
          prevBtn.classList.add('pagination-btn', 'prev');

          // Next button
          const nextBtn = document.createElement('button');
          nextBtn.innerHTML = 'Next &raquo;';
          nextBtn.classList.add('pagination-btn', 'next');

          // Current page display
          const currentPageSpan = document.createElement('span');
          currentPageSpan.classList.add('current-page');

          // Append to container
          container.appendChild(prevBtn);
          container.appendChild(currentPageSpan);
          container.appendChild(nextBtn);

          // Insert after the table
          const tableContainer = document.querySelector('.table-container');
          tableContainer.appendChild(container);

          return {
            container,
            prevBtn,
            nextBtn,
            currentPageSpan
          };
        }
      },

      // Member Search Functionality
      memberSearch: {
        async searchMembers(query) {
          if (!query || query.length < 2) {
            AttendanceManager.elements.searchResultContainer.innerHTML = '';
            return;
          }

          try {
            const url = `${AttendanceManager.config.apiBaseUrl}${AttendanceManager.config.endpoints.members}?search=${encodeURIComponent(query)}`;
            const result = await AttendanceManager.utils.fetchData(url);

            AttendanceManager.elements.searchResultContainer.innerHTML = '';

            if (result.data && result.data.length > 0) {
              result.data.forEach(member => {
                const resultItem = document.createElement('div');
                resultItem.classList.add('search-result-item');
                resultItem.innerHTML = `
                  <div class="search-result-primary">
                    <strong>${member.fullName}</strong>
                    <span>${member.memberId}</span>
                  </div>
                  <div class="search-result-secondary">
                    <small>${member.email}</small>
                    <small>Current Membership: ${member.membershipType}</small>
                  </div>
                `;
                resultItem.dataset.memberId = member.memberId;
                resultItem.addEventListener('click', () => {
                  // Update search input with full member details
                  AttendanceManager.elements.attenSearch.value = `${member.fullName} (${member.memberId})`;

                  // Store memberId in dataset for later use
                  AttendanceManager.elements.attenSearch.dataset.memberId = member.memberId;

                  // Clear search results
                  AttendanceManager.elements.searchResultContainer.innerHTML = '';
                });
                AttendanceManager.elements.searchResultContainer.appendChild(resultItem);
              });
            } else {
              const noResultsItem = document.createElement('div');
              noResultsItem.classList.add('no-results');
              noResultsItem.textContent = 'No members found';
              AttendanceManager.elements.searchResultContainer.appendChild(noResultsItem);
            }
          } catch (error) {
            console.error('Error searching members:', error);
          }
        }
      },

      // Attendance Data Management
      attendanceData: {
        async fetchAttendanceData() {
          try {
            // Get today's date in YYYY-MM-DD format
            const today = new Date().toISOString().split('T')[0];
            
            // Calculate start date based on filter
            const calculateStartDate = (days) => {
              const startDate = new Date();
              if (days === 'today') {
                startDate.setHours(0, 0, 0, 0);
              } else {
                startDate.setDate(startDate.getDate() - parseInt(days));
              }
              return startDate.toISOString().split('T')[0];
            };

            // Get the selected filter values
            const selectedFilter = AttendanceManager.elements.filterDownload.value;
            const selectedDate = AttendanceManager.elements.filterDate.value;
            
            // Determine the date range based on filters
            let startDate, endDate;
            
            if (selectedDate) {
              // If calendar date is selected, use that specific date
              startDate = selectedDate;
              endDate = selectedDate;
            } else {
              // Otherwise use the download filter range
              startDate = calculateStartDate(selectedFilter);
              endDate = today;
            }
            
            // Prepare query parameters
            const params = new URLSearchParams({
              page: AttendanceManager.config.pagination.currentPage,
              limit: AttendanceManager.config.pagination.itemsPerPage,
              startDate: startDate,
              endDate: endDate,
              search: AttendanceManager.elements.searchInput.value || ''
            });

            const url = `${AttendanceManager.config.apiBaseUrl}${AttendanceManager.config.endpoints.attendances}?${params}`;
            const result = await AttendanceManager.utils.fetchData(url);

            // Clear existing table rows
            AttendanceManager.elements.tableBody.innerHTML = '';

            if (!result.data || result.data.length === 0) {
              const noRecordsMessage = selectedDate 
                ? `No attendance records found for ${AttendanceManager.utils.formatDate(selectedDate)}`
                : `No attendance records found for ${selectedFilter === 'today' ? 'today' : 'the selected period'}`;
              
              AttendanceManager.elements.tableBody.innerHTML = `
                <tr>
                  <td colspan="8" class="text-center">${noRecordsMessage}</td>
                </tr>
              `;
            } else {
              // Filter data based on selected date if calendar filter is active
              const filteredData = selectedDate 
                ? result.data.filter(attendance => {
                    const attendanceDate = new Date(attendance.date).toISOString().split('T')[0];
                    return attendanceDate === selectedDate;
                  })
                : result.data;

              if (filteredData.length === 0) {
                const noRecordsMessage = selectedDate 
                  ? `No attendance records found for ${AttendanceManager.utils.formatDate(selectedDate)}`
                  : `No attendance records found for ${selectedFilter === 'today' ? 'today' : 'the selected period'}`;
                
                AttendanceManager.elements.tableBody.innerHTML = `
                  <tr>
                    <td colspan="8" class="text-center">${noRecordsMessage}</td>
                  </tr>
                `;
              } else {
                // Populate table with filtered attendance data
                filteredData.forEach((attendance, index) => {
                  const row = document.createElement('tr');
                  const rowNumber = ((AttendanceManager.config.pagination.currentPage - 1) * AttendanceManager.config.pagination.itemsPerPage) + index + 1;
                  
                  row.innerHTML = `
                    <td>${rowNumber}</td>
                    <td>${attendance.member.memberId}</td>
                    <td>${attendance.member.fullName}</td>
                    <td>${attendance.member.email}</td>
                    <td>${AttendanceManager.utils.formatTime(attendance.checkIn.time)}</td>
                    <td>${AttendanceManager.utils.formatDate(attendance.date)}</td>
                    <td>${AttendanceManager.utils.formatTime(attendance.checkOut.time)}</td>
                    <td>
                      ${attendance.checkOut.time ? `
                        <button class="action-btn success" disabled title="Checked Out">
                          <i class="fas fa-check"></i>
                        </button>
                      ` : `
                        <button class="action-btn checkout" data-member-id="${attendance.member.memberId}" title="Check Out">
                          <i class="fas fa-sign-out-alt"></i>
                        </button>
                      `}
                      <button class="action-btn delete" data-member-id="${attendance.member.memberId}" title="Delete">
                        <i class="fas fa-trash"></i>
                      </button>
                    </td>
                  `;
                  AttendanceManager.elements.tableBody.appendChild(row);
                });
              }
            }

            // Update info boxes
            await this.updateInfoBoxes();
            const filteredData = selectedDate 
              ? result.data.filter(attendance => {
                  const attendanceDate = new Date(attendance.date).toISOString().split('T')[0];
                  return attendanceDate === selectedDate;
                })
              : result.data;
            AttendanceManager.elements.infoBoxes.checkIns.textContent = filteredData.length || '0';
            
            // Always show current date in dd/mm/yyyy format
            const currentDate = new Date();
            const formattedDate = currentDate.toLocaleDateString('en-GB', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            });
            AttendanceManager.elements.infoBoxes.date.textContent = formattedDate;

            // Update pagination
            this.updatePagination({
              ...result.pagination,
              total: filteredData.length
            });

            // Setup edit and delete event listeners
            this.setupActionListeners();

          } catch (error) {
            console.error('Error fetching attendance data:', error);
            AttendanceManager.elements.tableBody.innerHTML = `
              <tr>
                <td colspan="8" class="text-center">Error loading attendance records. Please try again.</td>
              </tr>
            `;
          }
        },

        async updateInfoBoxes() {
          try {
            // Fetch total members count
            const membersUrl = `${AttendanceManager.config.apiBaseUrl}${AttendanceManager.config.endpoints.members}`;
            const membersResult = await AttendanceManager.utils.fetchData(membersUrl);

            // Update total members count in info box
            if (membersResult.data) {
              AttendanceManager.elements.infoBoxes.totalMembers.textContent = membersResult.data.length || '0';
            }
          } catch (error) {
            console.error('Error updating info boxes:', error);
            AttendanceManager.elements.infoBoxes.totalMembers.textContent = '0';
          }
        },

        updatePagination(paginationInfo) {
          // Update pagination state
          AttendanceManager.config.pagination.currentPage = parseInt(paginationInfo.page) || 1;
          AttendanceManager.config.pagination.totalPages = parseInt(paginationInfo.pages) || 1;
          AttendanceManager.config.pagination.total = parseInt(paginationInfo.total) || 0;

          // Update page info display
          AttendanceManager.elements.pageInfo.textContent =
            `Page ${AttendanceManager.config.pagination.currentPage} of ${AttendanceManager.config.pagination.totalPages} (Total: ${AttendanceManager.config.pagination.total} records)`;

          // Update button states
          AttendanceManager.elements.prevPageBtn.disabled = AttendanceManager.config.pagination.currentPage <= 1;
          AttendanceManager.elements.nextPageBtn.disabled = AttendanceManager.config.pagination.currentPage >= AttendanceManager.config.pagination.totalPages;

          // Add visual feedback for disabled state
          AttendanceManager.elements.prevPageBtn.classList.toggle('disabled', AttendanceManager.config.pagination.currentPage <= 1);
          AttendanceManager.elements.nextPageBtn.classList.toggle('disabled', AttendanceManager.config.pagination.currentPage >= AttendanceManager.config.pagination.totalPages);
        },

        setupActionListeners() {
          const deleteButtons = document.querySelectorAll('.action-btn.delete');
          const checkoutButtons = document.querySelectorAll('.action-btn.checkout');

          deleteButtons.forEach(button => {
            button.addEventListener('click', () => this.handleDeleteAttendance(button.dataset.memberId));
          });

          checkoutButtons.forEach(button => {
            button.addEventListener('click', () => this.handleCheckout(button.dataset.memberId));
          });
        },

        async handleDeleteAttendance(memberId) {
          AttendanceManager.confirmationDialog.show(
            'Delete Attendance Record',
            'Are you sure you want to delete this attendance record? This action cannot be undone.',
            'delete',
            memberId
          );
        },

        async handleCheckout(memberId) {
          try {
            const currentTime = new Date().toLocaleTimeString('en-US', {
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            });

            const response = await fetch(`${AttendanceManager.config.apiBaseUrl}${AttendanceManager.config.endpoints.checkOut}/${memberId}`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                time: AttendanceManager.utils.formatTimeForAPI(currentTime)
              })
            });

            const result = await response.json();

            if (result.success) {
              showNotification('Check-out recorded successfully', 'success');
              this.fetchAttendanceData();
            } else {
              showNotification(result.message || 'Failed to record check-out', 'error');
            }
          } catch (error) {
            console.error('Error recording check-out:', error);
            showNotification('Failed to record check-out. Please try again.', 'error');
          }
        },

        setupPaginationListeners() {
          // Previous page listener
          AttendanceManager.elements.prevPageBtn.addEventListener('click', () => {
            if (AttendanceManager.config.pagination.currentPage > 1) {
              AttendanceManager.config.pagination.currentPage--;
              this.fetchAttendanceData();
            }
          });

          // Next page listener
          AttendanceManager.elements.nextPageBtn.addEventListener('click', () => {
            if (AttendanceManager.config.pagination.currentPage < AttendanceManager.config.pagination.totalPages) {
              AttendanceManager.config.pagination.currentPage++;
              this.fetchAttendanceData();
            }
          });
        }
      },

      // Attendance Marking
      markAttendance: {
        // Reset modal to default state
        resetModal() {
          // Reset form
          this.elements.attenForm.reset();

          // Reset hidden inputs
          document.getElementById('attendanceMode').value = 'add';
          document.getElementById('selectedMemberId').value = '';

          // Reset modal title and subtitle
          document.getElementById('modalTitle').textContent = 'Mark New Attendance';
          document.getElementById('modalSubtitle').textContent = 'Fill in the details to mark a new attendance.';

          // Reset submit button text
          document.getElementById('submitAttendanceBtn').textContent = 'Mark Attendance';

          // Clear search results and member ID
          this.elements.attenSearch.value = '';
          delete this.elements.attenSearch.dataset.memberId;
          this.elements.searchResultContainer.innerHTML = '';
        },

        // Prepare modal for editing
        prepareEditModal(attendance) {
          // Set mode to edit
          document.getElementById('attendanceMode').value = 'edit';
          document.getElementById('selectedMemberId').value = attendance.member.memberId;

          // Update modal title and subtitle
          document.getElementById('modalTitle').textContent = 'Edit Attendance';
          document.getElementById('modalSubtitle').textContent = `Edit attendance for ${attendance.member.fullName}`;

          // Update submit button text
          document.getElementById('submitAttendanceBtn').textContent = 'Update Attendance';

          // Populate form with existing data
          this.elements.attenSearch.value = `${attendance.member.fullName} (${attendance.member.memberId})`;
          this.elements.attenSearch.dataset.memberId = attendance.member.memberId;

          // Format and set times
          this.elements.timeInput.value = attendance.checkIn.time
            ? new Date(attendance.checkIn.time).toTimeString().slice(0, 5)
            : '';
        },

        async submitAttendance(e) {
          e.preventDefault();

          // Determine mode
          const mode = document.getElementById('attendanceMode').value;

          // Get member ID from the search input's dataset
          const memberId = this.elements.attenSearch.dataset.memberId ||
            document.getElementById('selectedMemberId').value;

          if (!memberId) {
            showNotification('Please select a member', 'error');
            return;
          }

          const checkInTime = this.elements.timeInput.value;

          if (!checkInTime) {
            showNotification('Please provide check-in time', 'warning');
            return;
          }

          try {
            // Determine API endpoint and method based on mode
            const baseUrl = `${this.config.apiBaseUrl}${this.config.endpoints.attendances}`;
            const apiMethod = mode === 'edit' ? 'PUT' : 'POST';

            // Check-in request
            const checkInUrl = mode === 'edit'
              ? `${baseUrl}/${memberId}/check-in`
              : `${this.config.apiBaseUrl}${this.config.endpoints.checkIn}/${memberId}`;

            await this.utils.fetchData(checkInUrl, {
              method: apiMethod,
              body: JSON.stringify({
                time: this.utils.formatTimeForAPI(checkInTime)
              })
            });

            showNotification(`${mode === 'edit' ? 'Updated' : 'Marked'} check-in successfully`, 'success');

            // Reset form and close modal
            this.elements.attenForm.reset();
            document.getElementById('attendanceMode').value = 'add';
            document.getElementById('selectedMemberId').value = '';
            this.elements.attenSearch.value = '';
            delete this.elements.attenSearch.dataset.memberId;
            this.elements.searchResultContainer.innerHTML = '';

            this.elements.addAttenModal.classList.remove('active');
            document.body.style.overflow = '';

            // Refresh attendance data
            this.attendanceData.fetchAttendanceData();

          } catch (error) {
            console.error('Attendance submission error:', error);
            showNotification(error.message, 'error');
          }
        }
      },

      // Download Attendance Functionality
      downloadAttendance: {
        // Convert attendance data to CSV
        convertToCSV(data) {
          // Define CSV headers
          const headers = [
            'S.N',
            'Member ID',
            'Full Name',
            'Email',
            'Check-In Time',
            'Date',
            'Check-Out Time'
          ];

          // Convert data to CSV rows
          const csvRows = data.map((attendance, index) => [
            index + 1,
            attendance.member.memberId,
            attendance.member.fullName,
            attendance.member.email,
            this.formatCSVTime(attendance.checkIn.time),
            this.formatCSVDate(attendance.date),
            this.formatCSVTime(attendance.checkOut.time)
          ]);

          // Combine headers and rows
          const csvContent = [
            headers.join(','),
            ...csvRows.map(row => row.map(this.escapeCSV).join(','))
          ].join('\n');

          return csvContent;
        },

        // Format time for CSV
        formatCSVTime(dateString) {
          if (!dateString) return '';

          const date = new Date(dateString);
          return isNaN(date.getTime())
            ? ''
            : date.toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              second: '2-digit',
              hour12: true
            });
        },

        // Format date for CSV
        formatCSVDate(dateString) {
          if (!dateString) return '';

          const date = new Date(dateString);
          return isNaN(date.getTime())
            ? ''
            : date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit'
            });
        },

        // Escape special characters for CSV
        escapeCSV(value) {
          if (value === null || value === undefined) return '';

          // Convert to string and escape quotes
          let strValue = String(value).replace(/"/g, '""');

          // Wrap in quotes if contains comma, quote, or newline
          if (/[",\n]/.test(strValue)) {
            strValue = `"${strValue}"`;
          }

          return strValue;
        },

        // Trigger download for CSV
        async triggerDownload() {
          try {
            // Get download filter value
            const downloadFilter = document.getElementById('filterDownload').value;

            // Calculate start date based on filter
            const calculateStartDate = (days) => {
              const startDate = new Date();
              if (days === 'today') {
                startDate.setHours(0, 0, 0, 0);
              } else {
                startDate.setDate(startDate.getDate() - parseInt(days));
              }
              return startDate.toISOString().split('T')[0];
            };

            // Prepare query parameters
            const params = new URLSearchParams({
              startDate: calculateStartDate(downloadFilter),
              limit: 1000
            });

            // Fetch attendance data for the selected time range
            const apiUrl = `${AttendanceManager.config.apiBaseUrl}${AttendanceManager.config.endpoints.attendances}?${params}`;
            const result = await AttendanceManager.utils.fetchData(apiUrl);

            // Current date for filename
            const currentDate = new Date().toISOString().split('T')[0];
            const filename = `attendance_${downloadFilter}_${currentDate}`;

            // Download CSV
            const csvContent = this.convertToCSV(result.data);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const downloadUrl = URL.createObjectURL(blob);

            link.setAttribute('href', downloadUrl);
            link.setAttribute('download', `${filename}.csv`);

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success notification
            showNotification(`Attendance records downloaded for ${downloadFilter} in CSV`, 'success');

          } catch (error) {
            console.error('Download error:', error);
            showNotification('Failed to download attendance records', 'error');
          }
        },

        // Print attendance data
        async printAttendance() {
          try {
            // Get download filter value
            const downloadFilter = document.getElementById('filterDownload').value;

            // Calculate start date based on filter
            const calculateStartDate = (days) => {
              const startDate = new Date();
              if (days === 'today') {
                startDate.setHours(0, 0, 0, 0);
              } else {
                startDate.setDate(startDate.getDate() - parseInt(days));
              }
              return startDate.toISOString().split('T')[0];
            };

            // Prepare query parameters
            const params = new URLSearchParams({
              startDate: calculateStartDate(downloadFilter),
              limit: 1000
            });

            // Fetch attendance data for the selected time range
            const apiUrl = `${AttendanceManager.config.apiBaseUrl}${AttendanceManager.config.endpoints.attendances}?${params}`;
            const result = await AttendanceManager.utils.fetchData(apiUrl);

            // Create print window
            const printWindow = window.open('', '_blank');

            // Create print content
            const printContent = `
              <html>
                <head>
                  <title>Attendance Report</title>
                  <style>
                    body { font-family: Arial, sans-serif; }
                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f5f5f5; }
                    h1 { text-align: center; }
                    .header { margin-bottom: 20px; }
                    .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                  </style>
                </head>
                <body>
                  <div class="header">
                    <h1>Attendance Report</h1>
                    <p>Period: ${downloadFilter}</p>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                  </div>
                  <table>
                    <thead>
                      <tr>
                        <th>S.N</th>
                        <th>Member ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Check-In Time</th>
                        <th>Date</th>
                        <th>Check-Out Time</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${result.data.map((attendance, index) => `
                        <tr>
                          <td>${index + 1}</td>
                          <td>${attendance.member.memberId}</td>
                          <td>${attendance.member.fullName}</td>
                          <td>${attendance.member.email}</td>
                          <td>${this.formatCSVTime(attendance.checkIn.time)}</td>
                          <td>${this.formatCSVDate(attendance.date)}</td>
                          <td>${this.formatCSVTime(attendance.checkOut.time)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                  <div class="footer">
                    <p>© ${new Date().getFullYear()} Knox Barbell - Attendance Report</p>
                  </div>
                </body>
              </html>
            `;

            // Write content to print window
            printWindow.document.write(printContent);
            printWindow.document.close();

            // Wait for content to load then print
            printWindow.onload = function () {
              printWindow.print();
              printWindow.close();
            };

            showNotification('Printing attendance records...', 'success');

          } catch (error) {
            console.error('Print error:', error);
            showNotification('Failed to print attendance records', 'error');
          }
        }
      },

      // Confirmation Dialog Management
      confirmationDialog: {
        show(title, message, action, id) {
          this.elements.confirmationTitle.textContent = title;
          this.elements.confirmationMessage.textContent = message;
          this.currentAction = action;
          this.currentId = id;

          // Update confirm button color based on action
          const confirmBtn = this.elements.confirmActionBtn;
          if (action === 'delete') {
            confirmBtn.style.backgroundColor = '#e74c3c';
            confirmBtn.style.borderColor = '#e74c3c';
            confirmBtn.style.color = 'white';
          }

          this.elements.confirmationModal.classList.add('active');
          document.body.style.overflow = 'hidden';
        },

        hide() {
          this.elements.confirmationModal.classList.remove('active');
          document.body.style.overflow = '';
          this.currentAction = null;
          this.currentId = null;

          // Reset confirm button color
          const confirmBtn = this.elements.confirmActionBtn;
          confirmBtn.style.backgroundColor = '';
          confirmBtn.style.borderColor = '';
          confirmBtn.style.color = '';
        },

        get elements() {
          return {
            confirmationModal: document.getElementById('confirmationModal'),
            confirmationTitle: document.getElementById('confirmationTitle'),
            confirmationMessage: document.getElementById('confirmationMessage'),
            confirmActionBtn: document.getElementById('confirmAction'),
            cancelActionBtn: document.getElementById('cancelAction')
          };
        },

        currentAction: null,
        currentId: null
      },

      // Initialization
      init() {
        // Set default date to today in the calendar filter
        const today = new Date().toISOString().split('T')[0];
        this.elements.filterDate.value = today;

        // Modal and Form Event Listeners
        this.elements.addAttendanceBtn.addEventListener('click', () => {
          // Set current time when modal opens
          const now = new Date();
          const currentTime = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          });
          this.elements.timeInput.value = currentTime;
          
          this.elements.addAttenModal.classList.add('active');
          document.body.style.overflow = 'hidden';
        });

        // Close modal listeners
        const closeModalListeners = [
          this.elements.addAttenModal,
          document.querySelector('#cancelBtn')
        ];

        closeModalListeners.forEach(el => {
          el.addEventListener('click', (e) => {
            if (e.target === this.elements.addAttenModal || e.target.closest('#cancelBtn')) {
              this.elements.addAttenModal.classList.remove('active');
              document.body.style.overflow = '';
            }
          });
        });

        // Member search setup
        const debouncedSearch = this.utils.debounce(
          this.memberSearch.searchMembers, 
          300
        );

        // Search input event listener
        this.elements.attenSearch.addEventListener('input', () => {
          debouncedSearch(this.elements.attenSearch.value);
        });

        // Close search results when clicking outside
        document.addEventListener('click', (event) => {
          if (!this.elements.searchResultContainer.contains(event.target) && 
              event.target !== this.elements.attenSearch) {
            this.elements.searchResultContainer.innerHTML = '';
          }
        });

        // Form submission
        this.elements.attenForm.addEventListener(
          'submit', 
          this.markAttendance.submitAttendance.bind(this)
        );

        // Filtering event listeners
        this.elements.filterDate.addEventListener('change', () => {
          // Clear the download filter when calendar date is selected
          this.elements.filterDownload.value = 'today';
          this.config.pagination.currentPage = 1; // Reset to first page when filter changes
          this.attendanceData.fetchAttendanceData();
        });

        let searchTimeout;
        this.elements.searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            this.config.pagination.currentPage = 1; // Reset to first page when search changes
            this.attendanceData.fetchAttendanceData();
          }, 300);
        });

        // Download and Print functionality
        this.elements.downloadBtn.addEventListener('click', () => {
          this.downloadAttendance.triggerDownload();
        });

        this.elements.printBtn.addEventListener('click', () => {
          this.downloadAttendance.printAttendance();
        });

        // Setup pagination listeners
        this.attendanceData.setupPaginationListeners();

        // Initial data fetch
        this.attendanceData.fetchAttendanceData();

        // Confirmation Dialog Event Listeners
        this.confirmationDialog.elements.confirmActionBtn.addEventListener('click', async () => {
          if (this.confirmationDialog.currentAction === 'delete') {
            try {
              // Construct the delete URL with the correct endpoint structure
              const deleteUrl = `${this.config.apiBaseUrl}${this.config.endpoints.attendances}/member/${this.confirmationDialog.currentId}`;
              
              const response = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json'
                }
              });
              
              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to delete attendance record');
              }

              const result = await response.json();
              
              if (result.success) {
                showNotification('Attendance record deleted successfully', 'success');
                this.attendanceData.fetchAttendanceData();
              } else {
                showNotification(result.message || 'Failed to delete attendance record', 'error');
              }
            } catch (error) {
              console.error('Error deleting attendance record:', error);
              showNotification(error.message || 'Failed to delete attendance record. Please try again.', 'error');
            }
          }
          this.confirmationDialog.hide();
        });

        this.confirmationDialog.elements.cancelActionBtn.addEventListener('click', () => {
          this.confirmationDialog.hide();
        });

        // Close modal when clicking outside
        this.confirmationDialog.elements.confirmationModal.addEventListener('click', (e) => {
          if (e.target === this.confirmationDialog.elements.confirmationModal) {
            this.confirmationDialog.hide();
          }
        });

        // Add event listener for download filter change
        this.elements.filterDownload.addEventListener('change', () => {
          // Clear the calendar date when download filter changes
          this.elements.filterDate.value = '';
          this.config.pagination.currentPage = 1; // Reset to first page when filter changes
          this.attendanceData.fetchAttendanceData();
        });

        // Add event listener for reset filters button
        document.getElementById('resetFilters').addEventListener('click', () => {
          // Reset all filters
          this.elements.filterDate.value = today; // Reset to today's date
          this.elements.searchInput.value = '';
          this.elements.filterDownload.value = 'today';
          
          // Reset pagination
          this.config.pagination.currentPage = 1;
          
          // Fetch data with reset filters
          this.attendanceData.fetchAttendanceData();
          
          // Show notification
          showNotification('Filters have been reset', 'success');
        });
      }
    };

    // Initialize the Attendance Manager when DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      AttendanceManager.init();
    });
  </script>
  <script src="/js/main.js"></script>
  <script src="./js/logout.js"></script>
</body>

</html>