<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knox Barbell - Membership</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/trainer.css">
  </head>

  <body>
    <!-- sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h3>Knox Barbell</h3>
        <button class="toggle-btn" id="toggleSidebar">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      <ul class="sidebar-menu">
        <li>
          <a href="/dashboard">
            <i class="fas fa-tachometer-alt"></i>
            <span>Dashboard</span>
            <div class="tooltip">Dashboard</div>
          </a>
        </li>
        <li>
          <a href="/members">
            <i class="fas fa-user"></i>
            <span>Member</span>
            <div class="tooltip">Member</div>
          </a>
        </li>
        <li>
          <a href="/application">
            <i class="fa-solid fa-file-lines"></i>
            <span>Application</span>
            <div class="tooltip">Application</div>
          </a>
        </li>
        <li>
          <a href="/membership">
            <i class="fas fa-id-card"></i>
            <span>Membership</span>
            <div class="tooltip">Membership</div>
          </a>
        </li>
        <li>
          <a href="/trainers" class="active">
            <i class="fas fa-chalkboard-teacher"></i>
            <span>Trainers</span>
            <div class="tooltip">Trainers</div>
          </a>
        </li>
        <li>
          <a href="/employee">
            <i class="fas fa-users"></i>
            <span>Employee</span>
            <div class="tooltip">Employee</div>
          </a>
        </li>
        <li>
          <a href="/notifications">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
            <div class="tooltip">Notifications</div>
          </a>
        </li>
        <li>
          <a href="/attendance">
            <i class="fas fa-calendar-check"></i>
            <span>Attendance</span>
            <div class="tooltip">Attendance</div>
          </a>
        </li>
        <li>
          <a href="/events">
            <i class="fas fa-calendar-alt"></i>
            <span>Events</span>
            <div class="tooltip">Events</div>
          </a>
        </li>
        <li>
          <a href="/finance">
            <i class="fas fa-wallet"></i>
            <span>Finance</span>
            <div class="tooltip">Finance</div>
          </a>
        </li>
        <li>
          <a href="/locker">
            <i class="fas fa-lock"></i>
            <span>Locker</span>
            <div class="tooltip">Locker</div>
          </a>
        </li>
        <li>
          <a href="/product">
            <i class="fas fa-box"></i>
            <span>Product</span>
            <div class="tooltip">Product</div>
          </a>
        </li>
        <li class="logout-item">
          <a href="#" id="logoutButton">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
            <div class="tooltip">Logout</div>
          </a>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Topbar -->
      <div class="topbar">
        <div class="topbar-left">
          <button class="mobile-toggle" id="mobileToggle">
            <i class="fas fa-bars"></i>
          </button>
          <h3>Trainers</h3>
        </div>
        <div class="topbar-right">
          <!-- notification  -->
          <div class="notification">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">0</span>

            <!-- Notification Modal -->
            <div class="notification-modal">
              <div class="notification-header">
                <h3>Notifications</h3>
                <div class="notification-actions">
                  <a href="/notifications" class="view-all-link">View All</a>
                  <button class="close-notifications">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              </div>
              <div class="notification-list">
                <!-- Notifications will be populated here -->
                <div class="notification-loading">
                  <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                </div>
              </div>
            </div>
          </div>
          <div class="user-greeting">
            <img src="/img/Knox Logo-01.png" alt="User">
            <span>Hello, Knox Barbell</span>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="content">

        <!-- header -->
        <div class="content-header">
          <h1>Trainers Management</h1>
          <button id="addTrainerBtn">
            <span>+</span>
            <p>Add</p>
          </button>
        </div>

        <!-- filter -->
        <div class="filter-group">
          <select id="statusFilter">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
          <button id="resetTrainerFilters" title="Reset Filters">
            <i class="fa-solid fa-rotate"></i>
          </button>
          <button id="downloadTrainers" title="Download CSV">
            <i class="fa-solid fa-download"></i>
          </button>
          <button id="printTrainers" title="Print">
            <i class="fa-solid fa-print"></i>
          </button>
        </div>

        <!-- Enrolled Members Table -->
        <div class="table-container">
          <table class="trainer-table">
            <thead>
              <tr>
                <th>S.N</th>
                <th>Id</th>
                <th>Full Name</th>
                <th>Email Id</th>
                <th>Contact No.</th>
                <th>Gender</th>
                <th>Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                <td>loading...</td>
                <td>loading...</td>
                <td>loading...</td>
                <td>loading...</td>
                <td>loading...</td>
                <td>loading...</td>
                <td><span class="status"> <i class="fa-solid fa-circle-check"></i>loading...</span></td>
                <td>
                  <button class="action-btn edit"><i class="fa-solid fa-pen"></i></button>
                  <button class="action-btn delete"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
          <button id="prevPage" class="pagination-btn" disabled>
            <i class="fas fa-chevron-left"></i> Previous
          </button>
          <span id="pageInfo">Page 1</span>
          <button id="nextPage" class="pagination-btn" disabled>
            Next <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- Trainer Member Management Section -->
        <div class="content-header">
          <h1>Trainer Member Assignments</h1>
          <button id="assignMemberHeaderBtn" class="btn btn-primary"
            style="display: flex; align-items: center; gap: 8px;">
            <i class="fa-solid fa-user-plus"></i> Assign Member
          </button>
        </div>

        <!-- Assigned Members Table -->
        <div class="table-container">
          <table class="trainer-assignments-table">
            <thead>
              <tr>
                <th>S.N</th>
                <th>Trainer ID</th>
                <th>Trainer Name</th>
                <th>Member ID</th>
                <th>Member Name</th>
                <th>Assigned Date</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="8" class="text-center">Loading assignments...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Add Trainers Modal -->
    <div class="modal-overlay" id="addTrainerModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="heading-container">
            <h2>Add New Trainer</h2>
            <p>Fill in the details to add a new trainer.</p>
          </div>
        </div>
        <form id="trainerForm">
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="fullName">Full Name</label>
              <input type="text" id="fullName" required>
            </div>
            <div class="form-group full-width">
              <label for="email">Email</label>
              <input type="email" id="email" required>
            </div>
            <div class="form-group">
              <label for="contact">Contact</label>
              <input type="tel" id="contact" required>
            </div>
            <div class="form-group">
              <label for="date">Start Date</label>
              <input type="date" id="date" required>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="genderMale" name="gender" value="male" checked>
                  <label for="genderMale">Male</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="genderFemale" name="gender" value="female">
                  <label for="genderFemale">Female</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="genderOther" name="gender" value="other">
                  <label for="genderOther">Other</label>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Status</label>
              <div class="radio-group">
                <div class="radio-option">
                  <input type="radio" id="statusActive" name="status" value="active" checked>
                  <label for="statusActive">Active</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="statusInactive" name="status" value="inactive">
                  <label for="statusInactive">Inactive</label>
                </div>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
            <button type="submit" class="btn btn-primary">Add Trainer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Assign Member to Trainer Modal -->
    <div class="modal-overlay" id="assignMemberModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="heading-container">
            <h2>Assign Member to Trainer</h2>
            <p>Select a member to assign to this trainer.</p>
          </div>
        </div>
        <form id="assignMemberForm">
          <div class="form-grid">
            <div class="form-group full-width">
              <label for="selectedTrainer">Trainer</label>
              <select id="selectedTrainerSelect">
                <option value="">Select Trainer</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label for="memberSearch">Search Members</label>
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="memberSearch" placeholder="Search by member ID, name, or email..."
                  autocomplete="off">
                <div class="search-result-container"></div>
              </div>
            </div>
            <div class="form-group full-width">
              <label>Selected Member</label>
              <div id="selectedMemberInfo" class="selected-member-info">
                <div class="member-card">
                  <div class="member-details">
                    <strong id="selectedMemberName"></strong>
                    <span id="selectedMemberId"></span>
                    <span id="selectedMemberEmail"></span>
                  </div>
                  <button type="button" id="removeSelectedMember" class="btn btn-secondary reset">
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" id="cancelAssignBtn">Cancel</button>
            <button type="submit" class="btn btn-primary" id="assignMemberBtn" disabled>Assign Member</button>
          </div>
        </form>
      </div>
    </div>

    <script src="/js/main.js"></script>
    <script src="./js/logout.js"></script>
    <script>

      // DOM Elements
      const addTrainerBtn = document.getElementById('addTrainerBtn');
      const addTrainerModal = document.getElementById('addTrainerModal');
      const cancelBtn = document.getElementById('cancelBtn');
      const trainerForm = document.getElementById('trainerForm');
      const trainerTableBody = document.querySelector('.trainer-table tbody');
      const prevPageBtn = document.getElementById("prevPage");
      const nextPageBtn = document.getElementById("nextPage");
      const pageInfo = document.getElementById("pageInfo");

      let currentAction = null;
      let currentTrainerId = null;

      // Pagination state
      let currentPage = 1;
      let totalPages = 1;
      const itemsPerPage = 10;
      let allTrainers = []; // Store all trainers

      // Utility Functions
      const toast = (message, type = 'success') => {
        window.toast(message, type);
      };

      const validateForm = (formData) => {
        const errors = [];

        // Full Name validation
        if (!formData.fullName || formData.fullName.trim().length < 2) {
          errors.push('Please enter a valid full name');
        }

        // Email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!formData.email || !emailRegex.test(formData.email)) {
          errors.push('Please enter a valid email address');
        }

        // Contact validation
        const contactRegex = /^[0-9]{10,15}$/;
        if (!formData.contact || !contactRegex.test(formData.contact)) {
          errors.push('Please enter a valid 10-15 digit contact number');
        }

        // Gender validation
        if (!['male', 'female', 'other'].includes(formData.gender)) {
          errors.push('Please select a valid gender');
        }

        // Join Date validation
        if (!formData.joinDate) {
          errors.push('Please select a join date');
        }

        // Status validation
        if (!['active', 'inactive'].includes(formData.status)) {
          errors.push('Please select a valid status');
        }

        return errors;
      };

      const resetModal = () => {
        trainerForm.reset();
        document.querySelector('#addTrainerModal .modal-header h2').textContent = 'Add New Trainer';
        document.querySelector('#trainerForm button[type="submit"]').textContent = 'Add Trainer';
        trainerForm.dataset.mode = 'add';
        delete trainerForm.dataset.trainerId;
      };

      // Fetch and Display Trainers
      async function fetchTrainers(page = 1) {
        try {
          // Get status filter value
          const statusFilter = document.getElementById('statusFilter').value;

          let query = [];
          if (statusFilter) query.push(`status=${statusFilter}`);
          const queryString = query.length ? "?" + query.join("&") : "";

          const response = await fetch(`/api/trainers${queryString}`);
          const result = await response.json();

          if (result.success) {
            // Store all trainers
            allTrainers = result.data;

            // Calculate pagination
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTrainers = allTrainers.slice(startIndex, endIndex);

            // Calculate total pages
            totalPages = Math.ceil(allTrainers.length / itemsPerPage);

            // Render the table with paginated data
            displayTrainers(paginatedTrainers);

            // Update pagination
            updatePagination({
              currentPage: page,
              totalPages: totalPages,
              total: allTrainers.length
            });
          } else {
            console.error('Failed to fetch trainers:', result.message);
            trainerTableBody.innerHTML = `<tr><td colspan="9" class="text-center">Error loading trainers. Please try again.</td></tr>`;
            // Reset pagination on error
            updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
          }
        } catch (error) {
          console.error('Error fetching trainers:', error);
          trainerTableBody.innerHTML = `<tr><td colspan="9" class="text-center">Error loading trainers. Please try again.</td></tr>`;
          // Reset pagination on error
          updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
        }
      }

      function updatePagination(paginationData) {
        // Ensure we have valid numbers for pagination
        currentPage = parseInt(paginationData.currentPage) || 1;
        totalPages = parseInt(paginationData.totalPages) || 1;

        // Update page info with proper number formatting
        pageInfo.textContent = `Page ${currentPage} of ${totalPages} (Total: ${paginationData.total} trainers)`;

        // Update button states
        prevPageBtn.disabled = currentPage <= 1;
        nextPageBtn.disabled = currentPage >= totalPages;

        // Add visual feedback for disabled state
        prevPageBtn.classList.toggle('disabled', currentPage <= 1);
        nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
      }

      // Display Trainers in Table
      function displayTrainers(trainers) {
        trainerTableBody.innerHTML = '';

        if (!trainers || !Array.isArray(trainers) || trainers.length === 0) {
          trainerTableBody.innerHTML = `<tr><td colspan="9" class="text-center">No trainers found.</td></tr>`;
          return;
        }

        trainers.forEach((trainer, index) => {
          if (!trainer) return; // Skip invalid trainers

          const tr = document.createElement("tr");
          const rowNumber = ((currentPage - 1) * itemsPerPage) + index + 1;

          // Format dates safely
          const joinDate = trainer.joinDate ?
            new Date(trainer.joinDate).toLocaleDateString() : 'N/A';

          tr.innerHTML = `
            <td>${rowNumber}</td>
            <td class="trainer-detail-link" data-trainer-id="${trainer.trainerId || ''}" style="cursor:pointer;color:#3498db;text-decoration:underline;">${trainer.trainerId || 'N/A'}</td>
            <td>${trainer.fullName || 'N/A'}</td>
            <td>${trainer.email || 'N/A'}</td>
            <td>${trainer.contact || 'N/A'}</td>
            <td>${trainer.gender ? trainer.gender.charAt(0).toUpperCase() + trainer.gender.slice(1) : 'N/A'}</td>
            <td>${joinDate}</td>
            <td>
                <span class="status ${trainer.status || 'active'}">
                    ${trainer.status ? trainer.status.charAt(0).toUpperCase() + trainer.status.slice(1) : 'Active'}
                </span>
            </td>
            <td>
                <button class="action-btn edit" data-trainer-id="${trainer.trainerId || ''}" ${!trainer.trainerId ? 'disabled' : ''}>
                    <i class="fa-solid fa-pen"></i>
                </button>
                <button class="action-btn delete" data-trainer-id="${trainer.trainerId || ''}" ${!trainer.trainerId ? 'disabled' : ''}>
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        `;
          trainerTableBody.appendChild(tr);
        });

        // Add click event for trainerId link
        trainerTableBody.querySelectorAll('.trainer-detail-link').forEach(link => {
          link.addEventListener('click', function () {
            const trainerId = this.getAttribute('data-trainer-id');
            if (trainerId) {
              window.location.href = `/trainer-detail?trainerId=${encodeURIComponent(trainerId)}`;
            }
          });
        });

        attachActionListeners();
      }

      // Pagination event listeners
      prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
          fetchTrainers(currentPage - 1);
        }
      });

      nextPageBtn.addEventListener("click", () => {
        if (currentPage < totalPages) {
          fetchTrainers(currentPage + 1);
        }
      });

      // Modify existing event listeners to work with pagination
      document.getElementById('statusFilter').addEventListener('change', () => {
        currentPage = 1; // Reset to first page when filter changes
        fetchTrainers(currentPage);
      });

      // Add reset button event listener
      document.getElementById('resetTrainerFilters').addEventListener('click', () => {
        currentPage = 1;
        document.getElementById('statusFilter').value = '';
        fetchTrainers(1);
        window.toast('Filters have been reset', 'info');
      });

      // Initial fetch of trainers
      fetchTrainers(1);

      // Initial fetch of trainer assignments
      fetchTrainerAssignments();

      // Form Submission Handler
      trainerForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = {
          fullName: document.getElementById('fullName').value,
          email: document.getElementById('email').value,
          contact: document.getElementById('contact').value,
          gender: document.querySelector('input[name="gender"]:checked').value,
          joinDate: document.getElementById('date').value,
          status: document.querySelector('input[name="status"]:checked').value
        };

        const validationErrors = validateForm(formData);
        if (validationErrors.length > 0) {
          toast(validationErrors.join(', '), 'error');
          return;
        }

        try {
          const mode = trainerForm.dataset.mode || 'add';
          const url = mode === 'add'
            ? '/api/trainers'
            : `/api/trainers/${trainerForm.dataset.trainerId}`;

          const method = mode === 'add' ? 'POST' : 'PUT';

          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (response.ok) {
            addTrainerModal.classList.remove('active');
            document.body.style.overflow = '';

            resetModal();
            fetchTrainers();

            toast(`Trainer ${mode === 'add' ? 'added' : 'updated'} successfully!`);
          } else {
            throw new Error(result.message || `Failed to ${mode} trainer`);
          }
        } catch (error) {
          console.error('Error:', error);
          toast(error.message, 'error');
        }
      });

      // Edit Trainer
      function editTrainer(trainerId) {
        fetch(`/api/trainers/${trainerId}`)
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              const trainer = result.data;

              // Populate form with trainer data
              document.getElementById('fullName').value = trainer.fullName;
              document.getElementById('email').value = trainer.email;
              document.getElementById('contact').value = trainer.contact;
              document.getElementById('date').value = new Date(trainer.joinDate).toISOString().split('T')[0];

              // Set gender
              const genderMale = document.getElementById('genderMale');
              const genderFemale = document.getElementById('genderFemale');
              const genderOther = document.getElementById('genderOther');

              if (trainer.gender === 'female') {
                genderFemale.checked = true;
              } else if (trainer.gender === 'other') {
                genderOther.checked = true;
              } else {
                genderMale.checked = true;
              }

              // Set status
              const statusActive = document.getElementById('statusActive');
              const statusInactive = document.getElementById('statusInactive');

              if (trainer.status === 'inactive') {
                statusInactive.checked = true;
              } else {
                statusActive.checked = true;
              }

              // Change modal title and button text
              document.querySelector('#addTrainerModal .modal-header h2').textContent = 'Update Trainer';
              document.querySelector('#trainerForm button[type="submit"]').textContent = 'Update Trainer';

              // Set form mode and trainer ID
              trainerForm.dataset.mode = 'edit';
              trainerForm.dataset.trainerId = trainerId;

              // Show modal
              addTrainerModal.classList.add('active');
              document.body.style.overflow = 'hidden';
            }
          })
          .catch(error => {
            console.error('Error fetching trainer details:', error);
            toast('Failed to fetch trainer details', 'error');
          });
      }

      // Show Confirmation Dialog
      function showConfirmationDialog(title, message, action, trainerId) {
        currentAction = action;
        currentTrainerId = trainerId;

        window.confirmDialog({
          title: title,
          message: message,
          type: action === 'delete' ? 'delete' : 'warning'
        }).then(confirmed => {
          if (confirmed && currentAction === 'delete') {
            deleteTrainer(currentTrainerId);
          }
        });
      }

      // Delete Trainer
      async function deleteTrainer(trainerId) {
        try {
          const response = await fetch(`/api/trainers/${trainerId}`, {
            method: 'DELETE'
          });
          const result = await response.json();

          if (result.success) {
            window.toast('Trainer deleted successfully', 'success');
            fetchTrainers(currentPage); // refresh current page
          } else {
            window.toast(result.message || 'Failed to delete trainer', 'error');
          }
        } catch (error) {
          console.error('Error deleting trainer:', error);
          window.toast('Failed to delete trainer. Please try again.', 'error');
        }
      }

      // Attach Action Listeners
      function attachActionListeners() {
        document.querySelectorAll('.trainer-table .action-btn.edit').forEach(btn => {
          btn.addEventListener('click', () => {
            const trainerId = btn.getAttribute('data-trainer-id');
            editTrainer(trainerId);
          });
        });

        document.querySelectorAll('.trainer-table .action-btn.delete').forEach(btn => {
          btn.addEventListener('click', () => {
            const trainerId = btn.getAttribute('data-trainer-id');
            if (trainerId) {
              showConfirmationDialog(
                'Delete Trainer',
                'Are you sure you want to delete this trainer? This action cannot be undone.',
                'delete',
                trainerId
              );
            }
          });
        });
      }

      // Modal Handling
      addTrainerBtn.addEventListener('click', function () {
        resetModal();
        addTrainerModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      cancelBtn.addEventListener('click', function () {
        addTrainerModal.classList.remove('active');
        document.body.style.overflow = '';
      });

      // Close modal when clicking outside
      addTrainerModal.addEventListener('click', function (e) {
        if (e.target === addTrainerModal) {
          addTrainerModal.classList.remove('active');
          document.body.style.overflow = '';
        }
      });

      // Assign Member Modal Event Listeners
      document.getElementById('memberSearch').addEventListener('input', function (e) {
        const query = e.target.value.trim();
        const resultsContainer = document.querySelector('#assignMemberModal .search-result-container');
        if (!query || query.length < 2) {
          resultsContainer.innerHTML = '';
          resultsContainer.classList.remove('active');
          return;
        }

        // Fetch and display search results
        (async () => {
          try {
            const response = await fetch(`/api/members/search?q=${encodeURIComponent(query)}`);
            const result = await response.json();

            if (result.success) {
              if (!result.data || result.data.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No members found</div>';
                resultsContainer.classList.add('active');
                return;
              }
              resultsContainer.innerHTML = result.data.map(member => `
                <div class="search-result-item" data-member-id="${member.memberId}" data-member-name="${member.fullName}" data-member-email="${member.email}">
                  <div class="search-result-primary"><strong>${member.fullName}</strong> <span>${member.memberId}</span></div>
                  <div class="search-result-secondary"><small>${member.email}</small></div>
                </div>
              `).join('');
              resultsContainer.classList.add('active');

              // Add click listeners to search results
              resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', () => {
                  selectMember({
                    memberId: item.dataset.memberId,
                    fullName: item.dataset.memberName,
                    email: item.dataset.memberEmail
                  });
                  resultsContainer.classList.remove('active');
                  resultsContainer.innerHTML = '';
                });
              });
            } else {
              resultsContainer.innerHTML = '<div class="search-result-item">No members found</div>';
              resultsContainer.classList.add('active');
            }
          } catch (error) {
            console.error('Error searching members:', error);
            resultsContainer.innerHTML = '<div class="search-result-item">Error searching members</div>';
            resultsContainer.classList.add('active');
          }
        })();
      });

      document.getElementById('removeSelectedMember').addEventListener('click', function () {
        removeSelectedMember();
      });

      document.getElementById('assignMemberForm').addEventListener('submit', function (e) {
        e.preventDefault();
        assignMemberToTrainer();
      });

      document.getElementById('cancelAssignBtn').addEventListener('click', function () {
        closeAssignMemberModal();
      });

      // Close assign member modal when clicking outside
      document.getElementById('assignMemberModal').addEventListener('click', function (e) {
        if (e.target === document.getElementById('assignMemberModal')) {
          closeAssignMemberModal();
        }
      });

      // Add download button event listener
      document.getElementById('downloadTrainers').addEventListener('click', () => {
        // Get the filtered trainers
        const filteredTrainers = allTrainers.filter(trainer => {
          const status = document.getElementById('statusFilter').value;
          if (status && trainer.status !== status) {
            return false;
          }
          return true;
        });

        if (filteredTrainers.length === 0) {
          window.toast('No trainer data to download', 'error');
          return;
        }

        // Create CSV content
        const headers = ['S.N', 'Trainer ID', 'Full Name', 'Email', 'Contact', 'Date', 'Status'];
        const csvContent = [
          headers.join(','),
          ...filteredTrainers.map((trainer, index) => [
            index + 1,
            trainer.trainerId,
            trainer.fullName,
            trainer.email,
            trainer.contact,
            formatDate(trainer.joinDate),
            trainer.status.charAt(0).toUpperCase() + trainer.status.slice(1)
          ].join(','))
        ].join('\n');

        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const date = new Date().toISOString().split('T')[0];

        link.setAttribute('href', url);
        link.setAttribute('download', `trainers_list_${date}.csv`);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      // Add print button event listener
      document.getElementById('printTrainers').addEventListener('click', () => {
        // Get the filtered trainers
        const filteredTrainers = allTrainers.filter(trainer => {
          const status = document.getElementById('statusFilter').value;
          if (status && trainer.status !== status) {
            return false;
          }
          return true;
        });

        if (filteredTrainers.length === 0) {
          window.toast('No trainer data to print', 'error');
          return;
        }

        // Create print window
        const printWindow = window.open('', '_blank');

        // Create print content
        const printContent = `
        <html>
        <head>
            <title>Trainers Report</title>
            <style>
                body { font-family: Arial, sans-serif; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f5f5f5; }
                h1 { text-align: center; }
                .header { margin-bottom: 20px; }
                .footer { margin-top: 20px; text-align: center; font-size: 12px; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>Trainers Report</h1>
                <p>Generated on: ${new Date().toLocaleString()}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>S.N</th>
                        <th>Trainer ID</th>
                        <th>Full Name</th>
                        <th>Email</th>
                        <th>Contact</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredTrainers.map((trainer, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${trainer.trainerId}</td>
                            <td>${trainer.fullName}</td>
                            <td>${trainer.email}</td>
                            <td>${trainer.contact}</td>
                            <td>${formatDate(trainer.joinDate)}</td>
                            <td>${trainer.status.charAt(0).toUpperCase() + trainer.status.slice(1)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div class="footer">
                <p>© ${new Date().getFullYear()} Knox Barbell - Trainers Report</p>
            </div>
        </body>
        </html>
    `;

        // Write content to print window
        printWindow.document.write(printContent);
        printWindow.document.close();

        // Wait for content to load then print
        printWindow.onload = function () {
          printWindow.print();
          printWindow.close();
        };

        toast('Printing trainers records...', 'success');
      });

      // Helper function to format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
      }

      // Member Assignment Functionality
      let selectedMember = null;
      let currentTrainerForAssignment = null;

      // Open assign member modal
      function openAssignMemberModal(trainerId) {
        currentTrainerForAssignment = trainerId || null;

        // Populate trainer dropdown
        const trainerSelect = document.getElementById('selectedTrainerSelect');
        trainerSelect.innerHTML = '<option value="">Select Trainer</option>';
        allTrainers.forEach(trainer => {
          const option = document.createElement('option');
          option.value = trainer.trainerId;
          option.textContent = `${trainer.fullName} (${trainer.trainerId})`;
          trainerSelect.appendChild(option);
        });

        // If trainerId is provided, select it and disable dropdown
        if (trainerId) {
          trainerSelect.value = trainerId;
          trainerSelect.disabled = true;
        } else {
          trainerSelect.value = '';
          trainerSelect.disabled = false;
        }

        // Reset form
        document.getElementById('memberSearch').value = '';
        const resultsContainer = document.querySelector('#assignMemberModal .search-result-container');
        if (resultsContainer) {
          resultsContainer.innerHTML = '';
          resultsContainer.classList.remove('active');
        }
        document.getElementById('assignMemberBtn').disabled = true;
        selectedMember = null;

        // Show modal
        document.getElementById('assignMemberModal').classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      // Search members
      async function searchMembers(query) {
        const resultsContainer = document.querySelector('#assignMemberModal .search-result-container');
        if (!query || query.length < 2) {
          if (resultsContainer) {
            resultsContainer.innerHTML = '';
            resultsContainer.classList.remove('active');
          }
          return;
        }

        try {
          const response = await fetch(`/api/members/search?q=${encodeURIComponent(query)}`);
          const result = await response.json();

          if (result.success) {
            displaySearchResults(result.data);
          } else {
            if (resultsContainer) {
              resultsContainer.innerHTML = '<div class="search-result-item">No members found</div>';
              resultsContainer.classList.add('active');
            }
          }
        } catch (error) {
          console.error('Error searching members:', error);
          if (resultsContainer) {
            resultsContainer.innerHTML = '<div class="search-result-item">Error searching members</div>';
            resultsContainer.classList.add('active');
          }
        }
      }

      // Display search results
      function displaySearchResults(members) {
        const resultsContainer = document.querySelector('#assignMemberModal .search-result-container');

        if (!resultsContainer) return;

        if (!members || members.length === 0) {
          resultsContainer.innerHTML = '<div class="search-result-item">No members found</div>';
          resultsContainer.classList.add('active');
          return;
        }

        const resultsHTML = members.map(member => `
          <div class="search-result-item" data-member-id="${member.memberId}" data-member-name="${member.fullName}" data-member-email="${member.email}">
            <div class="member-name">${member.fullName}</div>
            <div class="member-details">${member.memberId} • ${member.email}</div>
          </div>
        `).join('');

        resultsContainer.innerHTML = resultsHTML;
        resultsContainer.classList.add('active');

        // Add click listeners to search results
        resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
          item.addEventListener('click', () => {
            selectMember({
              memberId: item.dataset.memberId,
              fullName: item.dataset.memberName,
              email: item.dataset.memberEmail
            });
            resultsContainer.classList.remove('active');
            resultsContainer.innerHTML = '';
          });
        });
      }

      // Select member from search results
      function selectMember(member) {
        selectedMember = member;
        document.getElementById('selectedMemberName').textContent = member.fullName;
        document.getElementById('selectedMemberId').textContent = member.memberId;
        document.getElementById('selectedMemberEmail').textContent = member.email;
        document.getElementById('assignMemberBtn').disabled = false;
      }

      // Remove selected member
      function removeSelectedMember() {
        selectedMember = null;
        document.getElementById('selectedMemberName').textContent = '';
        document.getElementById('selectedMemberId').textContent = '';
        document.getElementById('selectedMemberEmail').textContent = '';
        document.getElementById('assignMemberBtn').disabled = true;
      }

      // Assign member to trainer
      async function assignMemberToTrainer() {
        // Get trainerId from dropdown if not pre-selected
        let trainerId = currentTrainerForAssignment;
        if (!trainerId) {
          trainerId = document.getElementById('selectedTrainerSelect').value;
        }
        if (!selectedMember || !trainerId) {
          toast('Please select a trainer and member first', 'error');
          return;
        }

        try {
          const response = await fetch(`/api/trainers/${trainerId}/assign-member`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              memberId: selectedMember.memberId
            })
          });

          const result = await response.json();

          if (response.ok) {
            toast('Member assigned to trainer successfully!', 'success');
            closeAssignMemberModal();
            fetchTrainerAssignments(); // Refresh assignments table
          } else {
            throw new Error(result.message || 'Failed to assign member to trainer');
          }
        } catch (error) {
          console.error('Error assigning member:', error);
          toast(error.message, 'error');
        }
      }

      // Close assign member modal
      function closeAssignMemberModal() {
        document.getElementById('assignMemberModal').classList.remove('active');
        document.body.style.overflow = '';
        selectedMember = null;
        currentTrainerForAssignment = null;
      }

      // Fetch trainer assignments
      async function fetchTrainerAssignments() {
        try {
          const response = await fetch('/api/trainers/members/all');
          const result = await response.json();

          if (result.success) {
            displayTrainerAssignments(result.data);
          } else {
            console.error('Failed to fetch trainer assignments:', result.message);
          }
        } catch (error) {
          console.error('Error fetching trainer assignments:', error);
        }
      }

      // Display trainer assignments
      function displayTrainerAssignments(trainers) {
        const assignmentsTableBody = document.querySelector('.trainer-assignments-table tbody');

        if (!trainers || trainers.length === 0) {
          assignmentsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No assignments found.</td></tr>';
          return;
        }

        let allAssignments = [];
        let assignmentIndex = 1;

        trainers.forEach(trainer => {
          if (trainer.assignedMembers && trainer.assignedMembers.length > 0) {
            trainer.assignedMembers.forEach((member, idx) => {
              allAssignments.push({
                index: assignmentIndex++,
                trainerId: trainer.trainerId,
                trainerName: trainer.fullName,
                memberId: member.memberId,
                memberName: member.fullName,
                assignedDate: member.assignedDate,
                status: member.status,
                isFirst: idx === 0, // Mark first assignment row for this trainer
                totalAssignments: trainer.assignedMembers.length
              });
            });
          }
          // Do nothing for trainers with no assigned members
        });

        if (allAssignments.length === 0) {
          assignmentsTableBody.innerHTML = '<tr><td colspan="8" class="text-center">No assignments found.</td></tr>';
          return;
        }

        const assignmentsHTML = allAssignments.map(assignment => `
          <tr>
            <td>${assignment.index}</td>
            <td>${assignment.trainerId}</td>
            <td>${assignment.trainerName}</td>
            <td>${assignment.memberId || '-'}</td>
            <td>${assignment.memberName || '-'}</td>
            <td>${assignment.assignedDate ? new Date(assignment.assignedDate).toLocaleDateString() : '-'}</td>
            <td>
              ${assignment.status ? `<span class="status ${assignment.status}">${assignment.status.charAt(0).toUpperCase() + assignment.status.slice(1)}</span>` : '-'}
            </td>
            <td>
              ${assignment.memberId ? `<button class="action-btn delete" data-trainer-id="${assignment.trainerId}" data-member-id="${assignment.memberId}" title="Remove Assignment"><i class="fa-solid fa-trash"></i></button>` : ''}
            </td>
          </tr>
        `).join('');

        assignmentsTableBody.innerHTML = assignmentsHTML;

        // Add event listeners to delete and assign-member buttons
        attachAssignmentDeleteListeners();
      }

      // Attach delete listeners to assignment table
      function attachAssignmentDeleteListeners() {
        document.querySelectorAll('.trainer-assignments-table .action-btn.delete').forEach(btn => {
          btn.addEventListener('click', () => {
            const trainerId = btn.getAttribute('data-trainer-id');
            const memberId = btn.getAttribute('data-member-id');
            if (trainerId && memberId) {
              showAssignmentConfirmationDialog(trainerId, memberId);
            }
          });
        });
      }

      // Show confirmation dialog for assignment removal
      function showAssignmentConfirmationDialog(trainerId, memberId) {
        window.confirmDialog({
          title: 'Remove Assignment',
          message: 'Are you sure you want to remove this member from the trainer? This action cannot be undone.',
          type: 'delete'
        }).then(confirmed => {
          if (confirmed) {
            removeMemberFromTrainer(trainerId, memberId);
          }
        });
      }

      // Remove member from trainer
      async function removeMemberFromTrainer(trainerId, memberId) {
        try {
          const response = await fetch(`/api/trainers/${trainerId}/members/${memberId}`, {
            method: 'DELETE'
          });

          const result = await response.json();

          if (response.ok) {
            toast('Member removed from trainer successfully!', 'success');
            fetchTrainerAssignments(); // Refresh assignments table
          } else {
            throw new Error(result.message || 'Failed to remove member from trainer');
          }
        } catch (error) {
          console.error('Error removing member:', error);
          toast(error.message, 'error');
        }
      }

      // Add event listener for header assign member button
      document.getElementById('assignMemberHeaderBtn').addEventListener('click', function () {
        openAssignMemberModal(); // No trainerId, so modal allows trainer selection
      });
    </script>
  </body>

</html>