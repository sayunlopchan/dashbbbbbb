<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knox Barbell - Members</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Add these styles in the head section */
        .status.new-member {
            background-color: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        /* Status styles for member alerts */
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            color: white;
        }
        .status.pending {
            background-color: #f1c40f;
        }
        .status.active {
            background-color: #2ecc71;
        }
        .status.inactive {
            background-color: #95a5a6;
        }
        .status.cancelled {
            background-color: #e74c3c;
        }
        .status.expiring {
            background-color: #e67e22;
        }
        .status.expired {
            background-color: #c0392b;
        }
    </style>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/members.css">
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Knox Barbell</h3>
            <button class="toggle-btn" id="toggleSidebar">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li>
                <a href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                    <div class="tooltip">Dashboard</div>
                </a>
            </li>
            <li>
                <a href="/members" class="active">
                    <i class="fas fa-user"></i>
                    <span>Member</span>
                    <div class="tooltip">Member</div>
                </a>
            </li>
            <li>
                <a href="/application">
                    <i class="fa-solid fa-file-lines"></i>
                    <span>Application</span>
                    <div class="tooltip">Application</div>
                </a>
            </li>
            <li>
                <a href="/membership">
                    <i class="fas fa-id-card"></i>
                    <span>Membership</span>
                    <div class="tooltip">Membership</div>
                </a>
            </li>
            <li>
                <a href="/trainers">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Trainers</span>
                    <div class="tooltip">Trainers</div>
                </a>
            </li>
            <li>
                <a href="/employee">
                    <i class="fas fa-users"></i>
                    <span>Employee</span>
                    <div class="tooltip">Employee</div>
                </a>
            </li>
            <li>
                <a href="/notifications">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <div class="tooltip">Notifications</div>
                </a>
            </li>
            <li>
                <a href="/attendance">
                    <i class="fas fa-calendar-check"></i>
                    <span>Attendance</span>
                    <div class="tooltip">Attendance</div>
                </a>
            </li>
            <li>
                <a href="/events">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Events</span>
                    <div class="tooltip">Events</div>
                </a>
            </li>
            <li>
                <a href="/finance">
                    <i class="fas fa-wallet"></i>
                    <span>Finance</span>
                    <div class="tooltip">Finance</div>
                </a>
            </li>
            <li>
                <a href="/product">
                    <i class="fas fa-box"></i>
                    <span>Product</span>
                    <div class="tooltip">Product</div>
                </a>
            </li>
            <li class="logout-item">
                <a href="#" id="logoutButton">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                    <div class="tooltip">Logout</div>
                </a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="topbar-left">
                <button class="mobile-toggle" id="mobileToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h3>Members</h3>
            </div>
            <div class="topbar-right">
                <!-- notification  -->
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">0</span>
                    
                    <!-- Notification Modal -->
                    <div class="notification-modal">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <div class="notification-actions">
                                <a href="/notifications" class="view-all-link">View All</a>
                                <button class="close-notifications">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="notification-list">
                            <!-- Notifications will be populated here -->
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="user-greeting">
                    <img src="/img/Knox Logo-01.png" alt="User">
                    <span>Hello, Knox Barbell</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Buttons  -->
            <div class="content-header">
                <h1>Members Management</h1>
                <div class="add-renew-members">
                    <button id="addMemberBtn">
                        <span>+</span>
                        <p>Add Members</p>
                    </button>
                    <button id="renewMemberBtn">
                        <span>+</span>
                        <p>Renew Members</p>
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="filters">
                <!-- gender filter -->
                <div class="filter-group">
                    <label for="gender">Gender:</label>
                    <select id="gender">
                        <option value="">All</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <!-- membership filter -->
                <div class="filter-group">
                    <label for="membership">Memberships:</label>
                    <select id="membership">
                        <option value="">All</option>
                        <option value="silver">Silver</option>
                        <option value="gold">Gold</option>
                        <option value="platinum">Platinum</option>
                        <option value="diamond">Diamond</option>
                    </select>
                </div>
                <!-- search filter -->
                <div class="filter-group search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Search Member..." autocomplete="off">
                </div>
                <!-- day filter -->
                <div class="filter-group download-filter">
                    <select name="download-filter" id="filterDownload">
                        <option value="today" selected>Today</option>
                        <option value="7">Last 7 days</option>
                        <option value="30">Last 30 days</option>
                        <option value="365">Last 12 Months</option>
                    </select>

                    <!-- download and print buttons -->
                    <button class="download" id="downloadMembers"><i class="fa-solid fa-download"></i></button>
                    <button class="print" id="printMembers"><i class="fa-solid fa-print"></i></button>
                    <button class="reset" id="resetFilters" title="Reset Filters">
                        <i class="fa-solid fa-rotate"></i>
                    </button>
                </div>
            </div>

            <!-- Members Table -->
            <div class="table-container">
                <table class="members-table">
                    <!-- Table Header -->
                    <thead>
                        <tr>
                            <th>S.N</th>
                            <th>ID</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Contact</th>
                            <th>Emergency No.</th>
                            <th>Start Date</th>
                            <th>Membership</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <!-- Table Body -->
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td class="member-detail-link" id="kb20">loading...</td>
                            <!-- Clickable ID opens popup with members details, status, attendance, and payment histroy -->
                            <td>Loading...</td>
                            <td>Loading...</td>
                            <td>Loading...</td>
                            <td>Loading...</td>
                            <td>Loading...</td>
                            <td><span class="membership-type silver">Loading...</span></td>

                            <td>
                                <button class="action-btn edit"><i class="fa-solid fa-pen"></i></button>
                                <button class="action-btn delete"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination-controls">
                <button id="prevPage" class="pagination-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span id="pageInfo">Page 1</span>
                <button id="nextPage" class="pagination-btn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>


            <!-- Member Alert Table -->
            <div class="member-alerts">
                <div class="section-header">
                    <span class="section-title">Expiry Alert</span>
                    <a href="/notifications" class="section-view-all">View All</a>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Member Id</th>
                            <th>Members</th>
                            <th>Email Address</th>
                            <th>Status</th>
                            <th>Days</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="memberAlertTableBody">
                        <tr>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                            <td>loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

    </div>

    <!-- Member Detail Modal -->
    <div class="modal-overlay" id="memberDetailModal">
        <div class="modal-content member-detail">
            <div class="modal-header">
                <h2>Member Details</h2>
                <i id="closeDetail" class="fa-regular fa-circle-xmark"></i>
            </div>
            <div class="form-grid">
                <div class="form-group ">
                    <label>Full Name</label>
                    <input type="text" class="fullName" disabled>
                </div>
                <div class="form-group ">
                    <label>Email</label>
                    <input type="email" class="email" disabled>
                </div>
                <div class="form-group">
                    <label>Contact</label>
                    <input type="tel" class="contact" disabled>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" class="address" disabled>
                </div>
                <div class="form-group">
                    <label>Date of Birth</label>
                    <input type="date" class="dateOfBirth" disabled>
                </div>
                <div class="form-group">
                    <label>Emergency Contact Name</label>
                    <input type="text" class="emergencyContactName" disabled>
                </div>
                <div class="form-group">
                    <label>Emergency Contact Relationship</label>
                    <input type="text" class="emergencyContactRelationship" disabled>
                </div>
                <div class="form-group">
                    <label>Emergency Number</label>
                    <input type="tel" class="emergencyNumber" disabled>
                </div>
                <div class="form-group">
                    <label>Membership Type</label>
                    <select class="membershipType" disabled>
                        <option value="silver">Silver (1 Month)</option>
                        <option value="gold">Gold (3 Months)</option>
                        <option value="platinum">Platinum (6 Months)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Membership Start Date</label>
                    <input type="date" class="membershipStartDate" disabled>
                </div>
                <div class="form-group">
                    <label>Membership End Date</label>
                    <input type="date" class="membershipEndDate" disabled>
                </div>
                <div class="form-group">
                    <label>Cancellation Date</label>
                    <input type="date" class="cancellationDate" disabled>
                </div>
                <div class="form-group">
                    <label>Cancellation Reason</label>
                    <input type="text" class="cancellationReason" disabled>
                </div>
                <div class="form-group">
                    <label>Check-in This Month</label>
                    <input type="text" class="attendanceThisMonth" disabled>
                </div>
                <div class="form-group">
                    <label>Payment Status</label>
                    <input type="text" class="paymentStatus" disabled>
                </div>
                <div class="form-group ">
                    <label>Members Status</label>
                    <input type="text" class="memberStatus" disabled>
                </div>
            </div>
            <div class="payment-history">
                <div class="filters">
                    <h3>Payment History</h3>
                    <div class="filter-group download-filter">
                        <select name="download-filter" id="filterDay">
                            <option value="today" selected>Today</option>
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="365">Last 12 Months</option>
                            <option value="all">All Time</option>
                        </select>
                        <select name="download-filter" id="filterMethod">
                            <option value="all" selected>All Methods</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="bank">Bank</option>
                            <option value="online_payment">Online Payment</option>
                        </select>
                        <select name="download-filter" id="filterType">
                            <option value="all" selected>All Types</option>
                            <option value="first_payment">Membership</option>
                            <option value="renewal">Renewal</option>
                            <option value="additional">Product</option>
                        </select>
                        <button class="reset" id="resetPaymentFilters" title="Reset Filters">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                        <button class="download" id="downloadPaymentHistory" title="Download Payment History">
                            <i class="fa-solid fa-download"></i>
                        </button>
                        <button class="print" id="printPaymentHistory" title="Print Payment History">
                            <i class="fa-solid fa-print"></i>
                        </button>
                    </div>
                </div>
                <!-- Finance Table -->
                <div class="table-container">
                    <table class="members-table">
                        <thead>
                            <tr>
                                <th>S.N</th>
                                <th>Payment ID</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Method</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="paymentHistoryTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="loading-spinner">
                                        <i class="fas fa-spinner fa-spin"></i> Loading payment history...
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal-overlay" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Add New Member</h2>
                    <p>Fill in the details to add a new member.</p>
                </div>
                <!-- Close Button -->
                <div>
                    <button class="close-button" id="cancelBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Form -->
            <form class="form-container" id="memberForm">
                <div class="column">
                    <h4>Member Info</h4>
                    <div class="fl-container">
                        <input type="text" id="fullName" placeholder="Full Name" required>
                    </div>
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="tel" id="contact" placeholder="Phone Number" required pattern="[0-9]{10,15}">
                    <input type="text" id="address" placeholder="Address">
                    <div>
                        <label for="dob">Date of Birth</label>
                        <input type="date" id="dateOfBirth" required>
                    </div>
                    <div>
                        <label for="gender">Gender</label>
                        <div class="radio-group" id="genderRadio">
                            <div class="radio-option">
                                <input type="radio" id="genderMale" name="gender" value="male" required>
                                <label for="genderMale">Male</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="genderFemale" name="gender" value="female" required>
                                <label for="genderFemale">Female</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="genderOther" name="gender" value="other" required>
                                <label for="genderOther">Other</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <h4>Emergency Info</h4>
                    <input type="text" id="emergencyContactName" placeholder="Emergency Contact Name" required>
                    <input type="text" id="emergencyContactRelationship" placeholder="Relationship" required>
                    <input type="tel" id="emergencyNumber" placeholder="Emergency Contact Phone" required
                        pattern="[0-9]{10,15}">
                    <h4>Membership</h4>
                    <select id="membershipType" required>
                        <option value="">Select Membership Type</option>
                        <option value="silver">Silver (1 Month)</option>
                        <option value="gold">Gold (3 Months)</option>
                        <option value="diamond">Diamond (6 Months)</option>
                        <option value="platinum">Platinum (12 Months)</option>
                    </select>
                    <div>
                        <label for="membershipStartDate">Membership Start Date</label>
                        <input type="date" id="membershipStartDate" required>
                    </div>
                </div>

                <div class="column">
                    <h4>Member Status</h4>
                    <div class="form-group">
                        <label>Payment Status</label>
                        <div class="radio-group" name="payment">
                            <div class="radio-option">
                                <input type="radio" id="paymentPaid" name="paymentStatus" value="paid" required>
                                <label for="paymentPaid">Paid</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="paymentUnpaid" name="paymentStatus" value="unpaid" required
                                    checked>
                                <label for="paymentUnpaid">Unpaid</label>
                            </div>
                        </div>
                    </div>
                    <div id="paymentAmountContainer" style="display: none;">
                        <div class="form-group">
                            <label for="paymentAmount">Payment Amount</label>
                            <input type="number" id="paymentAmount" name="paymentAmount" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="paymentMethod">Payment Method</label>
                            <select name="paymentMethod" id="paymentMethod">
                                <option value="">Select Payment Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="bank">Bank</option>
                                <option value="online_payment">Online Payment</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn-btn">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div class="modal-overlay" id="editMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Edit Member</h2>
                    <p>Update member details.</p>
                </div>
                <!-- Close Button -->
                <div>
                    <button class="close-button" id="editCancelBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <!-- Form -->
            <form class="edit-form-container" id="editMemberForm">
                <div class="column">
                    <h4>Member Info</h4>
                    <div class="fl-container">
                        <input type="text" id="fullName" placeholder="Full Name" required>
                    </div>
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="tel" id="contact" placeholder="Phone Number" required pattern="[0-9]{10,15}">
                    <input type="text" id="address" placeholder="Address">
                    <div>
                        <label for="dob">Date of Birth</label>
                        <input type="date" id="dateOfBirth" required>
                    </div>
                    <div>
                        <label for="gender">Gender</label>
                        <div class="radio-group" id="genderRadio">
                            <div class="radio-option">
                                <input type="radio" id="genderMale" name="gender" value="male" required>
                                <label for="genderMale">Male</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="genderFemale" name="gender" value="female" required>
                                <label for="genderFemale">Female</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="genderOther" name="gender" value="other" required>
                                <label for="genderOther">Other</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <h4>Emergency Info</h4>
                    <input type="text" id="emergencyContactName" placeholder="Emergency Contact Name" required>
                    <input type="text" id="emergencyContactRelationship" placeholder="Relationship" required>
                    <input type="tel" id="emergencyNumber" placeholder="Emergency Contact Phone" required
                        pattern="[0-9]{10,15}">
                    <h4>Membership</h4>
                    <select id="membershipType" required>
                        <option value="">Select Membership Type</option>
                        <option value="silver">Silver (1 Month)</option>
                        <option value="gold">Gold (3 Months)</option>
                        <option value="diamond">Diamond (6 Months)</option>
                        <option value="platinum">Platinum (12 Months)</option>
                    </select>
                    <div>
                        <label for="membershipStartDate">Membership Start Date</label>
                        <input type="date" id="membershipStartDate" required>
                    </div>
                    <button type="submit" class="btn-btn">Edit Member</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Renew Member Modal -->
    <div class="modal-overlay" id="renewMemberModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2>Renew Member</h2>
                    <p>Search and select a member to renew their membership.</p>
                </div>
                <button class="close-button" id="renewModalCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="renewMemberForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="renewMemberId">Search Member</label>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="renewMemberSearch" placeholder="Search by name or ID..." autocomplete="off">
                            <div class="search-result-container"></div>
                        </div>
                        <input type="hidden" id="renewMemberId" required>
                    </div>
                    <div class="form-group">
                        <label for="renewMembershipType">Membership Type</label>
                        <select name="renewMembershipType" id="renewMembershipType" required>
                            <option value="">Select Membership Type</option>
                            <option value="silver">Silver (1 Month)</option>
                            <option value="gold">Gold (3 Months)</option>
                            <option value="diamond">Diamond (6 Months)</option>
                            <option value="platinum">Platinum (12 Months)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="renewPaymentMethod">Payment Method</label>
                        <select name="renewPaymentMethod" id="renewPaymentMethod" required>
                            <option value="">Select Payment Method</option>
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="bank">Bank</option>
                            <option value="online_payment">Online Payment</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="renewAmount">Amount</label>
                        <input type="number" id="renewAmount" required min="0" step="0.01">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="renewFormCancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary">Renew Membership</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Confirmation Dialog Modal -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="confirmationTitle">Confirm Action</h2>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p id="confirmationMessage">Are you sure you want to proceed with this action?</p>
            </div>
            <div class="form-actions" style="justify-content: center; gap: 20px;">
                <button type="button" class="btn btn-secondary" id="cancelAction">Cancel</button>
                <button type="button" class="btn" id="confirmAction" style="transition: all 0.3s ease;">Confirm</button>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script src="./js/logout.js"></script>  
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // DOM Elements
            const addMemberBtn = document.getElementById('addMemberBtn');
            const renewMemberBtn = document.getElementById('renewMemberBtn');
            const addMemberModal = document.getElementById('addMemberModal');
            const renewMemberModal = document.getElementById('renewMemberModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const memberForm = document.getElementById('memberForm');
            const editMemberModal = document.getElementById('editMemberModal');
            const editMemberForm = document.getElementById('editMemberForm');
            const editCancelBtn = document.getElementById('editCancelBtn');
            const tableBody = document.querySelector(".members-table tbody");
            const genderFilter = document.getElementById("gender");
            const membershipFilter = document.getElementById("membership");
            const searchInput = document.querySelector(".search-box input");
            const prevPageBtn = document.getElementById("prevPage");
            const nextPageBtn = document.getElementById("nextPage");
            const pageInfo = document.getElementById("pageInfo");
            const memberDetailModal = document.getElementById('memberDetailModal');
            const closeDetailBtn = document.getElementById('closeDetail');
            const confirmationModal = document.getElementById('confirmationModal');
            const confirmationTitle = document.getElementById('confirmationTitle');
            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmActionBtn = document.getElementById('confirmAction');
            const cancelActionBtn = document.getElementById('cancelAction');

            let currentAction = null;
            let currentMemberId = null;

            // Show Confirmation Dialog
            function showConfirmationDialog(title, message, action, memberId) {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                currentAction = action;
                currentMemberId = memberId;

                // Update confirm button color based on action
                const confirmBtn = document.getElementById('confirmAction');
                if (action === 'delete') {
                    confirmBtn.style.backgroundColor = '#e74c3c';
                    confirmBtn.style.borderColor = '#e74c3c';
                    confirmBtn.style.color = 'white';
                }

                confirmationModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            // Hide Confirmation Dialog
            function hideConfirmationDialog() {
                confirmationModal.classList.remove('active');
                document.body.style.overflow = '';
                currentAction = null;
                currentMemberId = null;

                // Reset confirm button color
                const confirmBtn = document.getElementById('confirmAction');
                confirmBtn.style.backgroundColor = '';
                confirmBtn.style.borderColor = '';
                confirmBtn.style.color = '';
            }

            // Confirmation Dialog Event Listeners
            confirmActionBtn.addEventListener('click', async () => {
                if (currentAction === 'delete' && currentMemberId) {
                    try {
                        const response = await fetch(`/api/members/${currentMemberId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            window.toast('Member deleted successfully!', 'success');
                            confirmationModal.classList.remove('active');
                            fetchMembers();
                        } else {
                            const error = await response.json();
                            window.toast(error.message || 'Failed to delete member', 'error');
                        }
                    } catch (error) {
                        window.toast('Error: ' + error.message, 'error');
                    }
                } else if (currentAction === 'delete_payment' && currentMemberId) {
                    try {
                        const response = await fetch(`${baseUrl}/api/payments/${currentMemberId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });

                        if (response.ok) {
                            window.toast('Payment deleted successfully!', 'success');
                            confirmationModal.classList.remove('active');
                            // Refresh payment history
                            const memberId = document.querySelector('.member-detail-link').id;
                            if (memberId) {
                                fetchPaymentHistory(memberId);
                            }
                        } else {
                            const error = await response.json();
                            window.toast(error.message || 'Failed to delete payment', 'error');
                        }
                    } catch (error) {
                        window.toast('Error: ' + error.message, 'error');
                    }
                }
            });

            cancelActionBtn.addEventListener('click', hideConfirmationDialog);

            // Close modal when clicking outside
            confirmationModal.addEventListener('click', (e) => {
                if (e.target === confirmationModal) {
                    hideConfirmationDialog();
                }
            });

            // Delete member handler
            tableBody.addEventListener("click", async (e) => {
                if (e.target.closest(".delete")) {
                    const memberId = e.target.closest("button").dataset.id;
                    if (memberId) {
                        const confirmed = await window.confirmDialog({
                            title: 'Delete Member',
                            message: 'Are you sure you want to delete this member? This action cannot be undone.',
                            type: 'delete'
                        });

                        if (!confirmed) return;

                        try {
                            const response = await fetch(`/api/members/${memberId}`, {
                                method: 'DELETE'
                            });

                            if (response.ok) {
                                window.toast('Member deleted successfully!', 'success');
                                fetchMembers();
                            } else {
                                const error = await response.json();
                                window.toast(error.message || 'Failed to delete member', 'error');
                            }
                        } catch (error) {
                            window.toast('Error: ' + error.message, 'error');
                        }
                    }
                }
            });

            // Modal Handling for Add Member
            addMemberBtn.addEventListener('click', function () {
                resetModal();
                addMemberModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            // Close modal function
            function closeModal() {
                addMemberModal.classList.remove('active');
                document.body.style.overflow = '';
                resetModal();
            }

            // Close modals when clicking cancel button
            cancelBtn.addEventListener('click', closeModal);

            // Close modals when clicking outside
            addMemberModal.addEventListener('click', function (e) {
                if (e.target === addMemberModal) {
                    closeModal();
                }
            });

            // Reset add member modal form
            function resetModal() {
                memberForm.reset();
                document.querySelector('#addMemberModal .modal-header h2').textContent = 'Add New Member';
                document.querySelector('#memberForm button[type="submit"]').textContent = 'Add Member';
                memberForm.dataset.mode = 'add';
                delete memberForm.dataset.memberId;
                
                // Reset payment status and hide payment amount container
                const paymentAmountContainer = document.getElementById('paymentAmountContainer');
                const paymentAmount = document.getElementById('paymentAmount');
                const paymentMethod = document.getElementById('paymentMethod');
                
                if (paymentAmountContainer) {
                    paymentAmountContainer.style.display = 'none';
                }
                if (paymentAmount) {
                    paymentAmount.removeAttribute('required');
                    paymentAmount.value = '';
                }
                if (paymentMethod) {
                    paymentMethod.removeAttribute('required');
                    paymentMethod.value = '';
                }
                
                // Reset payment status radio buttons
                const unpaidRadio = document.getElementById('paymentUnpaid');
                if (unpaidRadio) {
                    unpaidRadio.checked = true;
                }
            }

            // Modal Handling for Edit Member
            tableBody.addEventListener('click', async function (e) {
                const editBtn = e.target.closest('.edit');
                if (editBtn) {
                    const memberId = editBtn.dataset.id;
                    if (!memberId) return;

                    try {
                        const response = await fetch(`/api/members/${memberId}`);
                        const result = await response.json();

                        if (result.success) {
                            const member = result.data;
                            populateEditForm(member);
                            editMemberModal.classList.add('active');
                            document.body.style.overflow = 'hidden';
                        } else {
                            window.toast('Failed to fetch member details: ' + result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching member details:', error);
                        window.toast('Failed to fetch member details. Please try again.', 'error');
                    }
                }
            });

            // Populate edit form with member data
            function populateEditForm(member) {
                const form = editMemberForm;
                form.dataset.memberId = member.memberId;

                // Populate basic info
                form.querySelector('#fullName').value = member.fullName || '';
                form.querySelector('#email').value = member.email || '';
                form.querySelector('#contact').value = member.contact || '';
                form.querySelector('#address').value = member.address || '';
                form.querySelector('#dateOfBirth').value = member.dateOfBirth ? new Date(member.dateOfBirth).toISOString().split('T')[0] : '';

                // Set gender
                const genderRadio = form.querySelector(`input[name="gender"][value="${member.gender}"]`);
                if (genderRadio) genderRadio.checked = true;

                // Populate emergency info
                form.querySelector('#emergencyContactName').value = member.emergencyContactName || '';
                form.querySelector('#emergencyContactRelationship').value = member.emergencyContactRelationship || '';
                form.querySelector('#emergencyNumber').value = member.emergencyNumber || '';

                // Populate membership info
                form.querySelector('#membershipType').value = member.membershipType || '';
                form.querySelector('#membershipStartDate').value = member.startDate ? new Date(member.startDate).toISOString().split('T')[0] : '';
            }

            // Reset edit modal form
            function resetEditModal() {
                if (editMemberForm) {
                    editMemberForm.reset();
                    delete editMemberForm.dataset.memberId;
                }
            }

            // Pagination state
            let currentPage = 1;
            let totalPages = 1;
            const itemsPerPage = 10;
            let allMembers = []; // Store all members

            // Fetch and render members
            async function fetchMembers(page = 1) {
                const gender = genderFilter.value;
                const membership = membershipFilter.value;
                const search = searchInput.value.trim();

                let query = [];
                if (gender) query.push(`gender=${gender}`);
                if (membership) query.push(`membershipType=${membership}`);
                if (search) query.push(`search=${search}`);
                // Remove page and limit from query to get all data
                const queryString = query.length ? "?" + query.join("&") : "";

                try {
                    const res = await fetch(`/api/members${queryString}`);
                    const response = await res.json();

                    if (response.success) {
                        // Store all members
                        allMembers = response.data;

                        // Calculate pagination
                        const startIndex = (page - 1) * itemsPerPage;
                        const endIndex = startIndex + itemsPerPage;
                        const paginatedMembers = allMembers.slice(startIndex, endIndex);

                        // Calculate total pages
                        totalPages = Math.ceil(allMembers.length / itemsPerPage);

                        // Render the table with paginated data
                        renderTable(paginatedMembers);

                        // Update pagination
                        updatePagination({
                            currentPage: page,
                            totalPages: totalPages,
                            total: allMembers.length
                        });
                    } else {
                        console.error('Failed to fetch members:', response.message);
                        window.toast('Failed to fetch members: ' + response.message, 'error');
                        tableBody.innerHTML = `<tr><td colspan="9" class="text-center">Error loading members. Please try again.</td></tr>`;
                        // Reset pagination on error
                        updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
                    }
                } catch (error) {
                    console.error('Error fetching members:', error);
                    window.toast('Error loading members. Please try again.', 'error');
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center">Error loading members. Please try again.</td></tr>`;
                    // Reset pagination on error
                    updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
                }
            }

            function updatePagination(paginationData) {
                // Ensure we have valid numbers for pagination
                currentPage = parseInt(paginationData.currentPage) || 1;
                totalPages = parseInt(paginationData.totalPages) || 1;

                console.log('Updating pagination:', { currentPage, totalPages, total: paginationData.total }); // Debug log

                // Update page info with proper number formatting
                pageInfo.textContent = `Page ${currentPage} of ${totalPages} (Total: ${paginationData.total} members)`;

                // Update button states
                prevPageBtn.disabled = currentPage <= 1;
                nextPageBtn.disabled = currentPage >= totalPages;

                // Add visual feedback for disabled state
                prevPageBtn.classList.toggle('disabled', currentPage <= 1);
                nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
            }

            function renderTable(members) {
                tableBody.innerHTML = ""; // Clear previous

                if (!members || !Array.isArray(members) || members.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center">No members found.</td></tr>`;
                    return;
                }

                const currentDate = new Date();

                members.forEach((member, index) => {
                    if (!member) return; // Skip invalid members

                    const tr = document.createElement("tr");
                    const rowNumber = ((currentPage - 1) * itemsPerPage) + index + 1;

                    // Format dates safely with validation
                    const startDate = member.startDate ?
                        (() => {
                            const date = new Date(member.startDate);
                            return !isNaN(date.getTime()) ? date.toLocaleDateString() : 'N/A';
                        })() 
                        : 'N/A';

                    // Safely access nested properties with optional chaining
                    const membershipType = member.membershipType?.toLowerCase() || 'silver';
                    const membershipDisplay = member.membershipType || 'N/A';

                    // Add status class based on member status
                    const statusClass = member.memberStatus === 'cancelled' ? 'cancelled' : membershipType;

                    // For the main table, just show 'Cancelled' without time information
                    const statusDisplay = member.memberStatus === 'cancelled' ? 'Cancelled' : membershipDisplay;

                    tr.innerHTML = `
                        <td>${rowNumber}</td>
                        <td class="member-detail-link" id="${member.memberId || ''}">${member.memberId || 'N/A'}</td>
                        <td>${member.fullName || 'N/A'}</td>
                        <td>${member.email || 'N/A'}</td>
                        <td>${member.contact || 'N/A'}</td>
                        <td>${member.emergencyNumber || 'N/A'}</td>
                        <td>${startDate}</td>
                        <td>
                            <span class="membership-type ${statusClass}">
                                ${statusDisplay}
                            </span>
                        </td>
                        <td>
                            <button class="action-btn edit" data-id="${member.memberId || ''}" ${!member.memberId ? 'disabled' : ''}>
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="action-btn delete" data-id="${member.memberId || ''}" ${!member.memberId ? 'disabled' : ''}>
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            // Pagination event listeners
            prevPageBtn.addEventListener("click", () => {
                if (currentPage > 1) {
                    fetchMembers(currentPage - 1);
                }
            });

            nextPageBtn.addEventListener("click", () => {
                if (currentPage < totalPages) {
                    fetchMembers(currentPage + 1);
                }
            });

            // Filters and search event listeners
            genderFilter.addEventListener("change", () => {
                currentPage = 1; // Reset to first page on filter change
                fetchMembers(currentPage);
            });
            membershipFilter.addEventListener("change", () => {
                currentPage = 1; // Reset to first page on filter change
                fetchMembers(currentPage);
            });
            searchInput.addEventListener("input", debounce(() => {
                currentPage = 1; // Reset to first page on search
                fetchMembers(currentPage);
            }, 300));

            // Debounce to avoid too many calls
            function debounce(func, delay) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), delay);
                };
            }

            // Modal Handling for Member Details
            tableBody.addEventListener('click', async function (e) {
                const memberIdCell = e.target.closest('.member-detail-link');
                if (memberIdCell) {
                    const memberId = memberIdCell.id;
                    if (!memberId) return;

                    try {
                        const response = await fetch(`/api/members/${memberId}`);
                        const result = await response.json();

                        if (result.success) {
                            const member = result.data;
                            populateMemberDetails(member);
                            memberDetailModal.classList.add('active');
                            document.body.style.overflow = 'hidden';
                        } else {
                            alert('Failed to fetch member details: ' + result.message);
                        }
                    } catch (error) {
                        console.error('Error fetching member details:', error);
                        alert('Failed to fetch member details. Please try again.');
                    }
                }
            });

            // Close member detail modal
            closeDetailBtn.addEventListener('click', function () {
                memberDetailModal.classList.remove('active');
                document.body.style.overflow = '';
            });

            // Close member detail modal when clicking outside
            memberDetailModal.addEventListener('click', function (e) {
                if (e.target === memberDetailModal) {
                    memberDetailModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });

            // Populate member details in the modal
            async function populateMemberDetails(member) {
                // Basic Info
                memberDetailModal.querySelector('.fullName').value = member.fullName || '';
                memberDetailModal.querySelector('.email').value = member.email || '';
                memberDetailModal.querySelector('.contact').value = member.contact || '';
                memberDetailModal.querySelector('.address').value = member.address || '';
                memberDetailModal.querySelector('.dateOfBirth').value = member.dateOfBirth ? new Date(member.dateOfBirth).toISOString().split('T')[0] : '';

                // Emergency Info
                memberDetailModal.querySelector('.emergencyContactName').value = member.emergencyContactName || '';
                memberDetailModal.querySelector('.emergencyContactRelationship').value = member.emergencyContactRelationship || '';
                memberDetailModal.querySelector('.emergencyNumber').value = member.emergencyNumber || '';

                // Membership Info
                memberDetailModal.querySelector('.membershipType').value = member.membershipType || '';
                memberDetailModal.querySelector('.membershipStartDate').value = member.startDate ? new Date(member.startDate).toISOString().split('T')[0] : '';
                memberDetailModal.querySelector('.membershipEndDate').value = member.endDate ? new Date(member.endDate).toISOString().split('T')[0] : '';

                // Cancellation Info
                memberDetailModal.querySelector('.cancellationDate').value = member.cancellationDate ? new Date(member.cancellationDate).toISOString().split('T')[0] : '';
                memberDetailModal.querySelector('.cancellationReason').value = member.cancellationReason || '';

                // MemberStatus
                const statusInput = memberDetailModal.querySelector('.memberStatus');
                if (statusInput && member.memberStatus) {
                    const validStatuses = ['pending', 'active', 'inactive', 'cancelled', 'expiring', 'expired'];
                    if (validStatuses.includes(member.memberStatus)) {
                        statusInput.value = member.memberStatus;
                    } else {
                        statusInput.value = 'unknown';
                    }
                }

                // Payment Status
                const paymentStatusInput = memberDetailModal.querySelector('.paymentStatus');
                if (paymentStatusInput) {
                    if (member.payments && member.payments.length > 0) {
                        const latestPayment = member.payments.sort((a, b) => new Date(b.paymentDate) - new Date(a.paymentDate))[0];
                        const statusMap = {
                            pending: "Pending",
                            completed: "Completed",
                            failed: "Failed"
                        };
                        paymentStatusInput.value = statusMap[latestPayment.status] || 'Unknown';
                    } else {
                        paymentStatusInput.value = 'No Payment';
                    }
                }

                // Fetch attendance for current month
                try {
                    const attendanceResponse = await fetch(`${baseUrl}/api/attendances/member/${member.memberId}`);
                    const attendanceData = await attendanceResponse.json();

                    if (attendanceData.success) {
                        const currentMonth = new Date().getMonth();
                        const currentYear = new Date().getFullYear();
                        
                        // Filter attendance records for current month
                        const currentMonthAttendance = attendanceData.data.filter(record => {
                            const recordDate = new Date(record.date);
                            return recordDate.getMonth() === currentMonth && 
                                   recordDate.getFullYear() === currentYear;
                        });

                        // Update attendance input
                        const attendanceInput = memberDetailModal.querySelector('.attendanceThisMonth');
                        if (attendanceInput) {
                            attendanceInput.value = `${currentMonthAttendance.length} Check-in this Month`;
                        }
                    } else {
                        console.error('Failed to fetch attendance:', attendanceData.message);
                        const attendanceInput = memberDetailModal.querySelector('.attendanceThisMonth');
                        if (attendanceInput) {
                            attendanceInput.value = 'Error fetching attendance';
                        }
                    }
                } catch (error) {
                    console.error('Error fetching attendance:', error);
                    const attendanceInput = memberDetailModal.querySelector('.attendanceThisMonth');
                    if (attendanceInput) {
                        attendanceInput.value = 'Error fetching attendance';
                    }
                }

                // Fetch and display payment history
                fetchPaymentHistory(member.memberId);
            }

            // Store payment data globally
            let allPayments = [];

            // Function to fetch payment history
            async function fetchPaymentHistory(memberId) {
                const paymentHistoryTableBody = document.getElementById('paymentHistoryTableBody');
                if (!paymentHistoryTableBody) return;

                try {
                    // Show loading state
                    paymentHistoryTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="loading-spinner">
                                    <i class="fas fa-spinner fa-spin"></i> Loading payment history...
                                </div>
                            </td>
                        </tr>
                    `;

                    const response = await fetch(`/api/payments/member/${memberId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch payment history');
                    }

                    const data = await response.json();
                    
                    if (data.success && Array.isArray(data.data)) {
                        allPayments = data.data;
                        applyPaymentFilters();
                    } else {
                        throw new Error('Invalid payment history data structure');
                    }
                } catch (error) {
                    console.error('Error in fetchPaymentHistory:', error);
                    paymentHistoryTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">Error loading payment history: ${error.message}</td>
                        </tr>
                    `;
                }
            }

            // Function to apply filters to payment history
            function applyPaymentFilters() {
                const paymentHistoryTableBody = document.getElementById('paymentHistoryTableBody');
                if (!paymentHistoryTableBody) return;

                const filterDay = document.getElementById('filterDay').value;
                const filterMethod = document.getElementById('filterMethod').value;
                const filterType = document.getElementById('filterType').value;

                let filteredPayments = [...allPayments];

                // Filter by date range
                if (filterDay !== 'all') {
                    const now = new Date();
                    const startDate = new Date();
                    
                    switch (filterDay) {
                        case 'today':
                            startDate.setHours(0, 0, 0, 0);
                            break;
                        case '7':
                            startDate.setDate(now.getDate() - 7);
                            break;
                        case '30':
                            startDate.setDate(now.getDate() - 30);
                            break;
                        case '365':
                            startDate.setFullYear(now.getFullYear() - 1);
                            break;
                    }

                    filteredPayments = filteredPayments.filter(payment => {
                        const paymentDate = new Date(payment.paymentDate);
                        return paymentDate >= startDate && paymentDate <= now;
                    });
                }

                // Filter by payment method
                if (filterMethod !== 'all') {
                    filteredPayments = filteredPayments.filter(payment => 
                        payment.paymentMethod === filterMethod
                    );
                }

                // Filter by payment type
                if (filterType !== 'all') {
                    filteredPayments = filteredPayments.filter(payment => {
                        switch (filterType) {
                            case 'first_payment':
                                return payment.paymentType === 'membership';
                            case 'renewal':
                                return payment.paymentType === 'renewal';
                            case 'additional':
                                return payment.paymentType === 'product';
                            default:
                                return true;
                        }
                    });
                }

                // Render filtered results
                if (filteredPayments.length === 0) {
                    paymentHistoryTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">No payment history found for the selected filters</td>
                        </tr>
                    `;
                    return;
                }

                paymentHistoryTableBody.innerHTML = '';
                filteredPayments.forEach((payment, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${payment.paymentId}</td>
                        <td>${formatCurrency(payment.amount)}</td>
                        <td>${formatDate(payment.paymentDate)}</td>
                        <td>${payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1)}</td>
                        <td>${getPaymentMethodIcon(payment.paymentMethod)} ${payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)}</td>
                        <td>
                            <button class="action-btn delete" data-payment-id="${payment.paymentId}" title="Delete Payment">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    paymentHistoryTableBody.appendChild(row);
                });

                // Add event listeners for delete buttons
                const deleteButtons = paymentHistoryTableBody.querySelectorAll('.delete');
                deleteButtons.forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const paymentId = e.currentTarget.dataset.paymentId;
                        if (paymentId) {
                            showConfirmationDialog(
                                'Delete Payment',
                                'Are you sure you want to delete this payment record? This action cannot be undone.',
                                'delete_payment',
                                paymentId
                            );
                        }
                    });
                });
            }

            // Add event listeners for payment history filters
            document.getElementById('filterDay').addEventListener('change', applyPaymentFilters);
            document.getElementById('filterMethod').addEventListener('change', applyPaymentFilters);
            document.getElementById('filterType').addEventListener('change', applyPaymentFilters);

            // Add reset button event listener
            document.getElementById('resetPaymentFilters').addEventListener('click', () => {
                document.getElementById('filterDay').value = 'today';
                document.getElementById('filterMethod').value = 'all';
                document.getElementById('filterType').value = 'all';
                applyPaymentFilters();
            });

            // Helper function to format currency
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'NPR',
                    maximumFractionDigits: 0
                }).format(amount);
            }

            // Helper function to format date
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            }

            // Helper function to get payment method icon
            function getPaymentMethodIcon(method) {
                switch (method) {
                    case 'cash':
                        return '<i class="fa-solid fa-money-bill"></i>';
                    case 'card':
                        return '<i class="fa-solid fa-credit-card"></i>';
                    case 'bank':
                        return '<i class="fa-solid fa-university"></i>';
                    case 'online_payment':
                        return '<i class="fa-solid fa-globe"></i>';
                    default:
                        return '<i class="fa-solid fa-money-bill"></i>';
                }
            }

            // Function to handle member form submission
            async function handleMemberSubmit(e) {
                e.preventDefault();

                try {
                    // Get form data
                    const formData = {
                        fullName: document.getElementById('fullName').value,
                        email: document.getElementById('email').value,
                        contact: document.getElementById('contact').value,
                        address: document.getElementById('address').value,
                        dateOfBirth: document.getElementById('dateOfBirth').value,
                        gender: document.querySelector('input[name="gender"]:checked').value,
                        emergencyContactName: document.getElementById('emergencyContactName').value,
                        emergencyContactRelationship: document.getElementById('emergencyContactRelationship').value,
                        emergencyNumber: document.getElementById('emergencyNumber').value,
                        membershipType: document.getElementById('membershipType').value,
                        startDate: document.getElementById('membershipStartDate').value,
                        memberStatus: 'pending'
                    };

                    console.log('Creating member with data:', formData);

                    // Create member
                    const memberResponse = await fetch('/api/members', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(formData)
                    });

                    if (!memberResponse.ok) {
                        const errorData = await memberResponse.json();
                        throw new Error(errorData.message || 'Failed to create member');
                    }

                    const memberData = await memberResponse.json();
                    console.log('Member created successfully:', memberData);

                    // If payment is marked as paid, create payment record
                    const paymentStatus = document.querySelector('input[name="paymentStatus"]:checked').value;
                    if (paymentStatus === 'paid') {
                        const paymentAmount = document.getElementById('paymentAmount').value;
                        const paymentMethod = document.getElementById('paymentMethod').value;

                        if (!paymentAmount || !paymentMethod) {
                            throw new Error('Payment amount and method are required for paid status');
                        }

                        const paymentData = {
                            amount: parseFloat(paymentAmount),
                            paymentMethod: paymentMethod,
                            paymentType: 'membership',
                            paymentDate: new Date(),
                            description: `Initial payment for ${formData.membershipType} membership`
                        };

                        console.log('Creating payment with data:', paymentData);

                        // Create payment using the member's ID
                        const paymentResponse = await fetch(`/api/payments/member/${memberData.data.memberId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify(paymentData)
                        });

                        if (!paymentResponse.ok) {
                            const errorData = await paymentResponse.json();
                            throw new Error(errorData.message || 'Failed to create payment');
                        }

                        console.log('Payment created successfully');
                    }

                    // Close modal and refresh member list
                    closeModal();
                    window.toast('Member added successfully', 'success');
                    fetchMembers();

                } catch (error) {
                    console.error('Error in handleMemberSubmit:', error);
                    window.toast(error.message || 'Failed to add member', 'error');
                }
            }

            // Add event listener for payment status change
            document.querySelectorAll('input[name="paymentStatus"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const paymentAmountContainer = document.getElementById('paymentAmountContainer');
                    const paymentAmount = document.getElementById('paymentAmount');
                    const paymentMethod = document.getElementById('paymentMethod');

                    if (e.target.value === 'paid') {
                        paymentAmountContainer.style.display = 'block';
                        paymentAmount.setAttribute('required', '');
                        paymentMethod.setAttribute('required', '');
                    } else {
                        paymentAmountContainer.style.display = 'none';
                        paymentAmount.removeAttribute('required');
                        paymentMethod.removeAttribute('required');
                        paymentAmount.value = '';
                        paymentMethod.value = '';
                    }
                });
            });

            // Add form submit event listener
            document.getElementById('memberForm').addEventListener('submit', handleMemberSubmit);

            // Reset filters button
            document.getElementById('resetFilters').addEventListener('click', () => {
                currentPage = 1;
                document.querySelector('.search-box input').value = '';
                document.getElementById('gender').value = '';
                document.getElementById('membership').value = '';
                fetchMembers(1);
            });

            // Modal Handling for Renew Member
            renewMemberBtn.addEventListener('click', function () {
                renewMemberModal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });

            // Close renew modal when clicking header close button
            const renewModalCloseBtn = document.getElementById('renewModalCloseBtn');
            if (renewModalCloseBtn) {
                renewModalCloseBtn.addEventListener('click', function () {
                    renewMemberModal.classList.remove('active');
                    document.body.style.overflow = '';
                    document.getElementById('renewMemberForm').reset();
                });
            }

            // Close renew modal when clicking form cancel button
            const renewFormCancelBtn = document.getElementById('renewFormCancelBtn');
            if (renewFormCancelBtn) {
                renewFormCancelBtn.addEventListener('click', function () {
                    renewMemberModal.classList.remove('active');
                    document.body.style.overflow = '';
                    document.getElementById('renewMemberForm').reset();
                });
            }

            // Close renew modal when clicking outside
            renewMemberModal.addEventListener('click', function (e) {
                if (e.target === renewMemberModal) {
                    renewMemberModal.classList.remove('active');
                    document.body.style.overflow = '';
                    document.getElementById('renewMemberForm').reset();
                }
            });

            // Add this to your existing DOMContentLoaded event listener
            const renewMemberSearch = document.getElementById('renewMemberSearch');
            const searchResultContainer = document.querySelector('#renewMemberModal .search-result-container');

            // Handle member search
            renewMemberSearch.addEventListener('input', debounce(async function (e) {
                const searchTerm = e.target.value.trim();
                if (searchTerm.length < 2) {
                    searchResultContainer.innerHTML = '';
                    return;
                }

                try {
                    const response = await fetch(`/api/members/search?q=${encodeURIComponent(searchTerm)}`);
                    const result = await response.json();

                    if (result.success) {
                        const members = result.data;
                        searchResultContainer.innerHTML = '';

                        if (members.length === 0) {
                            searchResultContainer.innerHTML = '<div class="no-results">No members found</div>';
                            return;
                        }

                        members.forEach(member => {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.innerHTML = `
                                <div class="search-result-primary">
                                    <strong>${member.fullName}</strong>
                                    <span>${member.memberId}</span>
                                </div>
                                <div class="search-result-secondary">
                                    <small>${member.email} • ${member.contact}</small>
                                </div>
                            `;
                            div.addEventListener('click', () => {
                                document.getElementById('renewMemberId').value = member.memberId;
                                renewMemberSearch.value = `${member.fullName} (${member.memberId})`;
                                searchResultContainer.innerHTML = '';
                            });
                            searchResultContainer.appendChild(div);
                        });
                    } else {
                        searchResultContainer.innerHTML = '<div class="no-results">Error searching members</div>';
                    }
                } catch (error) {
                    console.error('Error searching members:', error);
                    searchResultContainer.innerHTML = '<div class="no-results">Error searching members</div>';
                }
            }, 300));

            // Close search results when clicking outside
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.search-box')) {
                    searchResultContainer.innerHTML = '';
                }
            });

            // Handle renew member form submission
            const renewMemberForm = document.getElementById('renewMemberForm');
            if (renewMemberForm) {
                renewMemberForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const memberId = document.getElementById('renewMemberId').value;
                    if (!memberId) {
                        window.toast('Please select a member first', 'error');
                        return;
                    }

                    const membershipType = document.getElementById('renewMembershipType').value;
                    const paymentMethod = document.getElementById('renewPaymentMethod').value;
                    const paymentAmount = document.getElementById('renewAmount').value;

                    if (!paymentAmount || paymentAmount <= 0) {
                        window.toast('Please enter a valid payment amount', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`/api/members/${memberId}/renew`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                membershipType,
                                paymentMethod,
                                paymentAmount: parseFloat(paymentAmount)
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            window.toast('Membership renewed successfully', 'success');
                            renewMemberModal.classList.remove('active');
                            document.body.style.overflow = '';
                            fetchMembers(); // Refresh the member list
                        } else {
                            window.toast(result.message || 'Failed to renew membership', 'error');
                        }
                    } catch (error) {
                        console.error('Error renewing membership:', error);
                        window.toast('Failed to renew membership. Please try again.', 'error');
                    }
                });
            }

            // Add download button event listener
            document.getElementById('downloadMembers').addEventListener('click', async () => {
                try {
                    // Get download filter value
                    const downloadFilter = document.getElementById('filterDownload').value;

                    // Calculate start date based on filter
                    const calculateStartDate = (days) => {
                        const startDate = new Date();
                        if (days === 'today') {
                            startDate.setHours(0, 0, 0, 0);
                        } else {
                            startDate.setDate(startDate.getDate() - parseInt(days));
                        }
                        return startDate.toISOString().split('T')[0];
                    };

                    // Prepare query parameters
                    const params = new URLSearchParams({
                        startDate: calculateStartDate(downloadFilter),
                        limit: 1000
                    });

                    // Fetch members data for the selected time range
                    const response = await fetch(`/api/members?${params}`);
                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.message || 'Failed to fetch members data');
                    }

                    // Create CSV content
                    const headers = ['S.N', 'Member ID', 'Full Name', 'Email', 'Contact', 'Emergency No.', 'Joined Date', 'Membership'];
                    const csvContent = [
                        headers.join(','),
                        ...result.data.map((member, index) => [
                            index + 1,
                            member.memberId,
                            member.fullName,
                            member.email,
                            member.contact,
                            member.emergencyNumber,
                            formatDate(member.startDate),
                            member.membershipType
                        ].join(','))
                    ].join('\n');

                    // Create and download file
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    const date = new Date().toISOString().split('T')[0];
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `members_list_${downloadFilter}_${date}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    window.toast(`Members list downloaded for ${downloadFilter} in CSV`, 'success');
                } catch (error) {
                    console.error('Download error:', error);
                    window.toast('Failed to download members list', 'error');
                }
            });

            // Add print button event listener
            document.getElementById('printMembers').addEventListener('click', async () => {
                try {
                    // Get download filter value
                    const downloadFilter = document.getElementById('filterDownload').value;

                    // Calculate start date based on filter
                    const calculateStartDate = (days) => {
                        const startDate = new Date();
                        if (days === 'today') {
                            startDate.setHours(0, 0, 0, 0);
                        } else {
                            startDate.setDate(startDate.getDate() - parseInt(days));
                        }
                        return startDate.toISOString().split('T')[0];
                    };

                    // Prepare query parameters
                    const params = new URLSearchParams({
                        startDate: calculateStartDate(downloadFilter),
                        limit: 1000
                    });

                    // Fetch members data for the selected time range
                    const response = await fetch(`/api/members?${params}`);
                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.message || 'Failed to fetch members data');
                    }

                    // Create print window
                    const printWindow = window.open('', '_blank');

                    // Create print content
                    const printContent = `
                        <html>
                            <head>
                                <title>Members List</title>
                                <style>
                                    body { font-family: Arial, sans-serif; }
                                    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                    th { background-color: #f5f5f5; }
                                    h1 { text-align: center; }
                                    .header { margin-bottom: 20px; }
                                    .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <h1>Members List</h1>
                                    <p>Period: ${downloadFilter}</p>
                                    <p>Generated on: ${new Date().toLocaleString()}</p>
                                </div>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>S.N</th>
                                            <th>Member ID</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Contact</th>
                                            <th>Emergency No.</th>
                                            <th>Joined Date</th>
                                            <th>Membership</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.data.map((member, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${member.memberId}</td>
                                                <td>${member.fullName}</td>
                                                <td>${member.email}</td>
                                                <td>${member.contact}</td>
                                                <td>${member.emergencyNumber}</td>
                                                <td>${formatDate(member.startDate)}</td>
                                                <td>${member.membershipType}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <div class="footer">
                                    <p>© ${new Date().getFullYear()} Knox Barbell - Members List</p>
                                </div>
                                <div class="no-print" style="margin-top: 20px; text-align: center;">
                                </div>
                            </body>
                        </html>
                    `;

                    // Write content to print window
                    printWindow.document.write(printContent);
                    printWindow.document.close();

                    // Wait for content to load then print
                    printWindow.onload = function () {
                        printWindow.print();
                        printWindow.close();
                    };

                    window.toast('Printing members list...', 'success');
                } catch (error) {
                    console.error('Print error:', error);
                    window.toast('Failed to print members list', 'error');
                }
            });

            // Add download button event listener for payment history
            document.getElementById('downloadPaymentHistory').addEventListener('click', () => {
                // Get the filtered payments
                const filteredPayments = allPayments.filter(payment => {
                    const filterDay = document.getElementById('filterDay').value;
                    const filterMethod = document.getElementById('filterMethod').value;
                    const filterType = document.getElementById('filterType').value;

                    // Filter by date range
                    if (filterDay !== 'all') {
                        const now = new Date();
                        const startDate = new Date();
                        
                        switch (filterDay) {
                            case 'today':
                                startDate.setHours(0, 0, 0, 0);
                                break;
                            case '7':
                                startDate.setDate(now.getDate() - 7);
                                break;
                            case '30':
                                startDate.setDate(now.getDate() - 30);
                                break;
                            case '365':
                                startDate.setFullYear(now.getFullYear() - 1);
                                break;
                        }

                        const paymentDate = new Date(payment.paymentDate);
                        if (paymentDate < startDate || paymentDate > now) {
                            return false;
                        }
                    }

                    // Filter by payment method
                    if (filterMethod !== 'all' && payment.paymentMethod !== filterMethod) {
                        return false;
                    }

                    // Filter by payment type
                    if (filterType !== 'all') {
                        switch (filterType) {
                            case 'first_payment':
                                if (payment.paymentType !== 'membership') return false;
                                break;
                            case 'renewal':
                                if (payment.paymentType !== 'renewal') return false;
                                break;
                            case 'additional':
                                if (payment.paymentType !== 'product') return false;
                                break;
                        }
                    }

                    return true;
                });

                if (filteredPayments.length === 0) {
                    window.toast('No payment data to download', 'error');
                    return;
                }

                // Create CSV content
                const headers = ['S.N', 'Payment ID', 'Amount', 'Date', 'Type', 'Method'];
                const csvContent = [
                    headers.join(','),
                    ...filteredPayments.map((payment, index) => [
                        index + 1,
                        payment.paymentId,
                        payment.amount,
                        formatDate(payment.paymentDate),
                        payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1),
                        payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)
                    ].join(','))
                ].join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().split('T')[0];
                
                link.setAttribute('href', url);
                link.setAttribute('download', `payment_history_${date}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                window.toast('Payment history downloaded successfully', 'success');
            });

            // Add print button event listener for payment history
            document.getElementById('printPaymentHistory').addEventListener('click', () => {
                // Get the filtered payments
                const filteredPayments = allPayments.filter(payment => {
                    const filterDay = document.getElementById('filterDay').value;
                    const filterMethod = document.getElementById('filterMethod').value;
                    const filterType = document.getElementById('filterType').value;

                    // Filter by date range
                    if (filterDay !== 'all') {
                        const now = new Date();
                        const startDate = new Date();
                        
                        switch (filterDay) {
                            case 'today':
                                startDate.setHours(0, 0, 0, 0);
                                break;
                            case '7':
                                startDate.setDate(now.getDate() - 7);
                                break;
                            case '30':
                                startDate.setDate(now.getDate() - 30);
                                break;
                            case '365':
                                startDate.setFullYear(now.getFullYear() - 1);
                                break;
                        }

                        const paymentDate = new Date(payment.paymentDate);
                        if (paymentDate < startDate || paymentDate > now) {
                            return false;
                        }
                    }

                    // Filter by payment method
                    if (filterMethod !== 'all' && payment.paymentMethod !== filterMethod) {
                        return false;
                    }

                    // Filter by payment type
                    if (filterType !== 'all') {
                        switch (filterType) {
                            case 'first_payment':
                                if (payment.paymentType !== 'membership') return false;
                                break;
                            case 'renewal':
                                if (payment.paymentType !== 'renewal') return false;
                                break;
                            case 'additional':
                                if (payment.paymentType !== 'product') return false;
                                break;
                        }
                    }

                    return true;
                });

                if (filteredPayments.length === 0) {
                    window.toast('No payment data to print', 'error');
                    return;
                }

                // Create print window
                const printWindow = window.open('', '_blank');

                // Create print content
                const printContent = `
                    <html>
                    <head>
                        <title>Payment History Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; }
                            h1 { text-align: center; }
                            .header { margin-bottom: 20px; }
                            .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Payment History Report</h1>
                            <p>Generated on: ${new Date().toLocaleString()}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>S.N</th>
                                    <th>Payment ID</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Method</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredPayments.map((payment, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${payment.paymentId}</td>
                                        <td>${formatCurrency(payment.amount)}</td>
                                        <td>${formatDate(payment.paymentDate)}</td>
                                        <td>${payment.paymentType.charAt(0).toUpperCase() + payment.paymentType.slice(1)}</td>
                                        <td>${payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="footer">
                            <p>© ${new Date().getFullYear()} Knox Barbell - Payment History Report</p>
                        </div>
                    </body>
                    </html>
                `;

                // Write content to print window
                printWindow.document.write(printContent);
                printWindow.document.close();

                // Wait for content to load then print
                printWindow.onload = function () {
                    printWindow.print();
                    printWindow.close();
                };

                window.toast('Printing payment history...', 'success');
            });

            // Helper function to show notifications
            function toast(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            fetchMembers(1); // Initial load

            // Edit member form submission
            editMemberForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const memberId = editMemberForm.dataset.memberId;
                if (!memberId) {
                    window.toast('Member ID not found', 'error');
                    return;
                }

                try {
                    // Get form data
                    const formData = {
                        fullName: editMemberForm.querySelector('#fullName').value,
                        email: editMemberForm.querySelector('#email').value,
                        contact: editMemberForm.querySelector('#contact').value,
                        address: editMemberForm.querySelector('#address').value,
                        dateOfBirth: editMemberForm.querySelector('#dateOfBirth').value,
                        gender: editMemberForm.querySelector('input[name="gender"]:checked').value,
                        emergencyContactName: editMemberForm.querySelector('#emergencyContactName').value,
                        emergencyContactRelationship: editMemberForm.querySelector('#emergencyContactRelationship').value,
                        emergencyNumber: editMemberForm.querySelector('#emergencyNumber').value,
                        membershipType: editMemberForm.querySelector('#membershipType').value,
                        startDate: editMemberForm.querySelector('#membershipStartDate').value
                    };

                    // Send update request
                    const response = await fetch(`/api/members/${memberId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (result.success) {
                        window.toast('Member updated successfully', 'success');
                        editMemberModal.classList.remove('active');
                        document.body.style.overflow = '';
                        fetchMembers(); // Refresh the member list
                    } else {
                        throw new Error(result.message || 'Failed to update member');
                    }
                } catch (error) {
                    console.error('Error updating member:', error);
                    window.toast(error.message || 'Failed to update member', 'error');
                }
            });

            // Close edit modal when clicking cancel button
            editCancelBtn.addEventListener('click', function() {
                editMemberModal.classList.remove('active');
                document.body.style.overflow = '';
                resetEditModal();
            });

            // Close edit modal when clicking outside
            editMemberModal.addEventListener('click', function(e) {
                if (e.target === editMemberModal) {
                    editMemberModal.classList.remove('active');
                    document.body.style.overflow = '';
                    resetEditModal();
                }
            });

            // Reset edit modal form
            function resetEditModal() {
                if (editMemberForm) {
                    editMemberForm.reset();
                    delete editMemberForm.dataset.memberId;
                }
            }

            // Populate edit form with member data
            function populateEditForm(member) {
                const form = editMemberForm;
                form.dataset.memberId = member.memberId;

                // Populate basic info
                form.querySelector('#fullName').value = member.fullName || '';
                form.querySelector('#email').value = member.email || '';
                form.querySelector('#contact').value = member.contact || '';
                form.querySelector('#address').value = member.address || '';
                form.querySelector('#dateOfBirth').value = member.dateOfBirth ? new Date(member.dateOfBirth).toISOString().split('T')[0] : '';

                // Set gender
                const genderRadio = form.querySelector(`input[name="gender"][value="${member.gender}"]`);
                if (genderRadio) genderRadio.checked = true;

                // Populate emergency info
                form.querySelector('#emergencyContactName').value = member.emergencyContactName || '';
                form.querySelector('#emergencyContactRelationship').value = member.emergencyContactRelationship || '';
                form.querySelector('#emergencyNumber').value = member.emergencyNumber || '';

                // Populate membership info
                form.querySelector('#membershipType').value = member.membershipType || '';
                form.querySelector('#membershipStartDate').value = member.startDate ? new Date(member.startDate).toISOString().split('T')[0] : '';
            }

            // Edit button click handler
            tableBody.addEventListener('click', async function(e) {
                const editBtn = e.target.closest('.edit');
                if (editBtn) {
                    const memberId = editBtn.dataset.id;
                    if (!memberId) return;

                    try {
                        const response = await fetch(`/api/members/${memberId}`);
                        const result = await response.json();

                        if (result.success) {
                            const member = result.data;
                            populateEditForm(member);
                            editMemberModal.classList.add('active');
                            document.body.style.overflow = 'hidden';
                        } else {
                            window.toast('Failed to fetch member details: ' + result.message, 'error');
                        }
                    } catch (error) {
                        console.error('Error fetching member details:', error);
                        window.toast('Failed to fetch member details. Please try again.', 'error');
                    }
                }
            });

            // Function to fetch and display member alerts
            async function fetchMemberAlerts() {
                try {
                    const response = await fetch("/api/members");
                    const result = await response.json();

                    // Check if the response has the expected structure
                    if (!result.success || !Array.isArray(result.data)) {
                        console.error('Invalid members data format:', result);
                        return;
                    }

                    const members = result.data;

                    // Filter members based on start date and status
                    const filteredMembers = members.filter((member) => {
                        if (!member || !member.startDate) return false;

                        const startDate = new Date(member.startDate);
                        const currentDate = new Date();
                        const memberStatus = member.memberStatus?.toLowerCase();

                        // Include members whose start date is before current date
                        const hasStarted = startDate < currentDate;

                        // Include members with specific statuses
                        const hasRelevantStatus = ['expiring', 'expired', 'cancelled'].includes(memberStatus);

                        return hasStarted || hasRelevantStatus;
                    });

                    // Sort members by priority
                    const statusPriority = {
                        'cancelled': 1,
                        'expired': 2,
                        'expiring': 3,
                        'active': 4,
                        'inactive': 5,
                        'pending': 6
                    };

                    filteredMembers.sort((a, b) => {
                        // First sort by status priority
                        const statusA = a.memberStatus?.toLowerCase() || '';
                        const statusB = b.memberStatus?.toLowerCase() || '';
                        const statusDiff = (statusPriority[statusA] || 999) - (statusPriority[statusB] || 999);
                        
                        if (statusDiff !== 0) return statusDiff;

                        // For expiring members, sort by days until expiry
                        if (statusA === 'expiring' && statusB === 'expiring') {
                            const daysUntilExpiryA = Math.ceil((new Date(a.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                            const daysUntilExpiryB = Math.ceil((new Date(b.endDate) - new Date()) / (1000 * 60 * 60 * 24));
                            return daysUntilExpiryA - daysUntilExpiryB;
                        }

                        // For expired members, sort by days since expiry (most recent first)
                        if (statusA === 'expired' && statusB === 'expired') {
                            const daysSinceExpiryA = Math.ceil((new Date() - new Date(a.endDate)) / (1000 * 60 * 60 * 24));
                            const daysSinceExpiryB = Math.ceil((new Date() - new Date(b.endDate)) / (1000 * 60 * 60 * 24));
                            return daysSinceExpiryA - daysSinceExpiryB;
                        }

                        // For members who have started, sort by start date (most recent first)
                        if (a.startDate && b.startDate) {
                            return new Date(b.startDate) - new Date(a.startDate);
                        }

                        return 0;
                    });

                    // Get top 5 most relevant alerts
                    const topAlerts = filteredMembers.slice(0, 5);

                    // Update the table
                    const tbody = document.querySelector("#memberAlertTableBody");
                    if (!tbody) {
                        console.error('Member alerts table body not found');
                        return;
                    }

                    tbody.innerHTML = "";

                    if (topAlerts.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">No member alerts found</td>
                            </tr>
                        `;
                        return;
                    }

                    topAlerts.forEach((member) => {
                        const row = document.createElement("tr");
                        const status = member.memberStatus?.toLowerCase() || 'pending';
                        const startDate = new Date(member.startDate);
                        const endDate = new Date(member.endDate);
                        const currentDate = new Date();
                        const daysUntilExpiry = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                        const daysSinceExpiry = Math.ceil((currentDate - endDate) / (1000 * 60 * 60 * 24));

                        let statusText = status.charAt(0).toUpperCase() + status.slice(1);
                        let daysDisplay = "";

                        if (status === 'expiring') {
                            daysDisplay = `${daysUntilExpiry} days left`;
                        } else if (status === 'expired') {
                            daysDisplay = `${daysSinceExpiry} days ago`;
                        } else if (status === 'cancelled') {
                            daysDisplay = "N/A";
                        } else {
                            daysDisplay = `${Math.ceil((currentDate - startDate) / (1000 * 60 * 60 * 24))} days active`;
                        }

                        row.innerHTML = `
                            <td>${member.memberId || 'N/A'}</td>
                            <td>${member.fullName || 'N/A'}</td>
                            <td>${member.email || 'N/A'}</td>
                            <td><span class="status ${status}">${statusText}</span></td>
                            <td>${daysDisplay}</td>
                            <td>
                                ${status === 'cancelled' ? 
                                    `<span class="status cancelled">Cancelled</span>` :
                                    `<button class="action-btn cancel" data-member-id="${member.memberId}" title="Cancel Membership">
                                        <i class="fa-solid fa-ban"></i>
                                    </button>`
                                }
                            </td>
                        `;

                        tbody.appendChild(row);
                    });

                    // Update the count badge
                    const countBadge = document.querySelector("#memberAlertsBadge");
                    if (countBadge) {
                        countBadge.textContent = filteredMembers.length;
                        countBadge.style.display = filteredMembers.length > 0 ? "inline" : "none";
                    }
                } catch (error) {
                    console.error("Error fetching member alerts:", error);
                    const tbody = document.querySelector("#memberAlertTableBody");
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center">Error loading member alerts: ${error.message}</td>
                            </tr>
                        `;
                    }
                }
            }

            // Initial fetch of member alerts
            fetchMemberAlerts();

            // Notification Modal Logic
            document.addEventListener('DOMContentLoaded', function() {
                const notificationIcon = document.querySelector('.notification');
                const notificationModal = document.querySelector('.notification-modal');
                const closeNotifications = document.querySelector('.close-notifications');
                const notificationList = document.querySelector('.notification-list');
                const notificationBadge = document.querySelector('.notification-badge');

                // Toggle notification modal
                notificationIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationModal.classList.toggle('active');
                    if (notificationModal.classList.contains('active')) {
                        fetchNotifications();
                    }
                });

                // Close notification modal
                closeNotifications.addEventListener('click', function(e) {
                    e.stopPropagation();
                    notificationModal.classList.remove('active');
                });

                // Close modal when clicking outside
                document.addEventListener('click', function(e) {
                    if (!notificationModal.contains(e.target) && !notificationIcon.contains(e.target)) {
                        notificationModal.classList.remove('active');
                    }
                });

                // Fetch unread count
                async function fetchUnreadCount() {
                    try {
                        const response = await fetch(`${baseUrl}/api/notifications/unread-count`);
                        const data = await response.json();
                        if (data.success) {
                            notificationBadge.textContent = data.data.unreadCount;
                            // Show/hide badge based on count
                            notificationBadge.style.display = data.data.unreadCount > 0 ? 'flex' : 'none';
                        }
                    } catch (error) {
                        console.error('Error fetching unread count:', error);
                    }
                }

                // Fetch notifications from API
                async function fetchNotifications() {
                    try {
                        notificationList.innerHTML = `
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        `;

                        const response = await fetch(`${baseUrl}/api/notifications`);
                        const data = await response.json();

                        if (data.success) {
                            const notifications = data.data;
                            
                            if (notifications.length === 0) {
                                notificationList.innerHTML = `
                                    <div class="notification-empty">
                                        <i class="fas fa-bell-slash"></i>
                                        <p>No new notifications</p>
                                    </div>
                                `;
                                return;
                            }

                            // Render notifications
                            notificationList.innerHTML = notifications.map(notif => `
                                <div class="notification-item ${notif.status === 'unread' ? 'unread' : ''}" 
                                     data-notification-id="${notif._id}">
                                    <div class="notification-title">
                                        ${notif.title}
                                        ${notif.status === 'unread' ? '<span class="unread-dot"></span>' : ''}
                                    </div>
                                    <div class="notification-message">${notif.message}</div>
                                    <div class="notification-time">${new Date(notif.createdAt).toLocaleString()}</div>
                                </div>
                            `).join('');

                            // Add click handler to mark notifications as read
                            const notificationItems = document.querySelectorAll('.notification-item');
                            notificationItems.forEach(item => {
                                item.addEventListener('click', async () => {
                                    const notificationId = item.dataset.notificationId;
                                    if (item.classList.contains('unread')) {
                                        try {
                                            const response = await fetch(`${baseUrl}/api/notifications/${notificationId}/read`, {
                                                method: 'PATCH',
                                                credentials: 'include'
                                            });
                                            
                                            if (response.ok) {
                                                // Update UI
                                                item.classList.remove('unread');
                                                const unreadDot = item.querySelector('.unread-dot');
                                                if (unreadDot) unreadDot.remove();
                                                
                                                // Update unread count
                                                await fetchUnreadCount();
                                            } else {
                                                window.toast('Failed to mark notification as read', 'error');
                                            }
                                        } catch (error) {
                                            console.error('Error marking notification as read:', error);
                                            window.toast('Error marking notification as read', 'error');
                                        }
                                    }

                                    // Close notification modal
                                    notificationModal.classList.remove('active');

                                    // Redirect to application page
                                    window.location.href = '/application';
                                });
                            });
                        } else {
                            throw new Error(data.message || 'Failed to fetch notifications');
                        }
                    } catch (error) {
                        console.error('Error fetching notifications:', error);
                        window.toast('Failed to load notifications', 'error');
                        notificationList.innerHTML = `
                            <div class="notification-empty">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Failed to load notifications</p>
                            </div>
                        `;
                    }
                }

                // Initial fetch of notifications and unread count
                fetchNotifications();
                fetchUnreadCount();

                // Refresh unread count periodically
                setInterval(fetchUnreadCount, 30000); // Every 30 seconds
            });
        });
    </script>
</body>

</html>