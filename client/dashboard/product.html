<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knox Barbell - Product</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/css/base.css">
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h3>Knox Barbell</h3>
      <button class="toggle-btn" id="toggleSidebar">
        <i class="fas fa-bars"></i>
      </button>
    </div>
    <ul class="sidebar-menu">
      <li>
        <a href="/dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
          <div class="tooltip">Dashboard</div>
        </a>
      </li>
      <li>
        <a href="/members">
          <i class="fas fa-user"></i>
          <span>Member</span>
          <div class="tooltip">Member</div>
        </a>
      </li>
      <li>
        <a href="/membership">
          <i class="fas fa-id-card"></i>
          <span>Membership</span>
          <div class="tooltip">Membership</div>
        </a>
      </li>
      <li>
        <a href="/trainers">
          <i class="fas fa-chalkboard-teacher"></i>
          <span>Trainers</span>
          <div class="tooltip">Trainers</div>
        </a>
      </li>
      <li>
        <a href="/employee">
          <i class="fas fa-users"></i>
          <span>Employee</span>
          <div class="tooltip">Employee</div>
        </a>
      </li>
      <li>
        <a href="/notifications">
          <i class="fas fa-bell"></i>
          <span>Notifications</span>
          <div class="tooltip">Notifications</div>
        </a>
      </li>
      <li>
        <a href="/attendance">
          <i class="fas fa-calendar-check"></i>
          <span>Attendance</span>
          <div class="tooltip">Attendance</div>
        </a>
      </li>
      <li>
        <a href="/events">
          <i class="fas fa-calendar-alt"></i>
          <span>Events</span>
          <div class="tooltip">Events</div>
        </a>
      </li>
      <li>
        <a href="/finance">
          <i class="fas fa-wallet"></i>
          <span>Finance</span>
          <div class="tooltip">Finance</div>
        </a>
      </li>
      <li>
        <a href="/product" class="active">
          <i class="fas fa-box"></i>
          <span>Product</span>
          <div class="tooltip">Product</div>
        </a>
      </li>
      <li class="logout-item">
        <a href="#" id="logoutButton">
            <i class="fas fa-sign-out-alt"></i>
            <span>Logout</span>
            <div class="tooltip">Logout</div>
        </a>
    </li>
    </ul>
  </div>

     <!-- Main Content -->
     <div class="main-content">
      <!-- Topbar -->
      <div class="topbar">
          <div class="topbar-left">
              <button class="mobile-toggle" id="mobileToggle">
                  <i class="fas fa-bars"></i>
              </button>
              <h3>Products</h3>
          </div>
          <div class="topbar-right">
              <!-- notification  -->
              <div class="notification">
                  <i class="fas fa-bell"></i>
                  <span class="notification-badge">0</span>
                  
                  <!-- Notification Modal -->
                  <div class="notification-modal">
                      <div class="notification-header">
                          <h3>Notifications</h3>
                          <div class="notification-actions">
                              <a href="/notifications" class="view-all-link">View All</a>
                              <button class="close-notifications">
                                  <i class="fas fa-times"></i>
                              </button>
                          </div>
                      </div>
                      <div class="notification-list">
                          <!-- Notifications will be populated here -->
                          <div class="notification-loading">
                              <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                          </div>
                      </div>
                  </div>
              </div>
              <div class="user-greeting">
                  <img src="/img/Knox Logo-01.png" alt="User">
                  <span>Hello, Knox Barbell</span>
              </div>
          </div>
      </div>

      <!-- Content -->
      <div class="content">
          <!-- Content Header -->
          <div class="content-header">
              <h1>Product Management</h1>
              <div class="header-actions">
                  <select id="categoryFilter">
                      <option value="">All Categories</option>
                      <option value="supplements">Supplements</option>
                      <option value="equipment">Equipment</option>
                      <option value="clothing">Clothing</option>
                      <option value="accessories">Accessories</option>
                  </select>
                  <button id="resetProductFilters" title="Reset Filters">
                      <i class="fa-solid fa-rotate"></i>
                  </button>
                  <button id="downloadProducts" title="Download CSV">
                      <i class="fa-solid fa-download"></i>
                  </button>
                  <button id="printProducts" title="Print">
                      <i class="fa-solid fa-print"></i>
                  </button>
                  <button id="addProductBtn">
                      <span>+</span>
                      <p>Add Product</p>
                  </button>
              </div>
          </div>

          <!-- Filters Section -->
          <div class="filters">
              <!-- search filter -->
              <div class="filter-group search-box">
                  <i class="fas fa-search"></i>
                  <input type="text" id="productSearch" placeholder="Search products..." autocomplete="off">
              </div>
              <!-- stock filter -->
              <div class="filter-group">
                  <label for="stockStatus">Stock Status:</label>
                  <select id="stockStatus">
                      <option value="">All</option>
                      <option value="in-stock">In Stock</option>
                      <option value="low-stock">Low Stock</option>
                      <option value="out-of-stock">Out of Stock</option>
                  </select>
              </div>
              <!-- price range filter -->
              <div class="filter-group">
                  <label for="priceRange">Price Range:</label>
                  <select id="priceRange">
                      <option value="">All</option>
                      <option value="0-50">$0 - $50</option>
                      <option value="51-100">$51 - $100</option>
                      <option value="101-200">$101 - $200</option>
                      <option value="201+">$201+</option>
                  </select>
              </div>
          </div>

          <!-- Products Table -->
          <div class="table-container">
              <table class="members-table">
                  <thead>
                      <tr>
                          <th>S.N</th>
                          <th>Product ID</th>
                          <th>Name</th>
                          <th>Category</th>
                          <th>Price</th>
                          <th>Stock</th>
                          <th>Status</th>
                          <th>Action</th>
                      </tr>
                  </thead>
                  <tbody>
                      <tr>
                          <td>1</td>
                          <td>loading...</td>
                          <td>loading...</td>
                          <td>loading...</td>
                          <td>loading...</td>
                          <td>loading...</td>
                          <td><span class="status">loading...</span></td>
                          <td>
                              <button class="action-btn edit"><i class="fa-solid fa-pen"></i></button>
                              <button class="action-btn delete"><i class="fa-solid fa-trash"></i></button>
                          </td>
                      </tr>
                  </tbody>
              </table>
          </div>

          <!-- Pagination Controls -->
          <div class="pagination-controls">
              <button id="prevPage" class="pagination-btn" disabled>
                  <i class="fas fa-chevron-left"></i> Previous
              </button>
              <span id="pageInfo">Page 1</span>
              <button id="nextPage" class="pagination-btn" disabled>
                  Next <i class="fas fa-chevron-right"></i>
              </button>
          </div>
      </div>

  </div>

  <!-- Add Product Modal -->
  <div class="modal-overlay" id="addProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Product</h2>
        <p>Fill in the details to add a new product.</p>
      </div>
      <form id="productForm">
        <div class="form-grid">
          <div class="form-group full-width">
            <label for="productName">Product Name</label>
            <input type="text" id="productName" required>
          </div>
          <div class="form-group">
            <label for="productCategory">Category</label>
            <select id="productCategory" required>
              <option value="">Select Category</option>
              <option value="supplements">Supplements</option>
              <option value="equipment">Equipment</option>
              <option value="clothing">Clothing</option>
              <option value="accessories">Accessories</option>
            </select>
          </div>
          <div class="form-group">
            <label for="productPrice">Price</label>
            <input type="number" id="productPrice" min="0" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="productStock">Stock Quantity</label>
            <input type="number" id="productStock" min="0" required>
          </div>
          <div class="form-group">
            <label for="productDescription">Description</label>
            <textarea id="productDescription" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label>Status</label>
            <div class="radio-group">
              <div class="radio-option">
                <input type="radio" id="statusActive" name="status" value="active" checked>
                <label for="statusActive">Active</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="statusInactive" name="status" value="inactive">
                <label for="statusInactive">Inactive</label>
              </div>
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Product</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // DOM Elements
    const addProductBtn = document.getElementById('addProductBtn');
    const addProductModal = document.getElementById('addProductModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const productForm = document.getElementById('productForm');
    const productTableBody = document.querySelector('.members-table tbody');
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");

    // Pagination state
    let currentPage = 1;
    let totalPages = 1;
    const itemsPerPage = 10;
    let allProducts = []; // Store all products

    // Utility Functions
    const toast = (message, type = 'success') => {
      window.toast(message, type);
    };

    const validateForm = (formData) => {
      const errors = [];

      if (!formData.name || formData.name.trim().length < 2) {
        errors.push('Please enter a valid product name');
      }

      if (!formData.category) {
        errors.push('Please select a category');
      }

      if (!formData.price || formData.price <= 0) {
        errors.push('Please enter a valid price');
      }

      if (!formData.stock || formData.stock < 0) {
        errors.push('Please enter a valid stock quantity');
      }

      if (!formData.description || formData.description.trim().length < 10) {
        errors.push('Please enter a description (minimum 10 characters)');
      }

      return errors;
    };

    const resetModal = () => {
      productForm.reset();
      document.querySelector('#addProductModal .modal-header h2').textContent = 'Add New Product';
      document.querySelector('#productForm button[type="submit"]').textContent = 'Add Product';
      productForm.dataset.mode = 'add';
      delete productForm.dataset.productId;
    };

    // Fetch and Display Products
    async function fetchProducts(page = 1) {
      try {
        const categoryFilter = document.getElementById('categoryFilter').value;
        const stockStatus = document.getElementById('stockStatus').value;
        const priceRange = document.getElementById('priceRange').value;
        const searchQuery = document.getElementById('productSearch').value;

        let query = [];
        if (categoryFilter) query.push(`category=${categoryFilter}`);
        if (stockStatus) query.push(`stockStatus=${stockStatus}`);
        if (priceRange) query.push(`priceRange=${priceRange}`);
        if (searchQuery) query.push(`search=${searchQuery}`);
        const queryString = query.length ? "?" + query.join("&") : "";

        const response = await fetch(`/api/products${queryString}`);
        const result = await response.json();
        
        if (result.success) {
          allProducts = result.data;
          const startIndex = (page - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const paginatedProducts = allProducts.slice(startIndex, endIndex);
          totalPages = Math.ceil(allProducts.length / itemsPerPage);

          displayProducts(paginatedProducts);
          updatePagination({
            currentPage: page,
            totalPages: totalPages,
            total: allProducts.length
          });
        } else {
          throw new Error(result.message || 'Failed to fetch products');
        }
      } catch (error) {
        console.error('Error fetching products:', error);
        productTableBody.innerHTML = `<tr><td colspan="8" class="text-center">Error loading products. Please try again.</td></tr>`;
        updatePagination({ currentPage: 1, totalPages: 1, total: 0 });
      }
    }

    function updatePagination(paginationData) {
      currentPage = parseInt(paginationData.currentPage) || 1;
      totalPages = parseInt(paginationData.totalPages) || 1;
      pageInfo.textContent = `Page ${currentPage} of ${totalPages} (Total: ${paginationData.total} products)`;
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      prevPageBtn.classList.toggle('disabled', currentPage <= 1);
      nextPageBtn.classList.toggle('disabled', currentPage >= totalPages);
    }

    function displayProducts(products) {
      productTableBody.innerHTML = '';

      if (!products || !Array.isArray(products) || products.length === 0) {
        productTableBody.innerHTML = `<tr><td colspan="8" class="text-center">No products found.</td></tr>`;
        return;
      }

      products.forEach((product, index) => {
        const tr = document.createElement("tr");
        const rowNumber = ((currentPage - 1) * itemsPerPage) + index + 1;

        tr.innerHTML = `
          <td>${rowNumber}</td>
          <td>${product.productId || 'N/A'}</td>
          <td>${product.name || 'N/A'}</td>
          <td>${product.category ? product.category.charAt(0).toUpperCase() + product.category.slice(1) : 'N/A'}</td>
          <td>$${product.price ? product.price.toFixed(2) : 'N/A'}</td>
          <td>${product.stock || 'N/A'}</td>
          <td>
            <span class="status ${product.stock > 0 ? 'active' : 'inactive'}">
              <i class="fa-solid fa-${product.stock > 0 ? 'circle-check' : 'xmark'}"></i>
              ${product.stock > 0 ? 'In Stock' : 'Out of Stock'}
            </span>
          </td>
          <td>
            <button class="action-btn edit" data-product-id="${product.productId || ''}" ${!product.productId ? 'disabled' : ''}>
              <i class="fa-solid fa-pen"></i>
            </button>
            <button class="action-btn delete" data-product-id="${product.productId || ''}" ${!product.productId ? 'disabled' : ''}>
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        `;
        productTableBody.appendChild(tr);
      });

      attachActionListeners();
    }

    // Event Listeners
    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        fetchProducts(currentPage - 1);
      }
    });

    nextPageBtn.addEventListener("click", () => {
      if (currentPage < totalPages) {
        fetchProducts(currentPage + 1);
      }
    });

    document.getElementById('categoryFilter').addEventListener('change', () => {
      currentPage = 1;
      fetchProducts(currentPage);
    });

    document.getElementById('stockStatus').addEventListener('change', () => {
      currentPage = 1;
      fetchProducts(currentPage);
    });

    document.getElementById('priceRange').addEventListener('change', () => {
      currentPage = 1;
      fetchProducts(currentPage);
    });

    document.getElementById('productSearch').addEventListener('input', debounce(() => {
      currentPage = 1;
      fetchProducts(currentPage);
    }, 500));

    document.getElementById('resetProductFilters').addEventListener('click', () => {
      currentPage = 1;
      document.getElementById('categoryFilter').value = '';
      document.getElementById('stockStatus').value = '';
      document.getElementById('priceRange').value = '';
      document.getElementById('productSearch').value = '';
      fetchProducts(1);
      toast('Filters have been reset', 'info');
    });

    // Form Submission
    productForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value),
        stock: parseInt(document.getElementById('productStock').value),
        description: document.getElementById('productDescription').value,
        status: document.querySelector('input[name="status"]:checked').value
      };

      const validationErrors = validateForm(formData);
      if (validationErrors.length > 0) {
        toast(validationErrors.join(', '), 'error');
        return;
      }

      try {
        const mode = productForm.dataset.mode || 'add';
        const url = mode === 'add' 
          ? '/api/products' 
          : `/api/products/${productForm.dataset.productId}`;
        
        const method = mode === 'add' ? 'POST' : 'PUT';

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (response.ok) {
          addProductModal.classList.remove('active');
          document.body.style.overflow = '';
          
          resetModal();
          fetchProducts();

          toast(`Product ${mode === 'add' ? 'added' : 'updated'} successfully!`);
        } else {
          throw new Error(result.message || `Failed to ${mode} product`);
        }
      } catch (error) {
        console.error('Error:', error);
        toast(error.message, 'error');
      }
    });

    // Modal Handling
    addProductBtn.addEventListener('click', function() {
      resetModal();
      addProductModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    });

    cancelBtn.addEventListener('click', function() {
      addProductModal.classList.remove('active');
      document.body.style.overflow = '';
    });

    addProductModal.addEventListener('click', function(e) {
      if (e.target === addProductModal) {
        addProductModal.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    // Utility function for debouncing search
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Initial fetch
    fetchProducts(1);
  </script>

  <script src="/js/main.js"></script>
  <script src="./js/logout.js"></script>
</body>

</html>